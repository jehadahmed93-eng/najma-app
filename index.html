<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ูุฎูู ุงููุฌูุฉ ูุฅููุงุก ุงููุงุฒุญูู</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0b5ed7">
<link rel="manifest" href="manifest.json">
<style>
body{font-family:Tahoma, Arial;background:#f4f6f8;margin:0;}
header{background:#0b5ed7;color:white;padding:15px;text-align:center;font-size:20px;font-weight:bold;position:relative;}
#menuToggle{position:absolute;top:15px;left:15px;font-size:25px;cursor:pointer;color:white;}
#sideMenu{position:fixed;top:0;right:-100%;width:250px;height:100%;background:#fff;box-shadow:-2px 0 6px rgba(0,0,0,0.2);padding:20px;transition:right 0.3s;z-index:1000;overflow-y:auto;}
#sideMenu h3{margin-top:0;}
#sideMenu ul{list-style:none;padding:0;}
#sideMenu ul li{padding:10px 5px;cursor:pointer;border-bottom:1px solid #ccc;}
.container{padding:15px;}
label{display:block;margin-top:8px;font-weight:bold;}
input,select,textarea{width:100%;padding:10px;margin-top:4px;font-size:16px;border:1px solid #ccc;border-radius:6px;}
textarea{resize:vertical;}
.section{background:white;padding:15px;margin-bottom:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.08);}
.child{border:1px dashed #ccc;padding:10px;margin-top:10px;border-radius:6px;}
button:not(.statsBtn):not(.action-btn){
  width:100%;
  background:#198754;
  color:white;
  padding:12px;
  font-size:18px;
  border:none;
  border-radius:8px;
  margin-top:15px;
  cursor:pointer;
}
/* โ ุฒุฑ "ูุดุงูุฏุฉ" ุฏุงุฎู ุงูุฅุญุตุงุฆูุงุช ููุท */
button.statsBtn{
  width:auto !important;
  background:#198754 !important;  /* ุฃุฎุถุฑ ูุซู ุฃูุณ */
  color:#fff !important;
  padding:6px 12px !important;
  font-size:13px !important;
  font-weight:800 !important;
  border:none !important;
  border-radius:8px !important;
  margin:0 !important;            /* ููู: ูููุน ูุฒููู ูุชุญุช */
  cursor:pointer !important;
  display:inline-flex !important;
  align-items:center !important;
  justify-content:center !important;
  white-space:nowrap !important;
}
.hidden{display:none;}
.age{font-size:14px;color:#555;margin-top:5px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
table th, table td{border:1px solid #ccc;padding:8px;text-align:center;}
table th{background:#e9ecef;}
.action-btn{padding:5px 10px;margin:2px;background:#0b5ed7;color:white;border:none;border-radius:4px;cursor:pointer;}
.family-card{border:1px solid #ccc;border-radius:8px;padding:10px;margin:10px 0;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.08);}
.family-card label{font-weight:bold;margin-top:4px;display:block;}
</style>
</head>
<body>

<header>
ูุฎูู ุงููุฌูุฉ ูุฅููุงุก ุงููุงุฒุญูู
<span id="menuToggle">&#9776;</span>
</header>

<div id="sideMenu">
  <h3>ุงููุงุฆูุฉ</h3>
  <ul>
<li onclick="showAddFamily()">ุฅุถุงูุฉ ุฃุณุฑุฉ</li>
<li onclick="showFamilies()">ุนุฑุถ ุงูุฃุณุฑ</li>
<li onclick="showFilter()">ููุชุฑุฉ ุงูุจูุงูุงุช</li>
<li onclick="showReports()">ุงูุชูุงุฑูุฑ</li>
<li onclick="showStats()">ุฅุญุตุงุฆูุงุช ุงููุฎูู</li>
<li onclick="showDeparted()">ุงูุฃุณุฑ ุงููุบุงุฏุฑุฉ</li>
<li onclick="showSMS()">ุฅุฑุณุงู ุฑุณุงุฆู SMS</li>
<li onclick="importExcel()">ุงุณุชูุฑุงุฏ ููู Excel</li>
<li onclick="exportBackupJSON()">ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</li>
<li onclick="importBackupJSON()">ุงุณุชูุฑุงุฏ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</li>

<li onclick="showAbout()">ุญูู ุงูุชุทุจูู</li>
<li onclick="showContact()">ุชูุงุตู ูุนูุง</li>
  </ul>
</div>

<!-- ===== ุดุงุดุฉ ููุฏ ุงูุชุทููุฑ ===== -->
<div id="maintenanceScreen" style="
  position:fixed;
  inset:0;
  background:#f5f7fa;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
">

  <div style="
    max-width:420px;
    background:#fff;
    border-radius:16px;
    padding:30px 24px;
    text-align:center;
    box-shadow:0 10px 30px rgba(0,0,0,0.15);
  ">

    <!-- ๐ ุงุถุบุท 3 ููุฑุงุช ุณุฑูุนุฉ ููุง -->
    <h2 id="secretTitle" style="
      color:#0b5ed7;
      font-size:26px;
      margin-bottom:16px;
      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
      cursor:pointer;
    ">
      ุงูุชุทุจูู ููุฏ ุงูุชุทููุฑ
    </h2>

    <p style="color:#444;line-height:1.8;font-size:15px;">
      ูููู ุญุงูููุง ุจุฅุฌุฑุงุก ุชุญุณููุงุช ูุชุญุฏูุซุงุช ูุฎุฏูุชูู ุจุดูู ุฃูุถู.
      <br><br>
      ูุนุชุฐุฑ ุนู ุงูุฅุฒุนุงุฌุ ููุดูุฑ ููู ุชููููู ูุฏุนููู ๐ค
    </p>

  </div>
</div>

<style>
  /* ุฅุฎูุงุก ุงูุชุทุจูู ุงูุฃุณุงุณู ุงูุชุฑุงุถููุง */
  #mainContainer { display:none; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const SECRET_PASSWORD = "jehad2026";
  const STORAGE_KEY = "adminUnlocked";

  const maintenance = document.getElementById("maintenanceScreen");
  const mainApp = document.getElementById("mainContainer");
  const title = document.getElementById("secretTitle");

  if (!maintenance || !mainApp || !title) return;

  // โ ูู ุงูุฅุฏุงุฑุฉ ุฏุฎูุช ูุจู: ุงูุชุญ ูุจุงุดุฑุฉ
  if (localStorage.getItem(STORAGE_KEY) === "1") {
    maintenance.style.display = "none";
    mainApp.style.display = "block";
    return;
  }

  // โ 3 ููุฑุงุช ุฎูุงู 1.2 ุซุงููุฉ
  let taps = 0;
  let timer = null;

  function onTap(e) {
    e.preventDefault();

    taps++;

    if (timer) clearTimeout(timer);
    timer = setTimeout(() => {
      taps = 0;
      timer = null;
    }, 1200);

    if (taps >= 5) {
      taps = 0;
      clearTimeout(timer);
      timer = null;

      const pass = prompt("ุฃุฏุฎู ูููุฉ ูุฑูุฑ ุงูุฅุฏุงุฑุฉ:");
      if (pass === SECRET_PASSWORD) {
        localStorage.setItem(STORAGE_KEY, "1");
        maintenance.style.display = "none";
        mainApp.style.display = "block";
      } else if (pass !== null) {
        alert("ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ");
      }
    }
  }

  // ๐ฑ ููุจุงูู + ๐ป ููุจููุชุฑ
  title.addEventListener("touchstart", onTap, { passive:false });
  title.addEventListener("click", onTap);

});
</script>

<div class="container" id="mainContainer">


<!-- ====== ุชูุงุตู ูุนูุง ====== -->
<div id="contactSection" class="hidden section">

  <h2 style="text-align:center;color:#0b5ed7;margin-bottom:10px;">
    ุชูุงุตู ูุนูุง
  </h2>

  <p style="font-size:15px;line-height:1.9;color:#333;margin-bottom:14px;">
    ูุฃู ุงุณุชูุณุงุฑุงุช ุฃู ุทูุจุงุช ูุณุงุนุฏุฉุ ูููููู ุงูุชูุงุตู ูุน ุฅุฏุงุฑุฉ ูุฎูู ุงููุฌูุฉ ูุจุงุดุฑุฉ:
  </p>

  <div style="background:#f8f9fa;border-radius:10px;padding:14px;margin-bottom:14px;">
    <h3 style="color:#198754;margin-top:0;">ุฅุฏุงุฑุฉ ูุฎูู ุงููุฌูุฉ</h3>

    <ul style="list-style:none;padding:0;margin:0;line-height:2;">
      <li style="padding:6px 0;border-bottom:1px solid #e5e7eb;">
        ๐ <strong>ุฌูุงุฏ ุงูููุฑ:</strong>
        <a href="tel:0567898990" style="color:#0b5ed7;text-decoration:none;">0567898990</a>
      </li>
      <li style="padding:6px 0;border-bottom:1px solid #e5e7eb;">
        ๐ <strong>ุนุฏูุงู ุฃุจู ุนุฒูู:</strong>
        <a href="tel:0567389780" style="color:#0b5ed7;text-decoration:none;">0567389780</a>
      </li>
      <li style="padding:6px 0;border-bottom:1px solid #e5e7eb;">
        ๐ <strong>ูุงูู ููุตูุฑ:</strong>
        <a href="tel:0592575988" style="color:#0b5ed7;text-decoration:none;">0592575988</a>
      </li>
      <li style="padding:6px 0;border-bottom:1px solid #e5e7eb;">
        ๐ <strong>ูุญูุฏ ุฃุจู ุตููุจุงู:</strong>
        <a href="tel:0599809467" style="color:#0b5ed7;text-decoration:none;">0599809467</a>
      </li>
      <li style="padding:6px 0;">
        ๐ <strong>ุฒููุฑ ุนุงุดูุฑ:</strong>
        <a href="tel:0592395388" style="color:#0b5ed7;text-decoration:none;">0592395388</a>
      </li>
    </ul>
  </div>

  <div style="background:#fff;border-radius:10px;padding:14px;border:1px solid #ddd;">
    <h3 style="color:#0b5ed7;margin-top:0;">ูุฌูุฉ ุงููุฑุฃุฉ ุฏุงุฎู ุงููุฎูู</h3>

    <p style="font-size:14px;line-height:1.9;color:#444;margin-top:0;">
      ูููููู ุงูุชูุงุตู ูุน ูุฌูุฉ ุงููุฑุฃุฉ ููุชุงุจุนุฉ ุงููุถุงูุง ุงููุณุงุฆูุฉ ูุงูุฃูุดุทุฉ ุงููุฌุชูุนูุฉ:
    </p>

    <ul style="list-style:none;padding:0;margin:0;line-height:2;">
      <li style="padding:6px 0;border-bottom:1px solid #e5e7eb;">๐ฉโ๐ผ <strong>ููุงุฑ ุฃุจู ุตููุจุงู</strong></li>
      <li style="padding:6px 0;">๐ฉโ๐ผ <strong>ุฑูู ุฃุจู ุดูุงุฑ</strong></li>
    </ul>
  </div>

</div>


<!-- ====== ุญูู ุงูุชุทุจูู ====== -->
<div id="aboutSection" class="hidden section">

  <h2 style="text-align:center;color:#0b5ed7;margin-bottom:10px;">
    ุญูู ุชุทุจูู ูุฎูู ุงููุฌูุฉ
  </h2>

  <p style="font-size:16px;line-height:1.9;color:#333;margin-bottom:15px;">
    <strong>ุชุทุจูู ูุฎูู ุงููุฌูุฉ ูุฅููุงุก ุงููุงุฒุญูู</strong> ูู ุฃุฏุงุฉ ุนูููุฉ ุชู ุชุทููุฑูุง
    ุฎุตูุตูุง ูุชุณููู ุฅุฏุงุฑุฉ ุดุคูู ุงูุฃุณุฑ ุฏุงุฎู ุงููุฎููุ ูุถูุงู ุชูุฏูู ุฃูุถู ุงูุฎุฏูุงุช
    ูุงููุณุงุนุฏุงุช ุงูุฅูุณุงููุฉ ูู ุธู ุงูุธุฑูู ุงูุฑุงููุฉ.
  </p>

  <div style="background:#f8f9fa;border-radius:10px;padding:15px;margin-bottom:15px;">
    <h3 style="color:#198754;margin-top:0;">ูููุฑ ุงูุชุทุจูู ุงูุฅููุงููุงุช ุงูุชุงููุฉ:</h3>

    <ul style="line-height:2;font-size:15px;">
      <li>โ ุชุณุฌูู ุงูุฃุณุฑ ููุชุงุจุนุฉ ุจูุงูุงุชูู ุจุฏูุฉ.</li>
      <li>โ ุนุฑุถ ุงูุฃุณุฑ ูุฅุฏุงุฑุฉ ูุนูููุงุชูู ุจุณูููุฉ.</li>
      <li>โ ููุชุฑุฉ ูุจุญุซ ูุชูุฏู ูููุตูู ุงูุณุฑูุน ูุฃู ุจูุงูุงุช.</li>
      <li>โ ุฅุฏุงุฑุฉ ุงูุฃุณุฑ ุงููุบุงุฏุฑุฉ ูุงุณุชุนุงุฏุชูุง ุนูุฏ ุงูุญุงุฌุฉ.</li>
      <li>โ ุชุตุฏูุฑ ูุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุนุจุฑ Excel.</li>
    </ul>
  </div>

  <p style="font-size:15px;line-height:1.9;color:#444;">
    ุชู ุชุตููู ุงูุชุทุจูู ุฎุตูุตูุง ูุฎุฏูุฉ ุฃูุงูู ุงููุฎูู ูุชุณููู ุงูููุงู ุงูููููุฉ ููุนุงููููุ
    ูุน ุงูุชุฑููุฒ ุนูู ุงูุฏูุฉ ูุงููุฑููุฉ ูู ุงูุชุนุงูู ูุน ุงูุจูุงูุงุช.
  </p>

  <div style="
    margin-top:20px;
    padding:12px;
    background:#e9f2ff;
    border-right:5px solid #0b5ed7;
    border-radius:8px;
    font-size:14px;
    color:#0b5ed7;
  ">
    ๐ค ูุฐุง ุงูุชุทุจูู ุตูููู ูุฎุฏูุฉ ุฃูู ุงููุฎูู ูุชูุธูู ุงูุนูู ุงูุฅูุณุงูู.
  </div>

</div>

<!-- ====== ุฅุฑุณุงู ุฑุณุงุฆู SMS ====== -->
<div id="smsSection" class="hidden section">
  <h2 style="text-align:center;color:#0b5ed7;margin-bottom:10px;">
    ุฅุฑุณุงู ุฑุณุงุฆู SMS
  </h2>

  <div class="section" style="max-width:700px;">
    <label style="margin-bottom:8px;">ุงุฎุชุฑ ุทุฑููุฉ ูุชุงุจุฉ ุงูุนููุงู ุฏุงุฎู ุงูุฑุณุงูุฉ:</label>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;">
      <label style="display:flex;gap:8px;align-items:center;">
        <input type="radio" name="smsMode" value="name" checked>
        ุฅุฑุณุงู ุจุงูุงุณู: ุงูุณูุฏ / {name}
      </label>

      <label style="display:flex;gap:8px;align-items:center;">
        <input type="radio" name="smsMode" value="id">
        ุฅุฑุณุงู ุจุงููููุฉ: ุตุงุญุจ ุงููููุฉ {id}
      </label>

      <label style="display:flex;gap:8px;align-items:center;">
        <input type="radio" name="smsMode" value="both">
        ุงูุงุณู + ุงููููุฉ: ุงูุณูุฏ / {name} ุ ูููุฉ ุฑูู {id}
      </label>
      
      <label style="display:flex;gap:8px;align-items:center;">
  <input type="radio" name="smsMode" value="general">
  ุฑุณุงูุฉ ุนุงูุฉ (ุจุฏูู ุงุณู ุฃู ูููุฉ)
</label>
    </div>

    <label>ูุต ุงูุฑุณุงูุฉ (ุฃูุช ุชูุชุจู ูู ูุฑุฉ):</label>
    <textarea
      id="smsBody"
      rows="4"
      placeholder="ูุซุงู: ุชูุฌู ูุงุณุชูุงู ุงูุทุฑุฏ ุงูุบุฐุงุฆู ูู ุฅุฏุงุฑุฉ ุงููุฎูู."
      style="width:100%;"
    ></textarea>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
      <button type="button" onclick="buildSMSList()" style="background:#0b5ed7;">
        ุชุฌููุฒ ุงูุฑุณุงุฆู ูููุญุฏุฏ
      </button>

      <button type="button" onclick="clearSMSList()" style="background:#6c757d;">
        ูุณุญ
      </button>
    </div>

    <div id="smsSummary" style="margin-top:10px;font-weight:bold;"></div>
    <div id="smsList" style="margin-top:12px;"></div>
  </div>

  <p style="font-size:13px;color:#666;line-height:1.7;">
    ููุงุญุธุฉ: ุณูุชู ุชุฌููุฒ ูุงุฆูุฉ ุฏุงุฎู ุงูุตูุญุฉุ ุซู ุชุถุบุท "ูุชุญ ุฑุณุงูุฉ SMS" ููู ุฃุณุฑุฉ ููููุชุญ ุชุทุจูู ุงูุฑุณุงุฆู.
  </p>
</div>

<!-- ููุชุฑุฉ ุงูุจูุงูุงุช ุฏุงุฎู ุนุฑุถ ุงูุฃุณุฑ -->
<div id="filterBox" class="hidden section">

  <h3>ููุชุฑุฉ ุงูุจูุงูุงุช</h3>

  <label>ุจุญุซ ุนุงู</label>
  <input type="text" id="filterGeneral" placeholder="ุงุจุญุซ ุจุฃู ูููุฉ">

<label>ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ (ุงุฎุชุฑ ุฃูุซุฑ ูู ุฎูุงุฑ)</label>

<div id="filterSocialBox"
     style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;
            border:1px solid #e5e7eb;padding:12px;border-radius:12px;background:#fff;">

  <label style="display:flex;gap:8px;align-items:center;">
    <input type="checkbox" class="filterSocialChk" value="ูุชุฒูุฌ">
    ูุชุฒูุฌ / ูุฉ
  </label>

  <label style="display:flex;gap:8px;align-items:center;">
    <input type="checkbox" class="filterSocialChk" value="ุงุนุฒุจ">
    ุฃุนุฒุจ / ุขูุณุฉ
  </label>

  <label style="display:flex;gap:8px;align-items:center;">
    <input type="checkbox" class="filterSocialChk" value="ุงุฑูู">
    ุฃุฑูู / ูุฉ
  </label>

  <label style="display:flex;gap:8px;align-items:center;">
    <input type="checkbox" class="filterSocialChk" value="ููุฌูุฑุฉ">
    ููุฌูุฑุฉ
  </label>

  <label style="display:flex;gap:8px;align-items:center;">
    <input type="checkbox" class="filterSocialChk" value="ูุทูู">
    ูุทูู / ูุฉ
  </label>

  <label style="display:flex;gap:8px;align-items:center;">
    <input type="checkbox" class="filterSocialChk" value="ุฎูุงู">
    ุฎูุงู ุฃุณุฑู
  </label>

  <label style="display:flex;gap:8px;align-items:center;">
    <input type="checkbox" class="filterSocialChk" value="ูุนูู">
    ูุนูู / ูุฉ ุฃุณุฑุฉ
  </label>

</div>

  <label>ุงูุฌูุณ</label>
  <select id="filterGender">
    <option value="">ุงููู</option>
    <option value="ุฐูุฑ">ุฐูุฑ</option>
    <option value="ุงูุซู">ุฃูุซู</option>
    <option value="ุฃูุซู">ุฃูุซู</option>
  </select>

  <label>ุงุณู ุฑุจ ุงูุฃุณุฑุฉ</label>
  <input type="text" id="filterName" placeholder="ุจุญุซ ุจุงูุงุณู">

  <button onclick="applyFilter()">ุชุทุจูู ุงูููุชุฑุฉ</button>
  <button onclick="clearFilter()">ูุณุญ ุงูููุชุฑุฉ</button>

</div>

<!-- ุฅุถุงูุฉ ุงูุฃุณุฑุฉ -->
<div id="addFamilySection">
  <div class="section">
    <label>ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ</label>
    <select id="socialStatus">
<option value="">ุงุฎุชุฑ</option>
<option value="ูุชุฒูุฌ">ูุชุฒูุฌ / ูุฉ</option>
<option value="ุงุนุฒุจ">ุฃุนุฒุจ / ุขูุณุฉ</option>
<option value="ุงุฑูู">ุฃุฑูู / ูุฉ</option>
<option value="ููุฌูุฑุฉ">ููุฌูุฑุฉ</option>
<option value="ูุทูู">ูุทูู / ูุฉ</option>
<option value="ุฎูุงู">ุฎูุงู ุฃุณุฑู</option>
<option value="ูุนูู">ูุนูู / ูุฉ ุฃุณุฑุฉ</option>
    </select>
  </div>

  <div class="section">
    <label>ุงุณู ุฑุจ ุงูุฃุณุฑุฉ (ุฑุจุงุนู)</label>
    <input>
    <label>ุฑูู ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ</label>
    <input type="number">
    <label>ุงูุนูุฑ</label>
    <input type="number" min="0">
    <label>ุงูุฌูุณ</label>
    <select id="gender">
      <option value="">ุงุฎุชุฑ</option>
      <option value="ุฐูุฑ">ุฐูุฑ</option>
      <option value="ุงูุซู">ุฃูุซู</option>
    </select>
    <div id="femaleReason" class="hidden">
      <label>ุณุจุจ ุงูุชุณุฌูู ุจุงุณู ุงููุฑุฃุฉ</label>
      <input>
    </div>
  </div>

<div class="section" id="wifeBox">
  <h3>ุจูุงูุงุช ุงูุฒูุฌุฉ</h3>

  <label>ุงุณู ุงูุฒูุฌุฉ</label>
  <input id="wifeNameInput" type="text">

  <label>ุฑูู ูููุฉ ุงูุฒูุฌุฉ</label>
  <input id="wifeIdInput" type="number">

  <label>ุนูุฑ ุงูุฒูุฌุฉ</label>
  <input id="wifeAgeInput" type="number" min="0">
</div>

<div class="section">
  <label>ุงูุนุฏุฏ ุงูููู ููุฃูุฑุงุฏ</label>

  <div style="display:flex;align-items:center;gap:8px;max-width:260px;">
    <button type="button" onclick="decTotalCount()" style="width:42px;">โ</button>
    <input id="totalCount" type="number" min="1" style="flex:1;text-align:center;">
    <button type="button" onclick="incTotalCount()" style="width:42px;">+</button>
  </div>

  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:12px;">
    <h3 style="margin:0;">ุงูุฃุทูุงู</h3>
    <button type="button" onclick="addChildRow()" style="width:auto;">+ ุฅุถุงูุฉ ุทูู</button>
  </div>

  <div id="childrenContainer"></div>
</div>

  <div class="section">
    <label>ุงูุณูู ุงูุฃุตูู</label><input>
    <label>ุงูุณูู ุงูุญุงูู</label><input>
    <label>ุฑูู ุฌูุงู ุฑุจ ุงูุฃุณุฑุฉ</label><input type="tel" placeholder="05xxxxxxxx">
    <label>ุฑูู ุฌูุงู ุจุฏูู (ุฅู ูุฌุฏ)</label><input type="tel">
  </div>

<div class="section">
  <label>ูู ููุฌุฏ ุญูุงูู ุฃู ูุฑุถุนุงุชุ</label>
  <select id="pregnantSelect">
    <option value="ูุง">ูุง</option>
    <option value="ูุนู">ูุนู</option>
  </select>

  <div id="pregnantBox" class="hidden" style="margin-top:10px;">
    <label style="display:flex;gap:10px;align-items:center;">
      <input type="checkbox" id="pregnantChk"> ุญุงูู
    </label>

    <label style="display:flex;gap:10px;align-items:center;margin-top:10px;">
      <input type="checkbox" id="nursingChk"> ูุฑุถุนุฉ
    </label>
  </div>
</div>

<div class="section">
  <label>ุงูุฃูุฑุงุถ</label>
  <label><input type="checkbox" id="noDisease"> ูุง ููุฌุฏ</label>
  <label><input type="checkbox" id="otherDisease"> ุฃูุฑุงุถ ุฃุฎุฑู</label>

  <div id="otherDiseaseBox" class="hidden">
    <label>ุงุฐูุฑ ุงูุฃูุฑุงุถ</label>
    <input id="otherDiseaseInput" placeholder="ุงูุชุจ ุงูุฃูุฑุงุถ ููุง">
  </div>
</div>

<div class="section">
  <label>ููุงุญุธุงุช ุงูุฃุณุฑุฉ</label>
  <textarea id="familyNotesInput" rows="3"></textarea>
</div>

  <button id="saveFamilyBtn" onclick="saveFamily()">ุญูุธ ุงูุฃุณุฑุฉ</button>
</div>


<!-- ููุงูุฉ ุงูุฌุฒุก ุงูุฃูู: ุงููุงุฌูุฉ ุงูุฃุณุงุณูุฉ + ุฅุถุงูุฉ ุงูุฃุณุฑุฉ -->
<!-- ุงูุฌุฒุก ุงูุซุงูู: ุนุฑุถ ุงูุฃุณุฑ + ุงูุฌุงูุงุณูุฑูุจุช -->
<div id="viewFamiliesSection" class="hidden">

<div id="filterSection" class="section">

  <h3>ุนุฑุถ ุงูุฃุณุฑ</h3>

  <!-- ุฎูุงุฑุงุช ุงูุญููู -->
  <div id="fieldsContainer" class="section">
    <label><input type="checkbox" class="field-toggle" data-field="socialStatus" checked> ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ</label>
    <label><input type="checkbox" class="field-toggle" data-field="name" checked> ุงุณู ุฑุจ ุงูุฃุณุฑุฉ</label>
    <label><input type="checkbox" class="field-toggle" data-field="id" checked> ุฑูู ุงููููุฉ</label>
    <label><input type="checkbox" class="field-toggle" data-field="age" checked> ุงูุนูุฑ</label>
    <label><input type="checkbox" class="field-toggle" data-field="gender" checked> ุงูุฌูุณ</label>
    <label><input type="checkbox" class="field-toggle" data-field="wife" checked> ุงุณู ุงูุฒูุฌุฉ</label>
    <label><input type="checkbox" class="field-toggle" data-field="wifeId" checked> ุฑูู ูููุฉ ุงูุฒูุฌุฉ</label>
    <label><input type="checkbox" class="field-toggle" data-field="pregnant" checked> ุญุงูู ุฃู ูุฑุถุนุฉ</label>
    <label><input type="checkbox" class="field-toggle" data-field="phone" checked> ุฑูู ุงูุฌูุงู</label>
    <label><input type="checkbox" class="field-toggle" data-field="disease" checked> ุงูุฃูุฑุงุถ</label>
    <label><input type="checkbox" class="field-toggle" data-field="originalResidence" checked> ุงูุณูู ุงูุฃุตูู</label>
    <label><input type="checkbox" class="field-toggle" data-field="currentResidence" checked> ุงูุณูู ุงูุญุงูู</label>
  </div>

  <div class="section">
    ุนุฑุถ ุนุฏุฏ ุงูุฃุณุฑ:
    <select id="pageSizeSelect">
      <option value="20">20</option>
      <option value="50">50</option>
      <option value="100">100</option>
      <option value="200">200</option>
    </select>
  </div>

  <input type="text" id="familySearch" placeholder="ุจุญุซ ุนุงู ุฃู ุนุจุฑ ุงูุญููู">

<!-- โ ุดุฑูุท ูุนูููุงุช (ุนุฏุฏ ุงูุฃุณุฑ/ุงููุบุงุฏุฑูู/ุขุฎุฑ ุญูุธ) -->
<div id="familiesInfoBar" class="section" style="padding:10px;margin-bottom:10px;">
  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <span style="background:#e9ecef;padding:6px 10px;border-radius:8px;">
        ๐จโ๐ฉโ๐งโ๐ฆ ุงูุฃุณุฑ ุงูุญุงููุฉ: <b id="infoFamiliesCount">0</b>
      </span>

      <span style="background:#e9ecef;padding:6px 10px;border-radius:8px;">
        ๐ช ุงูุฃุณุฑ ุงููุบุงุฏุฑุฉ: <b id="infoDepartedCount">0</b>
      </span>

      <span style="background:#e9ecef;padding:6px 10px;border-radius:8px;">
        ๐พ ุขุฎุฑ ุญูุธ: <b id="infoLastSaved">-</b>
      </span>
    </div>

    <button onclick="refreshFamiliesInfoBar()" class="action-btn" style="width:auto;background:#0b5ed7;">
      ุชุญุฏูุซ
    </button>
  </div>
</div>

  <!-- ุฌุฏูู ุนุฑุถ ุงูุฃุณุฑ -->
  <table id="familiesTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll"></th>
        <th class="col-socialStatus">ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ</th>
        <th class="col-name">ุงุณู ุฑุจ ุงูุฃุณุฑุฉ</th>
        <th class="col-id">ุฑูู ุงููููุฉ</th>
        <th class="col-age">ุงูุนูุฑ</th>
        <th class="col-gender">ุงูุฌูุณ</th>
        <th class="col-wife">ุงุณู ุงูุฒูุฌุฉ</th>
        <th class="col-wifeId">ุฑูู ูููุฉ ุงูุฒูุฌุฉ</th>
        <th class="col-pregnant">ุญุงูู ุฃู ูุฑุถุนุฉ</th>
        <th class="col-phone">ุฑูู ุงูุฌูุงู</th>
        <th class="col-disease">ุงูุฃูุฑุงุถ</th>
        <th class="col-originalResidence">ุงูุณูู ุงูุฃุตูู</th>
        <th class="col-currentResidence">ุงูุณูู ุงูุญุงูู</th>
        <th>ุงูุฅุฌุฑุงุกุงุช</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="pagination" class="section"></div>

  <button onclick="exportSelected()">ุชุตุฏูุฑ ุงููุญุฏุฏ</button>
  <button onclick="departSelected()">ูุบุงุฏุฑุฉ ุงููุญุฏุฏ</button>
  <button onclick="exportAllFamilies()">ุชุตุฏูุฑ ูู ุงูุจูุงูุงุช</button>
</div>  <!-- ุฅุบูุงู filterSection -->
</div>  <!-- ุฅุบูุงู viewFamiliesSection -->

</div> <!-- ุฅุบูุงู mainContainer -->

<script src="xlsx.bundle.js"></script>

<script defer>
try {

let currentView = "add"; // add | view

console.log("JS OK โ script started");

document.addEventListener("DOMContentLoaded", function () {

  // ุนูุงุตุฑ ุงูุชุญูู
  const gender = document.getElementById("gender");
  const social = document.getElementById("socialStatus");
  const wifeBox = document.getElementById("wifeBox");
  const femaleReason = document.getElementById("femaleReason");
  const total = document.getElementById("totalCount");
  const childrenBox = document.getElementById("childrenContainer");

  // ุนูุงุตุฑ ุงูุญูุงูู/ุงููุฑุถุนุงุช + ุงูุฃูุฑุงุถ
  const pregnantSelect = document.getElementById("pregnantSelect");
  const pregnantBox = document.getElementById("pregnantBox");

  const noDisease = document.getElementById("noDisease");
  const otherDisease = document.getElementById("otherDisease");
  const otherDiseaseBox = document.getElementById("otherDiseaseBox");

// โ calcAge ูุงุฒู ุชููู Global ุนุดุงู ุชุดุชุบู ูุน onchange
  window.calcAge = function calcAge(input) {
    if (!input || !input.value) return;

    try {
      const birthDate = new Date(input.value);
      const today = new Date();

      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();

      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      if (age < 0) age = 0;

      const ageBox = input.parentElement.querySelector(".age");
      if (ageBox) ageBox.textContent = "ุงูุนูุฑ: " + age + " ุณูุฉ";
    } catch (e) {
      console.error("calcAge error", e);
    }
  };

  // ุชุญุฏูุซ ุธููุฑ ุงูุฒูุฌุฉ ูุงูุฃุทูุงู ุนูุฏ ุชุบููุฑ ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ ุฃู ุงูุฌูุณ ุฃู ุงูุนุฏุฏ
  function updateVisibility() {
    const g = gender?.value || "";
    const s = social?.value || "";

    // ุฅุฎูุงุก ุฃู ุฅุธูุงุฑ ุฎุงูุฉ ุงูุฒูุฌุฉ
    if (wifeBox) wifeBox.style.display = (s === "ูุชุฒูุฌ") ? "block" : "none";

    // ุณุจุจ ุงูุชุณุฌูู ุจุงุณู ุงููุฑุฃุฉ
    if (femaleReason) femaleReason.classList.toggle("hidden", !(g === "ุงูุซู" && s === "ูุชุฒูุฌ"));

    generateChildren();
  }

// โ ุฒุฑุงุฑ +/โ ููุนุฏุฏ ุงูููู
window.incTotalCount = function(){
  const total = document.getElementById("totalCount");
  if (!total) return;
  const n = Number(total.value || 1);
  total.value = String((Number.isFinite(n) ? n : 1) + 1);
  updateVisibility(); // ุณูุณุชุฏุนู generateChildren()
};

window.decTotalCount = function(){
  const total = document.getElementById("totalCount");
  if (!total) return;
  const n = Number(total.value || 1);
  const next = Math.max(1, (Number.isFinite(n) ? n : 1) - 1);
  total.value = String(next);
  updateVisibility(); // ุณูุณุชุฏุนู generateChildren()
};

// โ ุฒุฑ + ุฅุถุงูุฉ ุทูู
window.addChildRow = function(){
  const cont = document.getElementById("childrenContainer");
  if (!cont) return;

  // ูุญูุธ ุงูููุฌูุฏ
  const kids = _readChildrenUI();

  // ูุถูู ุทูู ุฌุฏูุฏ
  kids.push({ name:"", dob:"", gender:"", relation:"", note:"" });

  // ูุฑุณู ุญุณุจ ุงูุนุฏุฏ ุงูุฌุฏูุฏ
  _renderChildrenUI(kids);

  // ูุญุฏูุซ ุงูุนุฏุฏ ุงูููู ุชููุงุฆููุง (ุนุดุงู ูุตูุฑ ูุชุทุงุจู)
  const base = _adultBaseCount();
  const total = document.getElementById("totalCount");
  if (total) total.value = String(Math.max(1, base + kids.length));
};

// โ ุฏุงูุฉ ูุฑุงุกุฉ ุงูุฃุทูุงู ูู ุงูุดุงุดุฉ (ุญุชู ูุง ูุถูุนูุง)
function _readChildrenUI(){
  const cont = document.getElementById("childrenContainer");
  if (!cont) return [];

  const kids = [];
  cont.querySelectorAll(".child").forEach(box=>{
    const name = box.querySelector(".childName")?.value ?? "";
    const childId = box.querySelector(".childId")?.value ?? "";   // โ NEW
    const dob  = box.querySelector(".childDob")?.value ?? "";
    let gender = box.querySelector(".childGender")?.value ?? "";
    let relation = box.querySelector(".childRelation")?.value ?? "";
    const note = box.querySelector(".childNote")?.value ?? "";

    gender = String(gender).trim();
    if (gender === "ุงูุซู") gender = "ุฃูุซู";

    relation = String(relation).trim();
    if (relation === "ุงุฎ") relation = "ุฃุฎ";
    if (relation === "ุงุฎุช") relation = "ุฃุฎุช";

    // โ ุชูุญูุฏ ุงูููู ุงููุฏููุฉ ุงูุบูุท
    if (/^[0-9]+$/.test(relation)) relation = "";
    if (relation === "ููุฏ") relation = "ุงุจู";

    kids.push({
      name: String(name).trim(),
      childId: String(childId).trim(), // โ NEW
      dob: String(dob).trim(),
      gender,
      relation,
      note: String(note).trim()
    });
  });

  return kids;
}

// โ ุนุฏุฏ ุงูุจุงูุบูู ุงูุฃุณุงุณู ุญุณุจ ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ
function _adultBaseCount(){
  const s = (document.getElementById("socialStatus")?.value || "").trim();
  // ูุชุฒูุฌ = ุฒูุฌ + ุฒูุฌุฉ
  if (s === "ูุชุฒูุฌ") return 2;
  // ุจุงูู ุงูุญุงูุงุช ุบุงูุจูุง ูุฑุฏ ูุงุญุฏ (ุฑุจ ุงูุฃุณุฑุฉ)
  if (s) return 1;
  return 1;
}

// โ ุฑุณู ุงูุฃุทูุงู (ูุน ุฒุฑ ุญุฐู ููู ุทูู + ุชุฃููุฏ)
function _renderChildrenUI(kids){
  const cont = document.getElementById("childrenContainer");
  if (!cont) return;

  cont.innerHTML = "";

  const safe = (v) => String(v ?? "").replace(/"/g, "&quot;");

  function normalizeRelation(raw){
    let r = String(raw ?? "").trim();
    if (!r || /^[0-9]+$/.test(r)) return "";
    if (r === "ููุฏ" || r === "ุงุจู") return "ุงุจู";
    if (r === "ุงุฎ" || r === "ุฃุฎ") return "ุฃุฎ";
    if (r === "ุงุฎุช" || r === "ุฃุฎุช") return "ุฃุฎุช";
    return "";
  }

  kids.forEach((ch, idx)=>{
    const box = document.createElement("div");
    box.className = "child";
    box.style.cssText =
      "border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-top:10px;background:#fff;position:relative;";

    const fixedRel = normalizeRelation(ch?.relation);

    box.innerHTML = `
      <button type="button"
        class="childRemoveBtn"
        data-idx="${idx}"
        style="position:absolute;left:10px;top:10px;width:auto;background:#dc3545;">
        ุญุฐู ุงูุทูู
      </button>

      <label>ุงุณู ุงูุทูู</label>
      <input type="text" class="childName" value="${safe(ch?.name)}" />

<label>ุฑูู ูููุฉ ุงูุทูู (ุงุฎุชูุงุฑู)</label>
<input type="text" class="childId" value="${safe(ch?.childId)}" />

      <label>ุชุงุฑูุฎ ุงููููุงุฏ</label>
      <input type="date" class="childDob" value="${safe(ch?.dob)}" />

      <label>ุงูุฌูุณ</label>
      <select class="childGender">
        <option value="">ุงุฎุชุฑ</option>
        <option value="ุฐูุฑ">ุฐูุฑ</option>
        <option value="ุฃูุซู">ุฃูุซู</option>
      </select>

      <label>ุตูุฉ ุงููุฑุงุจุฉ</label>
      <select class="childRelation">
        <option value="">ุงุฎุชุฑ</option>
        <option value="ุงุจู">ุงุจู</option>
        <option value="ุฃุฎ">ุฃุฎ</option>
        <option value="ุฃุฎุช">ุฃุฎุช</option>
      </select>

      <label>ููุงุญุธุฉ (ุงุฎุชูุงุฑู)</label>
      <textarea class="childNote" rows="2" placeholder="ูุซุงู: ูุฏูู ุฅุนุงูุฉ / ูุญุชุงุฌ ุนูุงุฌ...">${safe(ch?.note)}</textarea>
    `;

    // ุถุจุท ุงูููู
    let g = String(ch?.gender ?? "").trim();
    if (g === "ุงูุซู") g = "ุฃูุซู";
    box.querySelector(".childGender").value = g;
    box.querySelector(".childRelation").value = fixedRel;

    cont.appendChild(box);
  });

  // ุฃุญุฏุงุซ ุญุฐู ุงูุทูู (ุชุฃููุฏ + ุชุญุฏูุซ ุงูุนุฏุฏ)
  cont.querySelectorAll(".childRemoveBtn").forEach(btn=>{
    btn.onclick = function(){
      const i = Number(this.getAttribute("data-idx"));
      if (!Number.isFinite(i)) return;

      if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุทููุ")) return;

      const kids2 = _readChildrenUI();
      kids2.splice(i, 1);

      _renderChildrenUI(kids2);

      const base = _adultBaseCount();
      const total = document.getElementById("totalCount");
      if (total) total.value = String(Math.max(1, base + kids2.length));

      // ุฅุนุงุฏุฉ ุชุทุจูู ุงูุฑุคูุฉ (ุฅุฐุง ุนูุฏู ููุทู ูุฅุฎูุงุก/ุฅุธูุงุฑ)
      if (typeof updateVisibility === "function") updateVisibility();
    };
  });
}

// โ ุงุณุชุจุฏุงู generateChildren: ูุง ููุณุญ ุงููุฏูู ุนูุฏ ุงูุฒูุงุฏุฉ
function generateChildren() {
  const total = document.getElementById("totalCount");
  const cont = document.getElementById("childrenContainer");
  if (!total || !cont) return;

  const base = _adultBaseCount();

  // ุงูุนุฏุฏ ุงูููู ุงูุญุงูู
  const t = Number(total.value || 1);
  const totalN = (Number.isFinite(t) ? Math.max(1, Math.floor(t)) : 1);

// โ ุณูู ุฃูุงู ูููุน ุงูุชุนููู ูู ุงููุชุจ ุฑูู ูุจูุฑ ุจุงูุบูุท
const MAX_TOTAL = 50; // ุบููุฑู ุฅุฐุง ุจุฏู
if (totalN > MAX_TOTAL) {
  total.value = String(MAX_TOTAL);
}

  // ุงูุฃุทูุงู ุงููุทููุจูู = ุงูุนุฏุฏ ุงูููู - ุนุฏุฏ ุงูุจุงูุบูู ุงูุฃุณุงุณู
let safeTotalN = Math.min(totalN, 50); // ููุณ MAX_TOTAL
let desiredKids = Math.max(0, safeTotalN - base);

  // โ ูุญูุธ ุงูููุฌูุฏ ูู ุงูุดุงุดุฉ ุฃููุงู
  const currentKids = _readChildrenUI();

  // โ ูุง ูุญุฐู ุงููุฏูู ุนูุฏ ุงูุฒูุงุฏุฉ: ูุถูู ููุท
  let finalKids = currentKids.slice();

  if (finalKids.length < desiredKids) {
    while (finalKids.length < desiredKids) {
      finalKids.push({ name:"", childId:"", dob:"", gender:"", relation:"", note:"" });
    }
  } else if (finalKids.length > desiredKids) {
    // ุนูุฏ ุงูููุตุงู ููุท ููุต ูู ุงูุขุฎุฑ
    finalKids = finalKids.slice(0, desiredKids);
  }

  _renderChildrenUI(finalKids);
}

  // โ ุงูุญูุงูู/ุงููุฑุถุนุงุช: ุฅุธูุงุฑ/ุฅุฎูุงุก ุงูุตูุฏูู
  function updatePregnantUI() {
  const pregnantSelect = document.getElementById("pregnantSelect");
  const pregnantBox = document.getElementById("pregnantBox");
  if (!pregnantSelect || !pregnantBox) return;

  const v = pregnantSelect.value;
  if (v === "ูุนู") {
    pregnantBox.classList.remove("hidden");
  } else {
    pregnantBox.classList.add("hidden");

    // ุชูุธูู ุงูุงุฎุชูุงุฑุงุช ุนูุฏ "ูุง"
    const p = document.getElementById("pregnantChk");
    const n = document.getElementById("nursingChk");
    if (p) p.checked = false;
    if (n) n.checked = false;
  }
}

  // โ ุงูุฃูุฑุงุถ: ุฅุธูุงุฑ ุฎุงูุฉ โุฃูุฑุงุถ ุฃุฎุฑูโ
  function updateDiseaseUI() {
    if (!noDisease || !otherDisease || !otherDiseaseBox) return;

    if (noDisease.checked) {
      otherDisease.checked = false;
      otherDiseaseBox.classList.add("hidden");
      const inp = document.getElementById("otherDiseaseInput");
      if (inp) inp.value = "";
      return;
    }

    if (otherDisease.checked) {
      noDisease.checked = false;
      otherDiseaseBox.classList.remove("hidden");
    } else {
      otherDiseaseBox.classList.add("hidden");
      const inp = document.getElementById("otherDiseaseInput");
      if (inp) inp.value = "";
    }
  }

  // ุฑุจุท ุงูุชุบููุฑุงุช ุจุงูุฏูุงู
  gender && (gender.onchange = updateVisibility);
  social && (social.onchange = () => { updateVisibility(); generateChildren(); });
document.getElementById("totalCount")?.addEventListener("input", generateChildren);

  pregnantSelect && pregnantSelect.addEventListener("change", updatePregnantUI);

  noDisease && noDisease.addEventListener("change", updateDiseaseUI);
  otherDisease && otherDisease.addEventListener("change", updateDiseaseUI);

  // ุชุดุบูู ุฃููู
  updateVisibility();
  updatePregnantUI();
  updateDiseaseUI();

  console.log("JS โ ุฅุถุงูุฉ ุงูุฃุณุฑุฉ ุฌุงูุฒุฉ");
});

/* ====== ูุคูุชูุง: ูุง ุชุถุน ุฃู ููุฏ ุขุฎุฑ ููุง ====== */

/* ุงุฎุชุจุงุฑ ุจุณูุท ููุชุฃูุฏ ุฃู ุงูุตูุญุฉ ูุงููุงุฆูุฉ ุชุนูู */
document.addEventListener("DOMContentLoaded", function () {

  const menuToggle = document.getElementById("menuToggle");
  const sideMenu   = document.getElementById("sideMenu");

  if (!menuToggle || !sideMenu) {
    console.error("menuToggle ุฃู sideMenu ุบูุฑ ููุฌูุฏ");
    return;
  }

  menuToggle.onclick = function (e) {
    sideMenu.style.right = "0";
    e.stopPropagation();
  };

  document.addEventListener("click", function (e) {
    if (!sideMenu.contains(e.target) && e.target !== menuToggle) {
      sideMenu.style.right = "-100%";
    }
  });

  console.log("MENU OK");
});

/* ====== ุฏูุงู ุงูุชููู ุจูู ุงูุฃูุณุงู ====== */
function hideAllSections() {
  const sections = [
    "addFamilySection",
    "viewFamiliesSection",
    "filterSection",
    "filterPage",
    "reportsPage",
    "statsSection",        // โ ุฃุถููุง ููุง
    "departedFamiliesSection",
    "aboutSection",
    "contactSection",
    "smsSection"
  ];

  sections.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add("hidden");
  });
}

function showAddFamily() {
  currentView = "add";

  // โ ุงุฎูู ูู ุงูุฃูุณุงู ุฃููุงู (ุญุชู ุงูููุชุฑุฉ ูุงูุชูุงุฑูุฑ)
  if (typeof hideAllSections === "function") hideAllSections();

  // โ ุฃุธูุฑ ุตูุญุฉ ุฅุถุงูุฉ ุงูุฃุณุฑุฉ
  const addSec = document.getElementById("addFamilySection");
  if (addSec) addSec.classList.remove("hidden");

  // โ ุฃุฎูู ุนุฑุถ ุงูุฃุณุฑ (ุฒูุงุฏุฉ ุฃูุงู)
  const viewSec = document.getElementById("viewFamiliesSection");
  if (viewSec) viewSec.classList.add("hidden");

  // โ ุงุบูุงู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ
  const sideMenu = document.getElementById("sideMenu");
  if (sideMenu) sideMenu.style.right = "-100%";

  // โ ุฑูุญ ูุฃุนูู ุงูุตูุญุฉ
  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* =========================
   SMS โ ุฅุฑุณุงู ุฑุณุงุฆู SMS
========================= */

function showSMS() {
  // 1) ุฃุฎูู ูู ุงูุฃูุณุงู
  if (typeof hideAllSections === "function") hideAllSections();

  // 2) ุฃุธูุฑ ูุณู ุงูุฑุณุงุฆู
  const sec = document.getElementById("smsSection");
  if (!sec) {
    alert("ูุณู ุงูุฑุณุงุฆู ุบูุฑ ููุฌูุฏ (smsSection)");
    return;
  }
  sec.classList.remove("hidden");

  // 3) ุงุบูุงู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ
  const sideMenu = document.getElementById("sideMenu");
  if (sideMenu) sideMenu.style.right = "-100%";


  // 4) ุงูุตุนูุฏ ููุฃุนูู
  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* =========================
   ุชุฌููุฒ ุงูุฑุณุงุฆู ูููุญุฏุฏ (ูุนุฑุถ ูุงุฆูุฉ + ุฒุฑ ููู ุฑุณุงูุฉ)
   โ๏ธ ูุงุฒู ุฒุฑ "ุชุฌููุฒ ุงูุฑุณุงุฆู" ูู HTML ููุงุฏู buildSMSList()
========================= */

/* =========================
   SMS โ ุชุฌููุฒ ุงูุฑุณุงุฆู ูููุญุฏุฏ (ูุงุฆูุฉ + ุฒุฑ ููู ุฑุณุงูุฉ)
   ูุนุชูุฏ ุนูู: window.selectedFamilyIds ุฃู window.selectedFamilyKeys
========================= */

/* =========================
   SMS (ูุณุฎุฉ ุซุงุจุชุฉ ููุถูููุฉ)
   - ุชูุฑุฃ ุงูุชุญุฏูุฏ ูู: selectedFamilyIds ุฃู selectedFamilyKeys
   - ุชูุฑุฃ ุงูุจูุงูุงุช ูู: window.families ุฃู families
   - ุชุญูุธ ุงููุต ูู data-body-enc (ูุดููุฑ) ูุชูุงุฏู ูุดุงูู HTML/ุงูุชุจุงุณุงุช
========================= */

function _getFamiliesArr() {
  // ุฏุนู ุงูุญุงูุชูู (families ูุญููุฉ ุฃู ุนูู window)
  const arr = (Array.isArray(window.families) ? window.families : (Array.isArray(families) ? families : []));
  return arr;
}

function _normalizePhone(p) {
  let s = String(p || "").trim();
  // ุงุญุฐู ูุณุงูุงุช/ุดุฑุทุงุช
  s = s.replace(/[^\d+]/g, "");
  return s;
}

function _getSelectedList() {
  const idsSet  = window.selectedFamilyIds;   // ูุซู: "402123456"
  const keysSet = window.selectedFamilyKeys;  // ูุซู: "id:402..." ุฃู "idx:3"

  const hasIds  = idsSet  && typeof idsSet.size  === "number" && idsSet.size  > 0;
  const hasKeys = keysSet && typeof keysSet.size === "number" && keysSet.size > 0;

  if (hasIds)  return Array.from(idsSet).map(id => `id:${String(id).trim()}`);
  if (hasKeys) return Array.from(keysSet).map(k => String(k));
  return [];
}

/* =========================
   ุชุฌููุฒ ุงูุฑุณุงุฆู ูููุญุฏุฏ (ูุนุฑุถ ูุงุฆูุฉ + ุฒุฑ ููู ุฑุณุงูุฉ)
========================= */
function buildSMSList() {
  // ุนูุงุตุฑ ุงูุนุฑุถ
  const summaryEl = document.getElementById("smsSummary");
  const listEl    = document.getElementById("smsList");

  // โ ุฎูู ุงููุณุชุฎุฏู ูุดูู ุฅูู ุตุงุฑ ุชุญุฏูุซ ุญุชู ูู ูุดู ูุงุญูุงู
  if (summaryEl) summaryEl.textContent = "โณ ุฌุงุฑู ุชุฌููุฒ ุงูุฑุณุงุฆู...";
  if (listEl) listEl.innerHTML = "";

  // โ ุงูุชุญุฏูุฏ (ูุฏุนู ุงููุธุงููู ุงููู ุนูุฏู)
  const idsSet  = window.selectedFamilyIds;   // Set of ids
  const keysSet = window.selectedFamilyKeys;  // Set of keys

  const hasIds  = idsSet && idsSet.size > 0;
  const hasKeys = keysSet && keysSet.size > 0;

  if (!hasIds && !hasKeys) {
    if (summaryEl) summaryEl.textContent = "โ ูู ูุชู ุชุญุฏูุฏ ุฃู ุฃุณุฑ";
    alert("ูู ูุชู ุชุญุฏูุฏ ุฃู ุฃุณุฑ (ุงุฑุฌุน ูุนุฑุถ ุงูุฃุณุฑ ูุญุฏุฏ ุฃุณุฑ ุฃููุงู)");
    return;
  }

  // โ ุงูุจูุงูุงุช
  if (!Array.isArray(window.families) || window.families.length === 0) {
    if (summaryEl) summaryEl.textContent = "โ ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃุณุฑ ุญุงููุงู";
    alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃุณุฑ ุญุงููุงู");
    return;
  }

  // โ ูุต ุงูุฑุณุงูุฉ
  const mode = document.querySelector('input[name="smsMode"]:checked')?.value || "name";
  const text = String(document.getElementById("smsBody")?.value || "").trim();
  if (!text) {
    if (summaryEl) summaryEl.textContent = "โ ุงูุชุจ ูุต ุงูุฑุณุงูุฉ";
    alert("ุงูุชุจ ูุต ุงูุฑุณุงูุฉ");
    return;
  }

  // โ ูุงุฆูุฉ ููุญุฏุฉ ููุชุญุฏูุฏ
  const selectedList = hasIds
    ? Array.from(idsSet).map(id => `id:${String(id).trim()}`)
    : Array.from(keysSet).map(k => String(k));

  const messages = [];
  const skippedNoPhone = [];
  const used = new Set();

  selectedList.forEach(key => {
    let fam = null;

    // id:xxxx
    if (key.startsWith("id:")) {
      const id = key.slice(3).trim();
      fam = window.families.find(f => String(f?.id || "").trim() === id) || null;
    }

    // idx:3
    if (!fam && key.startsWith("idx:")) {
      const idx = parseInt(key.slice(4), 10);
      if (Number.isFinite(idx) && idx >= 0 && idx < window.families.length) fam = window.families[idx];
    }

    if (!fam) return;

    // โ ุฑูู ุงูุฌูุงู (ุนูุฏู ูู fam.phone)
    const phone = String(fam?.phone || "").trim();
    if (!phone) {
      skippedNoPhone.push(fam?.name || fam?.id || "ุจุฏูู ุงุณู");
      return;
    }

    const name = String(fam?.name || "").trim();
    const idv  = String(fam?.id || "").trim();

let prefix = "";

if (mode === "name") {
  prefix = `ุงูุณูุฏ / ${name}`;
} 
else if (mode === "id") {
  prefix = `ุตุงุญุจ ุงููููุฉ ${idv}`;
} 
else if (mode === "both") {
  prefix = `ุงูุณูุฏ / ${name} ุ ูููุฉ ุฑูู ${idv}`;
} 
else if (mode === "plain") {
  prefix = ""; // ุฑุณุงูุฉ ุนุงูุฉ ุจุฏูู ุงุณู ููุง ูููุฉ
}

const body = prefix
  ? `${prefix}\n${text}`.trim()
  : text.trim();

    const uniq = `p:${phone}|id:${idv}|n:${name}`;
    if (used.has(uniq)) return;
    used.add(uniq);

    messages.push({ phone, body, name: name || "-", id: idv || "-" });
  });

  if (!messages.length) {
    if (summaryEl) summaryEl.textContent = "โ ูุง ููุฌุฏ ุฃุฑูุงู ุฌูุงู ููุฃุณุฑ ุงููุญุฏุฏุฉ";
    alert("ุชู ุชุญุฏูุฏ ุฃุณุฑ ููู ูุง ููุฌุฏ ุฑูู ุฌูุงู ููุง (ุชุฃูุฏ ุฃู ุฎุงูุฉ ุงูุฌูุงู ูุญููุธุฉ ููุฃุณุฑ).");
    return;
  }

  // โ ุงูุชุจ ุงููุชูุฌุฉ ุนูู ุงูุตูุญุฉ (ูุฐุง ูุงู ูุดููุชู ุงูุฃุณุงุณูุฉ: ูุงุฒู ูุธูุฑ ุดูุก ูุงุถุญ)
  if (summaryEl) {
    summaryEl.textContent =
      `ุฌุงูุฒ โ ุนุฏุฏ ุงูุฑุณุงุฆู: ${messages.length}` +
      (skippedNoPhone.length ? ` โ ุชู ุชุฌุงูู ${skippedNoPhone.length} ุจุฏูู ุฑูู` : "");
    summaryEl.style.display = "block";
  }

  if (listEl) {
    listEl.style.display = "block";
    listEl.innerHTML = messages.map((m, i) => {
      const phoneSafe = String(m.phone).replace(/"/g, "&quot;");
      const bodySafe = String(m.body)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");

      return `
        <div style="border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:12px;margin-top:10px;">
          <div style="font-weight:bold;margin-bottom:6px;">
            ${i + 1}) ${m.name} โ ${m.phone}
          </div>

          <div style="white-space:pre-line;font-size:14px;color:#333;margin-bottom:10px;">
            ${bodySafe}
          </div>

          <button
            type="button"
            style="background:#0b5ed7;color:#fff;padding:10px 12px;border:none;border-radius:10px;"
            data-phone="${phoneSafe}"
            data-body="${bodySafe}"
            onclick="openSMSFromBtn(this); markSMSOpened(this);"
          >
            ูุชุญ ุฑุณุงูุฉ SMS
          </button>
        </div>
      `;
    }).join("");
  }

  // โ ุงูุฒู ุชููุงุฆููุง ูููุงุฆูุฉ ุนุดุงู ูุง ุชุญุณ "ูุง ุตุงุฑ ุดู"
  setTimeout(() => {
    (summaryEl || listEl)?.scrollIntoView({ behavior: "smooth", block: "start" });
  }, 50);
}

function openSMSFromBtn(btn) {
  const phone = String(btn?.getAttribute("data-phone") || "").trim();
  const bodyHtml = String(btn?.getAttribute("data-body") || "");

  if (!phone) {
    alert("ุฑูู ุงูุฌูุงู ุบูุฑ ููุฌูุฏ");
    return;
  }

  const body = bodyHtml
    .replace(/&quot;/g, '"')
    .replace(/&gt;/g, ">")
    .replace(/&lt;/g, "<")
    .replace(/&amp;/g, "&");

  const encoded = encodeURIComponent(body);

  // โ iPhone ูุญุชุงุฌ &body ุจุฏู ?body ุบุงูุจุงู
  const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  const url = isiOS
    ? `sms:${phone}&body=${encoded}`
    : `sms:${phone}?body=${encoded}`;

  location.href = url;
}

function markSMSOpened(btn) {
  const phone = btn.getAttribute("data-phone");
  if (!phone) return;

  // ุฎุฒูู ุฃูู ุงููุชุญ
  window.openedSMSKeys.add(phone);

  // ุบููุฑ ุดูู ุงููุฑุช
  const card = btn.closest(".section");
  if (card) {
    card.style.background = "#e6fffa";
    card.style.borderColor = "#20c997";
  }

  // ุบููุฑ ุงูุฒุฑ
  btn.textContent = "โ ุชู ูุชุญ ุงูุฑุณุงูุฉ";
  btn.disabled = true;
  btn.style.background = "#198754";
}

function clearSMSList() {
  const t = document.getElementById("smsBody");
  if (t) t.value = "";

  const summary = document.getElementById("smsSummary");
  const list = document.getElementById("smsList");

  if (summary) summary.textContent = "";
  if (list) list.innerHTML = "";
}

// โ ุซุจูุช ุงูุฏูุงู ููู onclick
window.buildSMSList = buildSMSList;
window.openSMSFromBtn = openSMSFromBtn;
window.clearSMSList = clearSMSList;
// โ ุชุฎุฒูู ุงูุฑุณุงุฆู ุงูููุชูุญุฉ
window.openedSMSKeys = window.openedSMSKeys || new Set();

/* ===========================
   ุนุฑุถ ุงูุฃุณุฑ: Render + Pagination + Controls  (GLOBAL)
   =========================== */

function getPageSize() {
  const sel = document.getElementById("pageSizeSelect");
  const v = sel ? parseInt(sel.value, 10) : 20;
  return Number.isFinite(v) && v > 0 ? v : 20;
}

function gotoPage(page) {
  currentPage = page;
  renderFamilies();
  // ูุง ุชุนูุฏ ุชุตููุฑ ุงูุจุญุซ ููุง
  if (typeof refreshFamiliesInfoBar === "function") refreshFamiliesInfoBar();
}

function renderPagination(totalItems, pageSize, totalPages) {
  const box = document.getElementById("pagination");
  if (!box) return;

  if (totalItems <= pageSize) {
    box.innerHTML = `ุนุฏุฏ ุงููุชุงุฆุฌ: ${totalItems}`;
    return;
  }

  box.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;">
      <button class="action-btn" style="width:auto;background:#6c757d;"
        onclick="gotoPage(${Math.max(1, currentPage - 1)})">ุงูุณุงุจู</button>

      <span style="font-weight:bold;">
        ุตูุญุฉ ${currentPage} ูู ${totalPages} โ ุฅุฌูุงูู: ${totalItems}
      </span>

      <button class="action-btn" style="width:auto;background:#6c757d;"
        onclick="gotoPage(${Math.min(totalPages, currentPage + 1)})">ุงูุชุงูู</button>
    </div>
  `;
}

// โ ุญูุธ ุงูุชุญุฏูุฏ ุจูู ุงูุจุญุซ/ุงูุตูุญุงุช (GLOBAL)
window.selectedFamilyKeys = window.selectedFamilyKeys || new Set();
const selectedFamilyKeys = window.selectedFamilyKeys;

function getFamilyKey(f, index) {
  const id = String(f?.id || "").trim();
  return id ? `id:${id}` : `idx:${index}`;
}

function ensureSelectedUI() {
  // ูุญุงูู ูุถูู ุงูุนุฏุงุฏ ุจุฌุงูุจ ุดุฑูุท ุงููุนูููุงุช ูู ููุฌูุฏ
  const infoBox = document.getElementById("infoFamiliesCount")?.parentElement; 
  if (!infoBox) return;

  let selectedSpan = document.getElementById("infoSelectedCount");
  if (!selectedSpan) {
    selectedSpan = document.createElement("span");
    selectedSpan.id = "infoSelectedCount";
    selectedSpan.style.cssText = "background:#fff3cd;color:#856404;padding:6px 10px;border-radius:10px;";
    infoBox.appendChild(selectedSpan);
  }

  let clearBtn = document.getElementById("clearSelectedBtn");
  if (!clearBtn) {
    clearBtn = document.createElement("button");
    clearBtn.id = "clearSelectedBtn";
    clearBtn.textContent = "ุฅูุบุงุก ุงูุชุญุฏูุฏ";
    clearBtn.className = "action-btn";
    clearBtn.style.cssText = "width:auto;background:#dc3545;";
    clearBtn.onclick = clearSelectedFamilies;
    infoBox.appendChild(clearBtn);
  }
  
let countSpan = document.getElementById("selectedCount");
if (!countSpan) {
  countSpan = document.createElement("span");
  countSpan.id = "selectedCount";
  countSpan.style.cssText = `
    background:#ffe8a1;
    color:#000;
    padding:6px 10px;
    border-radius:8px;
    font-weight:bold;
    margin-inline-start:8px;
    display:inline-block;
  `;
  countSpan.textContent = "ุงููุญุฏุฏ: 0";
  infoBox.appendChild(countSpan);
}

  updateSelectedCountUI();
}

function updateSelectedCountUI() {
  const el = document.getElementById("infoSelectedCount");
  if (el) el.textContent = `ุงููุญุฏุฏ: ${selectedFamilyKeys.size}`;
}

function clearSelectedFamilies() {
  selectedFamilyKeys.clear();

  // ุฃุฒู ุงูุชุญุฏูุฏ ูู ุงูุธุงูุฑ
  document.querySelectorAll('#familiesTable tbody input.familyRowCheck').forEach(cb => {
    cb.checked = false;
  });

  const selectAll = document.getElementById("selectAll");
  if (selectAll) selectAll.checked = false;

  updateSelectedCountUI();
}

function toggleSelectAllVisibleFamilies(checked) {
  // โ ุฎูููุง ููุฌูุฏุฉ ุนุดุงู ูุง ูุฎุฑุจ ุฃู ููุฏ ูุฏูู ูุนุชูุฏ ุนูููุง
  window.selectedFamilyIds = window.selectedFamilyIds || new Set();

  // โ ููู: ุญุฏุซ ูุฌููุนุฉ ุงูุนุฏุงุฏ (ุงููู ุจุชุธูุฑ "ุงููุญุฏุฏ")
  if (typeof selectedFamilyKeys !== "undefined" && selectedFamilyKeys instanceof Set) {
    if (!checked) selectedFamilyKeys.clear();
  }

  document
    .querySelectorAll('#familiesTable tbody input.familyRowCheck')
    .forEach((cb, index) => {
      cb.checked = checked;

      const id = String(cb.dataset.id || "").trim();

      // โ ููุณ ุณูููู ุงููุฏูู
      if (id) {
        if (checked) window.selectedFamilyIds.add(id);
        else window.selectedFamilyIds.delete(id);
      }

      // โ ููุฐุง ูู ุงูููู: ุญุฏูุซ selectedFamilyKeys ุนุดุงู ุงูุนุฏุงุฏ ูุดุชุบู
      if (typeof selectedFamilyKeys !== "undefined" && selectedFamilyKeys instanceof Set) {
        const key = id ? `id:${id}` : `idx:${index}`;
        if (checked) selectedFamilyKeys.add(key);
        else selectedFamilyKeys.delete(key);
      }
    });

  // โ ุชุญุฏูุซ ุงูุนุฏุงุฏ
  if (typeof updateSelectedCountUI === "function") {
    updateSelectedCountUI();
  }
}

function renderFamilies() {

  const table = document.getElementById("familiesTable");
  if (!table) return;

  const tbody = table.querySelector("tbody");
  const paginationBox = document.getElementById("pagination");

  tbody.innerHTML = "";

  // ุฌููุฒ ูุงุฆูุฉ ุงูุนุฑุถ (ูุน ุญูุธ index ุงูุฃุตูู)
  const view = (families || [])
    .map((f, index) => ({ f, index }))
    .filter(x => x.f && x.f._searchMatch !== false);

  // ุชุฑุชูุจ ุฃุจุฌุฏู ุนุฑุจู ุญุณุจ ุงูุงุณู
  view.sort((a, b) => {
    const an = (a.f.name || "").trim();
    const bn = (b.f.name || "").trim();
    return an.localeCompare(bn, "ar", { sensitivity: "base" });
  });

  // ุญุฌู ุงูุตูุญุฉ ูู select
  const pageSize = getPageSize();
  const total = view.length;
  const totalPages = Math.max(1, Math.ceil(total / pageSize));

  // ุชุฃููู currentPage ุถูู ุงูุญุฏูุฏ
  if (typeof currentPage !== "number" || currentPage < 1) currentPage = 1;
  if (currentPage > totalPages) currentPage = totalPages;

  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;
  const pageItems = view.slice(start, end);

  pageItems.forEach(({ f, index }) => {
    const tr = document.createElement("tr");
    const key = getFamilyKey(f, index);

    tr.innerHTML = `
      <td>
<input
  class="familyRowCheck"
  type="checkbox"
  data-index="${index}"
  data-id="${String(f.id || "").trim()}"
  onchange="onFamilyCheckboxChange(this)"
  ${window.selectedFamilyIds && window.selectedFamilyIds.has(String(f.id || "").trim()) ? "checked" : ""}
/>
      </td>
      <td class="col-socialStatus">${f.socialStatus || ""}</td>
      <td class="col-name">${f.name || ""}</td>
      <td class="col-id">${f.id || ""}</td>
      <td class="col-age">${f.age || ""}</td>
      <td class="col-gender">${f.gender || ""}</td>
      <td class="col-wife">${f.wife || ""}</td>
      <td class="col-wifeId">${f.wifeId || ""}</td>
      <td class="col-pregnant">${f.pregnant || "-"}</td>
      <td class="col-phone">${f.phone || "-"}</td>
      <td class="col-disease">${f.disease || "-"}</td>
      <td class="col-originalResidence">${f.originalResidence || "-"}</td>
      <td class="col-currentResidence">${f.currentResidence || "-"}</td>
      <td>
        <button class="action-btn" onclick="startEditFamily(${index})">ุชุนุฏูู</button>
      </td>
    `;

    tbody.appendChild(tr);

    // โ ุฅุนุงุฏุฉ ูุถุน check ุญุณุจ ุงูุชุญุฏูุฏ ุงููุฎุฒู
    const cb = tr.querySelector("input.familyRowCheck");
    if (cb) {
      cb.checked = selectedFamilyKeys.has(key);

      cb.addEventListener("change", function () {
        const k = String(this.dataset.key || "");
        if (!k) return;

        if (this.checked) selectedFamilyKeys.add(k);
        else selectedFamilyKeys.delete(k);

        updateSelectedCountUI();
      });
    }
  });

  // ุงุฑุณู ุฃุฒุฑุงุฑ ุงูุตูุญุงุช
  if (paginationBox) {
    renderPagination(total, pageSize, totalPages);
  }

  if (typeof initFieldToggles === "function") initFieldToggles();

  // โ UI ุงููุญุฏุฏ + ุฒุฑ ุงูุฅูุบุงุก
  ensureSelectedUI();
}

function initFamiliesViewControls() {
  const pageSizeSelect = document.getElementById("pageSizeSelect");
  if (pageSizeSelect && pageSizeSelect.dataset.bound !== "1") {
    pageSizeSelect.dataset.bound = "1";
    pageSizeSelect.addEventListener("change", function () {
      currentPage = 1;
      renderFamilies();
      if (typeof refreshFamiliesInfoBar === "function") refreshFamiliesInfoBar();
    });
  }

  const selectAll = document.getElementById("selectAll");
  if (selectAll && selectAll.dataset.bound !== "1") {
    selectAll.dataset.bound = "1";
    selectAll.addEventListener("change", function () {
      // โ ุงุฑุจุท "ุชุญุฏูุฏ ุงููู" ุจุฐุงูุฑุฉ ุงููุญุฏุฏ ูุงูุนุฏุงุฏ
      toggleSelectAllVisibleFamilies(this.checked);
    });
  }

  // โ ุงูุจุญุซ (ูุฑุฉ ูุงุญุฏุฉ ููุท)
  const search = document.getElementById("familySearch");
  if (search && search.dataset.bound !== "1") {
    search.dataset.bound = "1";
    search.addEventListener("input", function () {
      const query = this.value.trim().toLowerCase();

      (families || []).forEach(f => {
        const txt = Object.values(f || {}).join(" ").toLowerCase();
        f._searchMatch = !query ? true : txt.includes(query);
      });

      currentPage = 1;
      renderFamilies();
      if (typeof refreshFamiliesInfoBar === "function") refreshFamiliesInfoBar();
    });
  }
}
// ===== Pagination Globals =====
let currentPage = 1;

window.gotoPage = function (page) {
  currentPage = page;
  if (typeof window.renderFamilies === "function") {
    window.renderFamilies();
  }
};

window.getPageSize = function () {
  const sel = document.getElementById("pageSizeSelect");
  const v = sel ? parseInt(sel.value, 10) : 20;
  return Number.isFinite(v) && v > 0 ? v : 20;
};

window.renderPagination = function (totalItems, pageSize, totalPages) {
  const box = document.getElementById("pagination");
  if (!box) return;

  if (totalItems <= pageSize) {
    box.innerHTML = `ุนุฏุฏ ุงููุชุงุฆุฌ: ${totalItems}`;
    return;
  }

  box.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;">
      <button class="action-btn" style="width:auto;background:#6c757d;"
        onclick="gotoPage(${Math.max(1, currentPage - 1)})">ุงูุณุงุจู</button>

      <span style="font-weight:bold;">
        ุตูุญุฉ ${currentPage} ูู ${totalPages} โ ุฅุฌูุงูู: ${totalItems}
      </span>

      <button class="action-btn" style="width:auto;background:#6c757d;"
        onclick="gotoPage(${Math.min(totalPages, currentPage + 1)})">ุงูุชุงูู</button>
    </div>
  `;
};
function showFamilies() {
  currentView = "view";

  if (typeof hideAllSections === "function") hideAllSections();

  const departedSection = document.getElementById("departedFamiliesSection");
  if (departedSection) departedSection.classList.add("hidden");

  const viewSection = document.getElementById("viewFamiliesSection");
  if (viewSection) viewSection.classList.remove("hidden");

// โ ููู ุฌุฏุงู: filterSection ูู ูุญุชูู ุนุฑุถ ุงูุฃุณุฑ (ุงูุฌุฏูู/ุงูุฃุฏูุงุช)
const filterSec = document.getElementById("filterSection");
if (filterSec) filterSec.classList.remove("hidden");

  // โ ูุง ุชุตููุฑ ุงูุจุญุซ ุฏุงุฆูุงู โ ุฎูู ุงูุจุญุซ ูุญูู
  // ููุท ูู ูุง ููุด _searchMatch ุฃุตูุงู
  if (Array.isArray(families)) {
    families.forEach(f => {
      if (f && typeof f === "object" && typeof f._searchMatch === "undefined") f._searchMatch = true;
    });
  }

  initFamiliesViewControls();
  renderFamilies();
  if (typeof refreshFamiliesInfoBar === "function") refreshFamiliesInfoBar();

  const sideMenu = document.getElementById("sideMenu");
  if (sideMenu) sideMenu.style.right = "-100%";

  window.scrollTo({ top: 0, behavior: "smooth" });
}

function showContact() {
  hideAllSections();

  const el = document.getElementById("contactSection");
  if (el) el.classList.remove("hidden");

  // ุฅุบูุงู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ (ุงุฎุชูุงุฑู ููู ููุชุงุฒ)
  const sideMenu = document.getElementById("sideMenu");
  if (sideMenu) sideMenu.style.right = "-100%";

  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* ===========================
   Info Bar (counts + last save)
   =========================== */

const LAST_SAVED_KEY = "star_camp_last_saved_v1";

function setLastSavedNow() {
  try {
    localStorage.setItem(LAST_SAVED_KEY, new Date().toISOString());
  } catch (e) {}
}

function getLastSavedText() {
  try {
    const iso = localStorage.getItem(LAST_SAVED_KEY);
    if (!iso) return "-";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return "-";
    // ุตูุบุฉ ูุทููุฉ
    return d.toLocaleString("ar", { hour12: true });
  } catch (e) {
    return "-";
  }
}

function refreshFamiliesInfoBar() {
  try {
    const famCount = Array.isArray(families) ? families.length : 0;
    const depCount = Array.isArray(departedFamilies) ? departedFamilies.length : 0;

    const famEl = document.getElementById("infoFamiliesCount");
    const depEl = document.getElementById("infoDepartedCount");
    const savedEl = document.getElementById("infoLastSaved");

    if (famEl) famEl.textContent = String(famCount);
    if (depEl) depEl.textContent = String(depCount);
    if (savedEl) savedEl.textContent = (typeof getLastSavedText === "function") ? getLastSavedText() : "-";
  } catch (e) {
    console.error("refreshFamiliesInfoBar error", e);
  }
}

/* ====== ุญูุธ ุงูุฃุณุฑุฉ (ุฃุณุงุณู) + ุญูุธ ุฏุงุฆู localStorage ====== */

const STORAGE_KEY = "star_camp_v6_data_v6";

// โ ุงุฌุนููุง Global ุนูู window ุญุชู ูู ุงูุฃูุณุงู ุชุดูู ููุณ ุงูุจูุงูุงุช
window.families = window.families || [];
window.departedFamilies = window.departedFamilies || [];

// โ ุงูุญู ุงูุฃุณุงุณู (ุงููู ูุงู ูุงูุต)
let families = window.families;
let departedFamilies = window.departedFamilies;

// ุชุญููู ููุฑู ูุขูู (ุจุฏูู DOMContentLoaded)
(function loadFromStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;

    const data = JSON.parse(raw);

    // โ ููู: ูุนุฏูู ููุณ ุงููุตูููุฉ (ูุง ูุนูู ุฅุนุงุฏุฉ ุชุนุฑูู)
    families.length = 0;
    departedFamilies.length = 0;

    (Array.isArray(data.families) ? data.families : []).forEach(x => families.push(x));
    (Array.isArray(data.departedFamilies) ? data.departedFamilies : []).forEach(x => departedFamilies.push(x));

    // ุชุซุจูุช ุงููุฑุฌุน
    window.families = families;
    window.departedFamilies = departedFamilies;

  } catch (e) {
    console.error("Storage load error", e);
    families.length = 0;
    departedFamilies.length = 0;
    window.families = families;
    window.departedFamilies = departedFamilies;
  }
})();

function saveToStorage() {
  try {
    // ุชุซุจูุช ุงููุฑุฌุน (ุฃูุงู)
    window.families = families;
    window.departedFamilies = departedFamilies;

    localStorage.setItem(
      STORAGE_KEY,
      JSON.stringify({
        families: families,
        departedFamilies: departedFamilies
      })
    );
    setLastSavedNow();
  } catch (e) {
    console.error("Storage save error", e);
  }

  if (typeof refreshFamiliesInfoBar === "function") {
    refreshFamiliesInfoBar();
  }
}
/* ===========================
   Backup JSON (Export/Import)
   =========================== */

function exportBackupJSON() {
  try {
    const payload = {
      meta: {
        app: "star_camp_v6",
        version: "backup_v1",
        exportedAt: new Date().toISOString()
      },
      families: Array.isArray(families) ? families : [],
      departedFamilies: Array.isArray(departedFamilies) ? departedFamilies : []
    };

    const json = JSON.stringify(payload, null, 2);
    const blob = new Blob([json], { type: "application/json;charset=utf-8" });

    const a = document.createElement("a");
    const ts = new Date();
    const fileName =
      `star_camp_backup_${ts.getFullYear()}-${String(ts.getMonth()+1).padStart(2,"0")}-${String(ts.getDate()).padStart(2,"0")}.json`;

    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();

    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
  } catch (e) {
    console.error("exportBackupJSON error", e);
    alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตุฏูุฑ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ");
  }
}

function importBackupJSON() {
  // ุฅูุดุงุก input ูุฎูู ูุฑุฉ ูุงุญุฏุฉ
  let input = document.getElementById("backupImportInput");
  if (!input) {
    input = document.createElement("input");
    input.type = "file";
    input.id = "backupImportInput";
    input.accept = ".json,application/json";
    input.style.display = "none";
    document.body.appendChild(input);
  }

  input.onchange = async function () {
    const file = input.files && input.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const data = JSON.parse(text);

      const newFamilies  = Array.isArray(data?.families) ? data.families : [];
      const newDeparted  = Array.isArray(data?.departedFamilies) ? data.departedFamilies : [];

      if (!confirm(
        "ุณูุชู ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ุงูุญุงููุฉ ุจุงููุงูู ุจุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ.\n\nูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ"
      )) {
        input.value = "";
        return;
      }

      // โ ุชุฃูุฏ ูู ูุฌูุฏ ุงููุตูููุงุช ุนูู window (ุจุฏูู ุฅุนุงุฏุฉ ุชุนุฑูู ูุฑุฌุน ุฌุฏูุฏ)
      if (!Array.isArray(window.families)) window.families = [];
      if (!Array.isArray(window.departedFamilies)) window.departedFamilies = [];

      // โ ุญุงูุธ ุนูู ููุณ ุงููุฑุฌุน: ููุฑูุบ ุซู ูุนุจูู
      window.families.length = 0;
      window.departedFamilies.length = 0;

      newFamilies.forEach(x => window.families.push(x));
      newDeparted.forEach(x => window.departedFamilies.push(x));

      // โ (ุงุฎุชูุงุฑู) ูู ุนูุฏู ูุชุบูุฑุงุช ูุญููุฉ families / departedFamilies ุฎููููู ูุดูุฑู ูููุณ ุงููุฑุฌุน
      try { if (typeof families !== "undefined") families = window.families; } catch(e){}
      try { if (typeof departedFamilies !== "undefined") departedFamilies = window.departedFamilies; } catch(e){}

      // โ ุญูุธ ุฏุงุฆู
      if (typeof saveToStorage === "function") saveToStorage();
      else if (typeof saveToLocalStorage === "function") saveToLocalStorage();
      else if (typeof saveLocalData === "function") saveLocalData();

      // โ ุชุญุฏูุซ ุงููุงุฌูุงุช
      if (typeof renderFamilies === "function") renderFamilies();
      if (typeof renderFamiliesTable === "function") renderFamiliesTable();
      if (typeof renderDeparted === "function") renderDeparted();
      if (typeof renderDepartedFamilies === "function") renderDepartedFamilies();

      if (typeof refreshFamiliesInfoBar === "function") refreshFamiliesInfoBar();
      if (typeof safeUpdateStats === "function") safeUpdateStats(true);

      if (typeof renderReportsAll === "function") renderReportsAll();
      if (typeof applyReportsChildren === "function") applyReportsChildren();

      alert(
        `ุชู ุงูุงุณุชูุฑุงุฏ โ\n` +
        `ุงูุฃุณุฑ: ${window.families.length}\n` +
        `ุงูุฃุณุฑ ุงููุบุงุฏุฑุฉ: ${window.departedFamilies.length}`
      );

    } catch (e) {
      console.error("importBackupJSON error", e);
      alert("ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุบูุฑ ุตุงูุญ ุฃู ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุณุชูุฑุงุฏ");
    } finally {
      input.value = "";
    }
  };

  input.click();
}

function getPregnantValue() {
  const sel = document.getElementById("pregnantSelect");
  if (!sel || sel.value !== "ูุนู") return "ูุง";

  const pregnantChk = document.getElementById("pregnantChk");
  const nursingChk = document.getElementById("nursingChk");

  const parts = [];
  if (pregnantChk && pregnantChk.checked) parts.push("ุญุงูู");
  if (nursingChk && nursingChk.checked) parts.push("ูุฑุถุนุฉ");

  // ูู ุงููุณุชุฎุฏู ุงุฎุชุงุฑ ูุนู ููุง ุนููู ุดู
  return parts.length ? parts.join("ุ ") : "ูุนู";
}

function getDiseaseValue() {
  const no = document.getElementById("noDisease");
  const other = document.getElementById("otherDisease");
  const otherInput = document.getElementById("otherDiseaseInput");

  if (!no || !other || !otherInput) return "";

  // ูุง ููุฌุฏ ุฃูุฑุงุถ
  if (no.checked) return "ูุง ููุฌุฏ";

  // ุฃูุฑุงุถ ุฃุฎุฑู
  if (other.checked) {
    const v = String(otherInput.value || "").trim();
    return v ? v : "ุฃูุฑุงุถ ุฃุฎุฑู";
  }

  return "";
}
function saveFamily() {

  // ===== Helpers =====
  function normalizeName(v) {
    return String(v || "").trim().replace(/\s+/g, " ").toLowerCase();
  }

  function isValidId9(v) {
    const s = String(v || "").trim();
    return /^\d{9}$/.test(s);
  }

// โ ุฌูุน ุจูุงูุงุช ุงูุฃุทูุงู ูู ุงููููุฐุฌ (ูุน ูููุฉ ุงูุทูู)
function collectChildrenFromForm() {
  const items = [];
  const boxes = document.querySelectorAll("#childrenContainer .child");

  boxes.forEach((box) => {
    const name    = (box.querySelector("input.childName")?.value || "").trim();
    const childId = (box.querySelector("input.childId")?.value || "").trim(); // โ ูููุฉ ุงูุทูู
    const dob     = (box.querySelector("input.childDob")?.value || box.querySelector('input[type="date"]')?.value || "").trim();

    let gender = (
      (box.querySelector("select.childGender")?.value || "") ||
      (box.querySelectorAll("select")[0]?.value || "")
    ).trim();

    let relation = (
      (box.querySelector("select.childRelation")?.value || "") ||
      (box.querySelectorAll("select")[1]?.value || "")
    ).trim();

    const note = (box.querySelector("textarea.childNote")?.value || "").trim();

    // ุชูุญูุฏ ุงูููู
    if (gender === "ุงูุซู") gender = "ุฃูุซู";
    if (relation === "ุงุฎ") relation = "ุฃุฎ";
    if (relation === "ุงุฎุช") relation = "ุฃุฎุช";
    if (relation === "ููุฏ") relation = "ุงุจู";
    if (/^[0-9]+$/.test(relation)) relation = "";

    // ุญุณุงุจ ุงูุนูุฑ (ุณููุงุช)
    let age = "";
    if (dob) {
      try {
        const bd = new Date(dob);
        const today = new Date();
        let a = today.getFullYear() - bd.getFullYear();
        const m = today.getMonth() - bd.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < bd.getDate())) a--;
        if (a < 0) a = 0;
        age = String(a);
      } catch (e) {}
    }

    // ูุง ูุญูุธ ุทูู ูุงุถู ุจุงููุงูู (ูุน ุงุนุชุจุงุฑ ุงููููุฉ + ุงูููุงุญุธุฉ)
    if (!name && !childId && !dob && !gender && !relation && !note) return;

    items.push({ name, childId, dob, age, gender, relation, note });
  });

  return items;
}

  // ===== ูุฑุงุกุฉ ุจูุงูุงุช ุงููููุฐุฌ =====
  const rawName = document.querySelector("#addFamilySection input:nth-of-type(1)")?.value || "";
  const rawId   = document.querySelector("#addFamilySection input:nth-of-type(2)")?.value || "";
  const rawAge  = document.querySelector("#addFamilySection input:nth-of-type(3)")?.value || "";

  // โ ุงุณุชุฎุฑุงุฌ ุงูุณูู/ุงูุฌูุงู ูู ููุณ ุงูู section (ุฃุตูู/ุญุงูู/tel/tel)
  const sections = Array.from(document.querySelectorAll("#addFamilySection .section"));
  const residenceSection = sections.find(sec => {
    const ins = sec.querySelectorAll("input");
    if (ins.length < 4) return false;
    const types = Array.from(ins).map(x => (x.getAttribute("type") || "text").toLowerCase());
    // ูุฐุง ุงููุณู ุงููุญูุฏ ููู tel ุนุงุฏุฉ
    return types.includes("tel");
  });

  let originalResidence = "";
  let currentResidence = "";
  let phone = "";

  if (residenceSection) {
    const ins = residenceSection.querySelectorAll("input");
    // ุญุณุจ ุชุฑุชูุจ HTML ุนูุฏู: ุฃุตููุ ุญุงููุ ุฌูุงูุ ุจุฏูู
    originalResidence = String(ins[0]?.value || "").trim();
    currentResidence  = String(ins[1]?.value || "").trim();
    phone             = String(ins[2]?.value || "").trim();
  } else {
    phone = document.querySelector('#addFamilySection input[type="tel"]')?.value?.trim() || "";
  }

  const family = {
  socialStatus: document.getElementById("socialStatus")?.value || "",
  name: String(rawName).trim().replace(/\s+/g, " "),
  id: String(rawId).trim(),
  age: String(rawAge).trim(),
  gender: document.getElementById("gender")?.value || "",

// โ ุงูุฒูุฌุฉ (ูุฑุงุกุฉ ุขููุฉ ูู IDs)
wife: String(document.getElementById("wifeNameInput")?.value || "").trim(),
wifeId: String(document.getElementById("wifeIdInput")?.value || "").trim(),
wifeAge: (() => {
  const v = String(document.getElementById("wifeAgeInput")?.value || "").trim();

  // ูู ูุงุถู ุฑุฌุนู ูุงุถู
  if (!v) return "";

  // ูู ูุด ุฑูู (ุงุญุชูุงุท)
  if (!/^\d+$/.test(v)) return "";

  // ูู ุตุงุฑ ุฎูุท ุจุงูุบูุท ูุทูุน ุนูุฑ = ุฑูู ูููุฉ (9 ุฃุฑูุงู) ุงุนุชุจุฑู ุฎุทุฃ
  if (v.length === 9) return "";

  return v;
})(),

    // โ ุญููู ุงูุชุตุฏูุฑ ุงููุงูู
totalCount: String(document.getElementById("totalCount")?.value || "").trim(),
originalResidence,
currentResidence,
phone,
notes: String(document.getElementById("familyNotesInput")?.value || "").trim(),

// โ ุงูุฃุทูุงู (ููุชูุงุฑูุฑ)
children: (() => {
  const collected = collectChildrenFromForm();
  const idx = (typeof editingFamilyIndex === "number") ? editingFamilyIndex : null;
  const oldKids =
    (idx !== null && families[idx] && Array.isArray(families[idx].children))
      ? families[idx].children
      : [];
  return Array.isArray(collected) ? collected : oldKids;
})(),

    // โ ุงูุญูุงูู/ุงููุฑุถุนุงุช
    pregnant: getPregnantValue(),

    // โ ุงูุฃูุฑุงุถ
    disease: getDiseaseValue(),

    _searchMatch: true
  };

  // ุญูุงูุฉ: ูุง ูุญูุธ ุณุฌู ูุงุถู
  if (!family.name || !family.id) {
    alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ูุฑูู ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ");
    return;
  }

  // โ ุฑูู ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ: 9 ุฃุฑูุงู
  if (!isValidId9(family.id)) {
    alert("ุฑูู ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ ูุฌุจ ุฃู ูููู 9 ุฃุฑูุงู. ุงูุฑุฌุงุก ุงูุชุฃูุฏ ูู ุฑูู ุงููููุฉ.");
    return;
  }

  // โ ุฑูู ูููุฉ ุงูุฒูุฌุฉ (ุฅู ููุชุจ): 9 ุฃุฑูุงู
  if (family.wifeId && !isValidId9(family.wifeId)) {
    alert("ุฑูู ูููุฉ ุงูุฒูุฌุฉ ูุฌุจ ุฃู ูููู 9 ุฃุฑูุงู. ุงูุฑุฌุงุก ุงูุชุฃูุฏ ูู ุฑูู ุงููููุฉ.");
    return;
  }

  // ===== ููุน ุงูุชูุฑุงุฑ (ุฑุจ ุงูุฃุณุฑุฉ ููุท) =====
  const myIndex = (typeof editingFamilyIndex === "number") ? editingFamilyIndex : null;

  const nameKey = normalizeName(family.name);
  const idKey   = String(family.id).trim();

  const duplicate = families.some((f, idx) => {
    if (!f) return false;
    if (myIndex !== null && idx === myIndex) return false;

    const otherName = normalizeName(f.name);
    const otherId   = String(f.id || "").trim();

    return (otherId === idKey) || (otherName === nameKey);
  });

  if (duplicate) {
    alert("ุชูุจูู: ูุฐู ุงูุฃุณุฑุฉ ูุณุฌูุฉ ูุณุจููุง (ุงุณู ุฑุจ ุงูุฃุณุฑุฉ ุฃู ุฑูู ูููุชู ููุฑุฑ).");
    return;
  }

const wasEdit = (myIndex !== null && families[myIndex]);

// ===== ุญูุธ (ุชุนุฏูู/ุฌุฏูุฏ) =====
if (wasEdit) {
  const old = families[myIndex] || {};

  // โ ุญูุงูุฉ: ูุง ุชูุฑูุบ ุญููู ูููุฉ ุฅุฐุง ูุงูุช ูุงุถูุฉ ุฃุซูุงุก ุงูุชุนุฏูู

  // ุงูุฃุทูุงู
  const newChildrenOk = Array.isArray(family.children) && family.children.length > 0;
  const oldChildrenOk = Array.isArray(old.children) && old.children.length > 0;
  if (!newChildrenOk && oldChildrenOk) family.children = old.children;

  // ุงูุณูู
  if (!String(family.originalResidence || "").trim() && String(old.originalResidence || "").trim()) {
    family.originalResidence = old.originalResidence;
  }
  if (!String(family.currentResidence || "").trim() && String(old.currentResidence || "").trim()) {
    family.currentResidence = old.currentResidence;
  }

  // ุงูุฌูุงู
  if (!String(family.phone || "").trim() && String(old.phone || "").trim()) {
    family.phone = old.phone;
  }


  // ุงูุนุฏุฏ ุงูููู
  if (!String(family.totalCount || "").trim() && String(old.totalCount || "").trim()) {
    family.totalCount = old.totalCount;
  }

  // โ ุนูุฑ ุงูุฒูุฌุฉ:
  // 1) ุญุงูู ุงูุฑุฃู ูู ุงููููุฐุฌ (ุฅู ูุฌุฏ)
  // 2) ูู ูุงุถูุ ุฎููู ูู ุงููุฏูู
  try {
try {
  const wifeAgeFromDom = String(document.getElementById("wifeAgeInput")?.value || "").trim();

  // ููุณ ุงูุญูุงูุฉ: ูู 9 ุฃุฑูุงู ุงุนุชุจุฑู ุฎุทุฃ (ุบุงูุจุงู ูููุฉ)
  if (wifeAgeFromDom && /^\d+$/.test(wifeAgeFromDom) && wifeAgeFromDom.length !== 9) {
    family.wifeAge = wifeAgeFromDom;
  }
} catch (e) {}
    if (wifeAgeFromDom) family.wifeAge = wifeAgeFromDom;
  } catch (e) {}

  if (!String(family.wifeAge || "").trim() && String(old.wifeAge || "").trim()) {
    family.wifeAge = old.wifeAge;
  }

// โ ุงูุญูุงูู/ุงููุฑุถุนุงุช (ููุงุฆู)
const newPreg = String(family.pregnant || "").trim();
const oldPreg = String(old.pregnant || "").trim();

// 1) ุงุฎุชุงุฑ "ูุง" ุตุฑุงุญุฉ
if (newPreg === "ูุง") {
  family.pregnant = "ูุง";
}
// 2) ุงุฎุชุงุฑ "ูุนู" ุตุฑุงุญุฉ
else if (newPreg === "ูุนู") {
  family.pregnant = "ูุนู";
}
// 3) ูู ูููุณ ุงูุญูู (ูุงุถู) โ ุฑุฌูุน ุงููุฏูู
else if (!newPreg && oldPreg) {
  family.pregnant = oldPreg;
}

  // ุงูุฃูุฑุงุถ: ูู ุงูุฌุฏูุฏ ูุงุถู ุฎููู ุงููุฏูู
  if (!String(family.disease || "").trim() && String(old.disease || "").trim()) {
    family.disease = old.disease;
  }

// โ ุญูุงูุฉ ููุงุฆูุฉ: ูุง ุชูุณุญ ุงูุฃุทูุงู ุนูุฏ ุงูุชุนุฏูู ุฅุฐุง ูุงูุช ุงูุฎุงูุฉ ูุงุถูุฉ ุจุงูุบูุท
if (wasEdit) {
  const oldFam = families[myIndex];
  if (
    Array.isArray(oldFam?.children) &&
    oldFam.children.length &&
    (!Array.isArray(family.children) || family.children.length === 0)
  ) {
    family.children = oldFam.children;
  }
}

  families[myIndex] = family;
  alert("ุชู ุญูุธ ุงูุชุนุฏูู ุจูุฌุงุญ");
} else {
  families.push(family);
  alert("ุชู ุญูุธ ุงูุฃุณุฑุฉ ุจูุฌุงุญ");
}

  // โ ุญูุธ ุฏุงุฆู ุจุนุฏ ุฃู ุชุบููุฑ
  if (typeof saveToStorage === "function") saveToStorage();

  // ุชุตููุฑ ูุถุน ุงูุชุนุฏูู + ุฒุฑ ุงูุญูุธ
  editingFamilyIndex = null;
  const saveBtn = document.getElementById("saveFamilyBtn");
  if (saveBtn) saveBtn.textContent = "ุญูุธ ุงูุฃุณุฑุฉ";

  // ุฅุฒุงูุฉ ุฒุฑ ุงูุฅูุบุงุก ุฅู ูุฌุฏ
  const cancelBtn = document.getElementById("cancelEditBtn");
  if (cancelBtn) cancelBtn.remove();

  // ุชูุฑูุบ ุงููููุฐุฌ
  document.querySelectorAll("#addFamilySection input").forEach(i => i.value = "");
  document.querySelectorAll("#addFamilySection select").forEach(s => s.value = "");
const notesEl = document.getElementById("familyNotesInput");
if (notesEl) notesEl.value = "";

  // ุชุญุฏูุซ ุงูุฌุฏุงูู
  if (typeof renderFamilies === "function") renderFamilies();
  if (typeof renderFilterResults === "function") {
    renderFilterResults(lastFilterResults && lastFilterResults.length ? lastFilterResults : families);
  }

  // โ ูู ูุงู ุชุนุฏูู: ุงุฑุฌุน ูุตูุญุฉ ุนุฑุถ ุงูุฃุณุฑ
  if (wasEdit && typeof showFamilies === "function") {
    showFamilies();
  }
}
/* ====== ุงูุจุญุซ ูู ุงูุฃุณุฑ (ููุงุฆู + ุขูู) ====== */
document.getElementById("familySearch")?.addEventListener("input", function () {
  const query = this.value.trim().toLowerCase();

  (families || []).forEach(f => {
    if (!f) return;

    if (!query) {
      // โ ุนูุฏ ูุณุญ ุงูุจุญุซ โ ุฃุธูุฑ ุงููู ูุถููู
      f._searchMatch = true;
    } else {
      const text = Object.values(f).join(" ").toLowerCase();
      f._searchMatch = text.includes(query);
    }
  });

  // โ ุงุฑุฌุน ูุฃูู ุตูุญุฉ ุนูุฏ ุฃู ุจุญุซ
  currentPage = 1;

  if (typeof renderFamilies === "function") renderFamilies();
  if (typeof refreshFamiliesInfoBar === "function") refreshFamiliesInfoBar();
});

function departSelected() {

  // โ ูุฌูุน ุงูุชุญุฏูุฏ ูู ุงูุฐุงูุฑุฉ (ุญุชู ูู ูุด ุธุงูุฑ ุจุณุจุจ ุงูุจุญุซ) ุฃู ูู ุงูุฌุฏูู
  const selectedIds = (window.selectedFamilyIds && window.selectedFamilyIds.size)
    ? Array.from(window.selectedFamilyIds).map(s => String(s).trim()).filter(Boolean)
    : Array.from(document.querySelectorAll('#familiesTable tbody input[type="checkbox"]:checked'))
        .map(cb => String(cb.dataset.id || "").trim())
        .filter(Boolean);

  if (!selectedIds.length) {
    alert("ูุฑุฌู ุชุญุฏูุฏ ุฃุณุฑุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู");
    return;
  }

  const count = selectedIds.length;
  if (!confirm(`ูู ุชุฑูุฏ ููู ${count} ุฃุณุฑุฉ ุฅูู ูุงุฆูุฉ ุงูุฃุณุฑ ุงููุบุงุฏุฑุฉุ`)) return;

  const idSet = new Set(selectedIds);

  // โ ุฃุถู ูููุบุงุฏุฑูู ุจุฏูู ุชูุฑุงุฑ + ุงุฌูุน ุงูุฏูุณุงุช ุงูุญุฐู ูู families
  const toRemove = [];
  (families || []).forEach((f, idx) => {
    const fid = String(f?.id || "").trim();
    if (!fid) return;
    if (!idSet.has(fid)) return;

    const exists = (departedFamilies || []).some(df => String(df?.id || "").trim() === fid);
    if (!exists) departedFamilies.push(f);

    toRemove.push(idx);
  });

  if (!toRemove.length) {
    alert("ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃุณุฑ ูุทุงุจูุฉ ููุชุญุฏูุฏ (ุชุฃูุฏ ูู ูุฌูุฏ ุฑูู ูููุฉ).");
    return;
  }

  // โ ุญุฐู ูู ุงูููุงูุฉ ููุจุฏุงูุฉ
  toRemove.sort((a, b) => b - a).forEach(i => families.splice(i, 1));

  // โ ุงุญุฐููู ูู ุฐุงูุฑุฉ ุงูุชุญุฏูุฏ
  if (window.selectedFamilyIds && window.selectedFamilyIds.size) {
    selectedIds.forEach(id => window.selectedFamilyIds.delete(id));
  }

  // โ ุญูุธ ุฏุงุฆู
  if (typeof saveToStorage === "function") saveToStorage();

  // โ ุชุญุฏูุซ ููุฑู ูููุงุฌูุงุช
  if (typeof renderFamilies === "function") renderFamilies();
  if (typeof renderDeparted === "function") renderDeparted();
  if (typeof refreshFamiliesInfoBar === "function") refreshFamiliesInfoBar();
  if (typeof updateSelectedCountUI === "function") updateSelectedCountUI();

  alert("ุชู ููู ุงูุฃุณุฑ ุงููุญุฏุฏุฉ ุฅูู ุงูุฃุณุฑ ุงููุบุงุฏุฑุฉ โ");
}

// ===========================
// Departed: Paging + SelectAll
// ===========================

let departedPage = 1;

// โ ุญุฌู ุงูุนุฑุถ
function _getDepartedPageSize() {
  const v = String(document.getElementById("departedPageSize")?.value || "").trim();
  const n = parseInt(v, 10);
  if (!isNaN(n) && n >= 0) return n;
  return 20;
}

function _departedTotalPages(total, pageSize) {
  if (!pageSize || pageSize === 0) return 1; // ุนุฑุถ ุงููู
  return Math.max(1, Math.ceil(total / pageSize));
}

function departedPrevPage() {
  departedPage = Math.max(1, departedPage - 1);
  renderDeparted();
}

function departedNextPage() {
  const total = Array.isArray(departedFamilies) ? departedFamilies.length : 0;
  const ps = _getDepartedPageSize();
  const tp = _departedTotalPages(total, ps);
  departedPage = Math.min(tp, departedPage + 1);
  renderDeparted();
}

// โ ุชุญุฏูุฏ ูู ุงููุนุฑูุถ (ูู ุงูุตูุญุฉ ุงูุญุงููุฉ)
function toggleAllDeparted(checked) {
  document.querySelectorAll("#departedTable tbody input.departedRowCheck").forEach(cb => {
    cb.checked = checked;
  });

  const top = document.getElementById("departedSelectAllTop");
  const bot = document.getElementById("departedSelectAllBottom");
  if (top) top.checked = checked;
  if (bot) bot.checked = checked;
}

function renderDeparted() {

  const section = document.getElementById("departedFamiliesSection");
  if (!section) return;

  const tbody = section.querySelector("tbody");
  if (!tbody) return;

  const list = Array.isArray(departedFamilies) ? departedFamilies : [];
  const pageSize = _getDepartedPageSize();

  const totalItems = list.length;
  const totalPages = _departedTotalPages(totalItems, pageSize);

  if (departedPage > totalPages) departedPage = totalPages;
  if (departedPage < 1) departedPage = 1;

  let view = list;
  if (pageSize !== 0) {
    const start = (departedPage - 1) * pageSize;
    view = list.slice(start, start + pageSize);
  }

  tbody.innerHTML = "";

  if (!view.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4" style="text-align:center;color:#666;padding:12px;">
          ูุง ุชูุฌุฏ ุฃุณุฑ ูุบุงุฏุฑุฉ
        </td>
      </tr>
    `;
  } else {
    view.forEach((f, i) => {
      const realIndex = pageSize === 0
        ? i
        : (departedPage - 1) * pageSize + i;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="text-align:center;">
          <input type="checkbox"
                 class="departedRowCheck"
                 data-index="${realIndex}">
        </td>
        <td>${f.name || "-"}</td>
        <td>${f.id || "-"}</td>
        <td>${f.phone || "-"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  /* ===== ุชุญุฏูุซ ูุนูููุงุช ุงูุตูุญุงุช ===== */
  const info = document.getElementById("departedPageInfo");
  if (info) {
    info.textContent =
      pageSize === 0
        ? `ุงููู (${totalItems})`
        : `ุตูุญุฉ ${departedPage} ูู ${totalPages} โ ุฅุฌูุงูู ${totalItems}`;
  }

  /* ===== ุชุตููุฑ ุชุญุฏูุฏ ุงููู ===== */
  const top = document.getElementById("departedSelectAllTop");
  const bot = document.getElementById("departedSelectAllBottom");
  if (top) top.checked = false;
  if (bot) bot.checked = false;
}

function restoreSelected() {

  // โ ููุฑุฃ ุงูุชุญุฏูุฏ ูู ุฌุฏูู ุงูุฃุณุฑ ุงููุบุงุฏุฑุฉ ูุจุงุดุฑุฉ
  const checkboxes = document.querySelectorAll(
    "#departedFamiliesSection tbody input[type='checkbox']:checked"
  );

  if (checkboxes.length === 0) {
    alert("ูุฑุฌู ุชุญุฏูุฏ ุฃุณุฑุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู");
    return;
  }

  const toRestoreIndexes = [];

  checkboxes.forEach(cb => {
    const index = parseInt(cb.dataset.index, 10);
    const family = (departedFamilies || [])[index];

    if (!family) return;

    // โ ููุน ุชูุฑุงุฑ ููุณ ุงูุฃุณุฑุฉ ุฏุงุฎู families ุญุณุจ ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ
    const existsInFamilies = (families || []).some(f => String(f?.id || "") === String(family.id || ""));
    if (!existsInFamilies) {
      family._searchMatch = true; // ุนูุดุงู ุชุธูุฑ ููุฑุงู ูู ุนุฑุถ ุงูุฃุณุฑ
      families.push(family);
    }

    toRestoreIndexes.push(index);
  });

  // โ ุญุฐู ูู ูุงุฆูุฉ ุงููุบุงุฏุฑูู ูู ุงูููุงูุฉ ููุจุฏุงูุฉ
  toRestoreIndexes
    .sort((a, b) => b - a)
    .forEach(i => departedFamilies.splice(i, 1));

  // โ ุญูุธ ุฏุงุฆู
  if (typeof saveToStorage === "function") saveToStorage();

  // โ ุชุญุฏูุซ ุงููุงุฌูุงุช ููุฑุงู
  if (typeof renderFamilies === "function") renderFamilies();
  if (typeof renderDeparted === "function") renderDeparted();

  alert("ุชูุช ุงุณุชุนุงุฏุฉ ุงูุฃุณุฑ ุงููุญุฏุฏุฉ โ");
}

/* ====== ุชุตุฏูุฑ ุงูุฃุณุฑ ุงููุญุฏุฏุฉ ====== */
function exportSelected() {
  exportFamiliesWithMode("selected");
}
function exportAllFamilies() {
  exportFamiliesWithMode("all");
}


/* ====== ุฏูุงู ุงูุฃุณุฑ ุงููุบุงุฏุฑุฉ ====== */

/* ===========================
   ุงูุฃุณุฑ ุงููุบุงุฏุฑุฉ: ุชุตุฏูุฑ/ุญุฐู (ูุชูุงูู ูุน ุงูุตูุญุงุช + ููุณ ุชูุณูู ุงูุชูุงุฑูุฑ)
   =========================== */

// โ ูุณุงุนุฏ: ูุฑุฌูุน ุนูุงุตุฑ ุงูุฃุณุฑ ุงููุบุงุฏุฑุฉ ุงููุญุฏุฏุฉ ูู ุงูุฌุฏูู (ูุฏุนู data-index ุฃู data-key)
function _getSelectedDepartedItems() {
  const cbs = Array.from(
    document.querySelectorAll('#departedFamiliesSection tbody input[type="checkbox"]:checked')
  );

  const picked = [];

  cbs.forEach(cb => {
    // 1) ูู ุนูุฏู data-index (ููููู Index ุญูููู ุฏุงุฎู departedFamilies)
    const idx = parseInt(cb.dataset.index || "", 10);
    if (Number.isFinite(idx) && departedFamilies && departedFamilies[idx]) {
      picked.push({ idx, f: departedFamilies[idx] });
      return;
    }

    // 2) ูู ุนูุฏู data-key (ูุซูุงู ุฑูู ุงููููุฉ)
    const key = String(cb.dataset.key || "").trim();
    if (key) {
      const realIdx = (departedFamilies || []).findIndex(x => String(x?.id || "").trim() === key);
      if (realIdx >= 0) picked.push({ idx: realIdx, f: departedFamilies[realIdx] });
    }
  });

  return picked;
}

function exportDepartedSelected() {
  if (!window.XLSX) { alert("ููุชุจุฉ Excel (XLSX) ุบูุฑ ูุญูููุฉ"); return; }

  const picked = _getSelectedDepartedItems();
  if (!picked.length) {
    alert("ูุฑุฌู ุชุญุฏูุฏ ุฃุณุฑุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู ููุชุตุฏูุฑ");
    return;
  }

  // โ ุงูุฃุนูุฏุฉ (ููุณ ูุธุงู ุนุฑุถ ุงูุฃุณุฑ + ูุถูู ุญููู ูููุฏุฉ ูู ููุฌูุฏุฉ)
  const fields = [
    { key: "no", label: "*" },
    { key: "name", label: "ุงุณู ุฑุจ ุงูุฃุณุฑุฉ (ุฑุจุงุนู)" },
    { key: "id", label: "ุฑูู ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "wife", label: "ุงุณู ุงูุฒูุฌุฉ" },
    { key: "wifeId", label: "ุฑูู ูููุฉ ุงูุฒูุฌุฉ" },
    { key: "phone", label: "ุฌูุงู" },
    { key: "totalCount", label: "ุงูุนุฏุฏ ุงูููู ููุฃูุฑุงุฏ" },
    { key: "originalResidence", label: "ุงูุณูู ุงูุฃุตูู" },
    { key: "currentResidence", label: "ุงูุณูู ุงูุญุงูู" },
    { key: "pregnant", label: "ุญูุงูู/ูุฑุถุนุงุช" },
    { key: "disease", label: "ุงูุฃูุฑุงุถ" },
    { key: "notes", label: "ููุงุญุธุงุช" }
  ];

  // โ ููุณ ุงูุชูุงุฑูุฑ: ููุงูู = ูู ุงูุญููู / ุฅูุบุงุก = ุงุฎุชูุงุฑ ุญููู
  const chosenRaw = _reportsPickFields(fields);
  if (!chosenRaw) { alert("ูู ูุชู ุงุฎุชูุงุฑ ุญููู ููุชุตุฏูุฑ"); return; }

  // โ ุงุฌุนู (*) ุฏุงุฆููุง ุฃูู ุนููุฏ (ูุซู ุงูุชูุงุฑูุฑ)
  const noField = fields.find(f => f.key === "no");
  const chosen = [noField, ...chosenRaw.filter(x => x && x.key !== "no")].filter(Boolean);

  // โ ุชุทุจูุน ุจุณูุท
  const normPregnant = (v) => {
    const s = String(v || "").trim();
    if (!s || s === "-" || s === "ูุง" || s === "ูุง ููุฌุฏ") return "ูุง";
    return s;
  };
  const normDisease = (v) => {
    const s = String(v || "").trim();
    if (!s || s === "-" || s === "ูุง" || s === "ูุง ููุฌุฏ") return "ูุง";
    return s;
  };

  const data = picked.map((it, i) => {
    const f = it.f || {};
    const row = {
      no: i + 1,
      name: f.name || "",
      id: f.id || "",
      wife: f.wife || "",
      wifeId: f.wifeId || "",
      phone: f.phone || "",
      totalCount: f.totalCount || "",
      originalResidence: f.originalResidence || "",
      currentResidence: f.currentResidence || "",
      pregnant: normPregnant(f.pregnant),
      disease: normDisease(f.disease),
      notes: f.notes || ""
    };

    const out = {};
    chosen.forEach(cf => out[cf.label] = row[cf.key] ?? "");
    return out;
  });

  // โ ููุณ ุชูุณูู ุงูุชูุงุฑูุฑ (RTL + ุชูููู + ุฎุทูุท + ุญุฏูุฏ) ูุฃููุง ุจูุณุชุฎุฏู ููุณ ุงูุฏุงูุฉ
  _reportsExportXlsx("ุงูุฃุณุฑ_ุงููุบุงุฏุฑุฉ", "ุงูุฃุณุฑ_ุงููุบุงุฏุฑุฉ.xlsx", data);
}

function deleteDepartedSelected() {
  const picked = _getSelectedDepartedItems();
  if (!picked.length) {
    alert("ูุฑุฌู ุชุญุฏูุฏ ุฃุณุฑุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู ููุญุฐู");
    return;
  }

  const count = picked.length;

  if (!confirm(`โ๏ธ ุณูุชู ุญุฐู ${count} ุฃุณุฑุฉ ููุงุฆููุง ููุง ูููู ุงุณุชุนุงุฏุชูุง.\n\nูู ุฃูุช ูุชุฃูุฏุ`)) {
    return;
  }

  const second = prompt("ุงูุชุจ ูููุฉ: ุญุฐู  ูุชุฃููุฏ ุงูุญุฐู ุงูููุงุฆู");
  if (String(second || "").trim() !== "ุญุฐู") {
    alert("ุชู ุฅูุบุงุก ุงูุญุฐู.");
    return;
  }

  // โ ุงุญุฐู ูู ุงูุฃูุจุฑ ููุฃุตุบุฑ (ุญุชู ูุง ุชุชุบูุฑ ุงูููุงุฑุณ)
  const indexes = picked.map(x => x.idx).filter(n => Number.isFinite(n));
  indexes.sort((a, b) => b - a).forEach(i => {
    departedFamilies.splice(i, 1);
  });

  if (typeof saveToStorage === "function") saveToStorage();
  if (typeof renderDeparted === "function") renderDeparted();

  alert("ุชู ุงูุญุฐู ุงูููุงุฆู โ");
}

/* ===========================
   ููุชุฑุฉ ุงูุจูุงูุงุช (ุตูุญุฉ ูุณุชููุฉ ูุงููุฉ)
   =========================== */

let lastFilterResults = [];

function ensureFilterPage() {
  const main = document.getElementById("mainContainer");
  if (!main) return null;

  // โ ุฅุฐุง ูุงูุช ุงูุตูุญุฉ ููุฌูุฏุฉุ ูุง ุชุนูุฏ ุจูุงุฆูุง ุฃุจุฏุงู
  let page = document.getElementById("filterPage");
  if (page) return page;

  // โ ุฃูุดุฆ ุงูุตูุญุฉ ูุฑุฉ ูุงุญุฏุฉ ููุท
  page = document.createElement("div");
  page.id = "filterPage";
  page.className = "hidden section";
  page.style.marginTop = "10px";

  page.innerHTML = `
    <h2 style="text-align:center;color:#0b5ed7;margin-bottom:10px;">ููุชุฑุฉ ุงูุจูุงูุงุช</h2>

    <div class="section" style="background:#f8f9fa">
      <label>ุจุญุซ ุนุงู</label>
      <input type="text" id="filterGeneral" placeholder="ุงุจุญุซ ุจุฃู ูููุฉ">

<!-- โ ููุชุฑุฉ ุงูุนุฏุฏ ุงูููู -->
<div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
  <input id="filterMinTotal" type="number" min="0" placeholder="ุงูุนุฏุฏ ุงูููู ูู" style="flex:1;min-width:140px;">
  <input id="filterMaxTotal" type="number" min="0" placeholder="ุงูุนุฏุฏ ุงูููู ุฅูู" style="flex:1;min-width:140px;">
</div>

      <label>ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ (ุงุฎุชุฑ ุฃูุซุฑ ูู ุฎูุงุฑ)</label>
      <div id="filterSocialBox"
           style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;
                  background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;">

        <label><input type="checkbox" class="filterSocialChk" value="ูุชุฒูุฌ"> ูุชุฒูุฌ / ูุฉ</label>
        <label><input type="checkbox" class="filterSocialChk" value="ุงุนุฒุจ"> ุฃุนุฒุจ / ุขูุณุฉ</label>
        <label><input type="checkbox" class="filterSocialChk" value="ุงุฑูู"> ุฃุฑูู / ูุฉ</label>
        <label><input type="checkbox" class="filterSocialChk" value="ููุฌูุฑุฉ"> ููุฌูุฑุฉ</label>
        <label><input type="checkbox" class="filterSocialChk" value="ูุทูู"> ูุทูู / ูุฉ</label>
        <label><input type="checkbox" class="filterSocialChk" value="ุฎูุงู"> ุฎูุงู ุฃุณุฑู</label>
        <label><input type="checkbox" class="filterSocialChk" value="ูุนูู"> ูุนูู / ูุฉ ุฃุณุฑุฉ</label>
      </div>

      <div style="margin-top:8px;display:flex;gap:10px;">
        <button type="button" onclick="filterSocialSelectAll(true)">ุชุญุฏูุฏ ุงููู</button>
        <button type="button" onclick="filterSocialSelectAll(false)" style="background:#6c757d;">ูุณุญ ุงูุชุญุฏูุฏ</button>
      </div>

      <label>ุงูุฌูุณ</label>
      <select id="filterGender">
        <option value="">ุงููู</option>
        <option value="ุฐูุฑ">ุฐูุฑ</option>
        <option value="ุงูุซู">ุฃูุซู</option>
      </select>

      <label>ุงุณู ุฑุจ ุงูุฃุณุฑุฉ</label>
      <input type="text" id="filterName" placeholder="ุจุญุซ ุจุงูุงุณู">

      <div style="display:flex;gap:10px;margin-top:12px;">
        <button onclick="applyFilter()">ุชุทุจูู ุงูููุชุฑุฉ</button>
        <button onclick="clearFilter()" style="background:#6c757d;">ูุณุญ ุงูููุชุฑุฉ</button>
      </div>
    </div>

    <div class="section">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
        <div>
          <b>ุนุฏุฏ ุงููุชุงุฆุฌ:</b> <span id="filterCount">0</span>
          <span id="filterShown" style="color:#666;"></span>
        </div>

        <div style="display:flex;gap:10px;align-items:center;">
          <select id="filterPageSize" onchange="applyFilter()">
            <option value="20">ุนุฑุถ 20</option>
            <option value="50">ุนุฑุถ 50</option>
            <option value="100">ุนุฑุถ 100</option>
            <option value="200">ุนุฑุถ 200</option>
            <option value="0">ุนุฑุถ ุงููู</option>
          </select>

          <button onclick="exportFilterResults()">ุชุตุฏูุฑ ุงููุญุฏุฏ ุฅูู Excel</button>
        </div>
      </div>

      <div id="filterPager" style="margin-top:10px;text-align:center;">
        <button onclick="filterPrevPage()">ุงูุณุงุจู</button>
        <span id="filterPageInfo" style="margin:0 10px;"></span>
        <button onclick="filterNextPage()">ุงูุชุงูู</button>
      </div>

      <table id="filterResultsTable" style="margin-top:10px;">
        <thead>
          <tr>
            <th><input type="checkbox" id="filterSelectAll"></th>
            <th>#</th>
            <th>ุงุณู ุฑุจ ุงูุฃุณุฑุฉ</th>
            <th>ุฑูู ุงููููุฉ</th>
            <th>ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ</th>
            <th>ุงูุนูุฑ</th>
            <th>ุงูุฌูุณ</th>
            <th>ุงูุฌูุงู</th>
            <th>ุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  `;

  main.appendChild(page);

  // Enter ูุทุจู ุงูููุชุฑุฉ ููุท ูู ุงูุญููู ุงููุตูุฉ
  page.querySelectorAll('input[type="text"]').forEach(inp => {
    inp.addEventListener("keydown", e => {
      if (e.key === "Enter") applyFilter();
    });
  });

  // ุชุญุฏูุฏ ุงููู
  const selectAll = page.querySelector("#filterSelectAll");
  if (selectAll) {
    selectAll.onchange = function () {
      const checked = this.checked;
      page.querySelectorAll("#filterResultsTable tbody input.filterRowCheck")
        .forEach(cb => cb.checked = checked);
    };
  }

  return page;
}

/* ููุงุญุธุฉ: ูุงุฒู hideAllSections ูุฎูู filterPage ุฃูุถุงู */
function showFilter() {
  ensureFilterPage();
  hideAllSections();

  const page = document.getElementById("filterPage");
  if (page) page.classList.remove("hidden");

  // โ ุงูุชุฑุงุถููุง: ุนุฑุถ ุฃูู ุตูุญุฉ ุญุณุจ pageSize (20)
  lastFilterResultsFull = (families || []).slice();
  filterPageIndex = 1;
  _renderFilterWithPaging();
}

function getSelectedSocialStatuses() {
  return Array.from(document.querySelectorAll("#filterPage .filterSocialChk:checked"))
    .map(cb => String(cb.value || "").trim())
    .filter(Boolean);
}

function filterSocialSelectAll(checked) {
  document.querySelectorAll("#filterPage .filterSocialChk").forEach(cb => cb.checked = checked);
}

// ===== Pagination: ููุชุฑุฉ ุงูุจูุงูุงุช =====
let filterPageIndex = 1;          // ุงูุตูุญุฉ ุงูุญุงููุฉ (1-based)
let lastFilterResultsFull = [];   // ูู ุงููุชุงุฆุฌ ุจุนุฏ ุงูููุชุฑุฉ

function _getFilterPageSize() {
  const v = String(document.getElementById("filterPageSize")?.value || "").trim();
  const n = parseInt(v, 10);
  if (!isNaN(n) && n > 0) return n;
  return 0; // 0 = ุนุฑุถ ุงููู
}

function _getFilterTotalPages(total, pageSize) {
  if (!pageSize) return 1;
  return Math.max(1, Math.ceil(total / pageSize));
}

function _renderFilterPageInfo(total, shown, page, pages) {
  const info = document.getElementById("filterPageInfo");
  const shownEl = document.getElementById("filterShown");
  if (shownEl) shownEl.textContent = total ? ` (ุงููุนุฑูุถ: ${shown})` : "";
  if (info) info.textContent = total ? `ุตูุญุฉ ${page} ูู ${pages}` : "";
}

function filterPrevPage() {
  const pageSize = _getFilterPageSize();
  const total = (lastFilterResultsFull || []).length;
  const pages = _getFilterTotalPages(total, pageSize);
  if (filterPageIndex > 1) filterPageIndex--;
  if (filterPageIndex > pages) filterPageIndex = pages;
  _renderFilterWithPaging();
}

function filterNextPage() {
  const pageSize = _getFilterPageSize();
  const total = (lastFilterResultsFull || []).length;
  const pages = _getFilterTotalPages(total, pageSize);
  if (filterPageIndex < pages) filterPageIndex++;
  _renderFilterWithPaging();
}

function _renderFilterWithPaging() {
  const pageSize = _getFilterPageSize();
  const total = (lastFilterResultsFull || []).length;

  const countEl = document.getElementById("filterCount");
  if (countEl) countEl.textContent = total;

  const pages = _getFilterTotalPages(total, pageSize);

  // ุชุฃูุฏ ุงูุตูุญุฉ ุถูู ุงููุฌุงู
  if (filterPageIndex < 1) filterPageIndex = 1;
  if (filterPageIndex > pages) filterPageIndex = pages;

  let view = lastFilterResultsFull;

  if (pageSize) {
    const start = (filterPageIndex - 1) * pageSize;
    view = lastFilterResultsFull.slice(start, start + pageSize);
  }

  _renderFilterPageInfo(total, view.length, filterPageIndex, pages);

  // โ ุงุฑุณู ุฌุฏูู ุงููุชุงุฆุฌ
 renderFilterResults(view);
}

function applyFilter() {
  ensureFilterPage();

  const socialSelected = getSelectedSocialStatuses();
  const page = document.getElementById("filterPage");

const general = (page?.querySelector("#filterGeneral")?.value || "").trim().toLowerCase();
const gender  = page?.querySelector("#filterGender")?.value || "";
const name    = (page?.querySelector("#filterName")?.value || "").trim().toLowerCase();

// โ ููุชุฑุฉ ุงูุนุฏุฏ ุงูููู
const minT = (page?.querySelector("#filterMinTotal")?.value ?? "").toString().trim();
const maxT = (page?.querySelector("#filterMaxTotal")?.value ?? "").toString().trim();
const hasTotalFilter = (minT !== "" || maxT !== "");
const minTotal = (minT === "") ? null : Number(minT);
const maxTotal = (maxT === "") ? null : Number(maxT);

  const results = families.filter(f => {
    let ok = true;

    if (general) {
      const txt = Object.values(f).join(" ").toLowerCase();
      if (!txt.includes(general)) ok = false;
    }
// โ ููุชุฑุฉ ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ (Checkboxes)
if (socialSelected.length) {
  const st = String(f?.socialStatus || "").trim();
  if (!socialSelected.includes(st)) ok = false;
}
    if (gender && f.gender !== gender) ok = false;
    if (name && !(f.name || "").toLowerCase().includes(name)) ok = false;

// โ ููุชุฑุฉ ุงูุนุฏุฏ ุงูููู
if (hasTotalFilter) {
  const tStr = String(f?.totalCount ?? "").trim();

  if (!tStr) {
    ok = false;
  } else {
    const t = Number(tStr);
    if (!Number.isFinite(t)) ok = false;
    if (minTotal !== null && t < minTotal) ok = false;
    if (maxTotal !== null && t > maxTotal) ok = false;
  }
}

    return ok;
  });

  lastFilterResultsFull = results;
filterPageIndex = 1;
_renderFilterWithPaging();
}

function clearFilter() {
  ensureFilterPage();

const g  = document.getElementById("filterGeneral");
const ge = document.getElementById("filterGender");
const n  = document.getElementById("filterName");

if (g) g.value = "";
if (ge) ge.value = "";
if (n) n.value = "";

// ูุณุญ ุชุญุฏูุฏ ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ
document.querySelectorAll("#filterPage .filterSocialChk")
  .forEach(cb => cb.checked = false);

  renderFilterResults(families);
}

function renderFilterResults(list) {
  ensureFilterPage();

  lastFilterResults = Array.isArray(list) ? list.slice() : [];

  const table = document.getElementById("filterResultsTable");
  const count = document.getElementById("filterCount");
  if (!table) return;

  const tbody = table.querySelector("tbody");
  tbody.innerHTML = "";

  if (count) count.textContent = String(lastFilterResults.length);

  const selectAll = document.getElementById("selectAll");
if (selectAll) {
  selectAll.addEventListener("change", function () {
    toggleSelectAllVisibleFamilies(this.checked);
  });
}

  if (lastFilterResults.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" style="color:#dc3545;font-weight:bold">
          ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุทุงุจูุฉ
        </td>
      </tr>
    `;
    return;
  }

  lastFilterResults.forEach((f, i) => {
    const safeId = String(f.id ?? "").replace(/'/g, "");
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td><input type="checkbox" class="filterRowCheck" data-id="${safeId}"></td>
      <td>${i + 1}</td>
      <td>${f.name || "-"}</td>
      <td>${f.id || "-"}</td>
      <td>${f.socialStatus || "-"}</td>
      <td>${f.age || "-"}</td>
      <td>${f.gender || "-"}</td>
      <td>${f.phone || "-"}</td>
      <td>
        <button class="action-btn" onclick="openFamilyById('${safeId}')">ูุชุญ / ุชุนุฏูู</button>
      </td>
    `;

    const rowCb = tr.querySelector("input.filterRowCheck");
    if (rowCb && selectAll) {
      rowCb.addEventListener("change", function () {
        if (!this.checked) selectAll.checked = false;
      });
    }

    tbody.appendChild(tr);
  });
}

// ุญุงูุฉ ุชุนุฏูู (ูู null ูุนูู ุญูุธ ุฌุฏูุฏ)
let editingFamilyIndex = null;

function openFamilyById(id) {
  const idx = families.findIndex(f => String(f.id) === String(id));
  if (idx === -1) {
    alert("ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุฃุณุฑุฉ");
    return;
  }

  ensureFamilyModal();
  renderFamilyModal(idx);
  document.getElementById("familyModal").classList.remove("hidden");
}

function ensureFamilyModal() {
  if (document.getElementById("familyModal")) return;

  const modal = document.createElement("div");
  modal.id = "familyModal";
  modal.className = "hidden";
  modal.innerHTML = `
    <div id="familyModalOverlay" style="
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:flex;align-items:center;justify-content:center;
      z-index:5000;padding:12px;
    ">
      <div style="
        width:min(650px,95vw);
        background:#fff;border-radius:12px;
        box-shadow:0 10px 30px rgba(0,0,0,.25);
        overflow:hidden;
      ">
        <div style="background:#0b5ed7;color:#fff;padding:12px 14px;font-weight:bold;">
          ุนุฑุถ ุจูุงูุงุช ุงูุฃุณุฑุฉ
        </div>

        <div id="familyModalBody" style="padding:14px;max-height:70vh;overflow:auto;"></div>

        <div style="display:flex;gap:10px;justify-content:flex-start;padding:12px 14px;background:#f4f6f8;">
          <button id="familyModalEditBtn" class="action-btn" style="width:auto;background:#198754;">ุชุนุฏูู</button>
          <button id="familyModalCloseBtn" class="action-btn" style="width:auto;background:#6c757d;">ุฅุบูุงู</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  // ุฅุบูุงู ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ
  document.getElementById("familyModalCloseBtn").onclick = function () {
    document.getElementById("familyModal").classList.add("hidden");
  };

  // ุฅุบูุงู ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌ ุงูุตูุฏูู
  document.getElementById("familyModalOverlay").addEventListener("click", function (e) {
    if (e.target.id === "familyModalOverlay") {
      document.getElementById("familyModal").classList.add("hidden");
    }
  });
}

function renderFamilyModal(index) {
  const f = families[index] || {};
  const body = document.getElementById("familyModalBody");

  // ุนุฑุถ ููุธู (ูุงุฆูุฉ)
  body.innerHTML = `
    <div class="section" style="margin:0;box-shadow:none;border:1px solid #e5e7eb;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div><b>ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ:</b> ${f.socialStatus || "-"}</div>
        <div><b>ุงุณู ุฑุจ ุงูุฃุณุฑุฉ:</b> ${f.name || "-"}</div>
        <div><b>ุฑูู ุงููููุฉ:</b> ${f.id || "-"}</div>
        <div><b>ุงูุนูุฑ:</b> ${f.age || "-"}</div>
        <div><b>ุงูุฌูุณ:</b> ${f.gender || "-"}</div>
        <div><b>ุงูุฌูุงู:</b> ${f.phone || "-"}</div>
        <div><b>ุงุณู ุงูุฒูุฌุฉ:</b> ${f.wife || "-"}</div>
        <div><b>ูููุฉ ุงูุฒูุฌุฉ:</b> ${f.wifeId || "-"}</div>
      </div>
    </div>
  `;

  // ุฒุฑ ุชุนุฏูู ุฏุงุฎู ุงูููุฏุงู
  document.getElementById("familyModalEditBtn").onclick = function () {
    startEditFamily(index);
    document.getElementById("familyModal").classList.add("hidden");
  };
}

function startEditFamily(index) {
  const f = families[index];
  if (!f) return;

  // โ ุชุญููู ุงูุฃุทูุงู ูู ุงููุณุฎ ุงููุฏููุฉ ุฅูู ุงูุตูุบุฉ ุงูุฌุฏูุฏุฉ (ูุฑุฉ ูุงุญุฏุฉ)
  if (Array.isArray(f.children) && f.children.length) {
    // ุฅุฐุง ูุงููุง strings
    if (typeof f.children[0] === "string") {
      f.children = f.children.map(n => ({
        name: String(n),
        childId: "",
        dob: "",
        gender: "",
        relation: "",
        note: ""
      }));
    }
    // ุฅุฐุง ูุงููุง objects ูุฏููุฉ ุจุฏูู ุงูููุงุชูุญ ุงูุฌุฏูุฏุฉ
    else if (typeof f.children[0] === "object") {
      f.children = f.children.map(c => ({
        name: c.name || c.childName || "",
        childId: c.childId || "",
        dob: c.dob || c.birthDate || "",
        gender: c.gender || "",
        relation: c.relation || "",
        note: c.note || ""
      }));
    }
  }


  // ุงุฏุฎู ูุถุน ุงูุชุนุฏูู
  editingFamilyIndex = index;

  // ุงูุชุญ ุตูุญุฉ ุฅุถุงูุฉ ุฃุณุฑุฉ
  showAddFamily();

// =========================
// 1) ุงูุญููู ุงูุฃุณุงุณูุฉ
// =========================
document.getElementById("socialStatus").value = f.socialStatus || "";
document.querySelector("#addFamilySection input:nth-of-type(1)").value = f.name || "";
document.querySelector("#addFamilySection input:nth-of-type(2)").value = f.id || "";
document.querySelector("#addFamilySection input:nth-of-type(3)").value = f.age || "";
document.getElementById("gender").value = f.gender || "";

// โ ุงูุฒูุฌุฉ (ุจุงูู IDs ุงูุฌุฏูุฏุฉ)
const wifeNameEl = document.getElementById("wifeNameInput");
const wifeIdEl   = document.getElementById("wifeIdInput");
const wifeAgeEl  = document.getElementById("wifeAgeInput");

if (wifeNameEl) wifeNameEl.value = f.wife || "";
if (wifeIdEl)   wifeIdEl.value   = f.wifeId || "";
if (wifeAgeEl)  wifeAgeEl.value  = f.wifeAge || "";

// =========================
  // โ ุชุนุจุฆุฉ ุนุฏุฏ ุงูุฃูุฑุงุฏ + ุฑุณู ุงูุฃุทูุงู ุนูุฏ ูุชุญ ุงูุชุนุฏูู
  // =========================
  const totalEl = document.getElementById("totalCount");
  const kids = Array.isArray(f.children) ? f.children : [];

  // base = 1 ุฃุนุฒุจ / 2 ูุชุฒูุฌ
  const base = (String(f.socialStatus || "").trim() === "ูุชุฒูุฌ") ? 2 : 1;

  // ุงุณุชุฎุฏู totalCount ุงููุฎุฒู ุฅู ูุฌุฏุ ูุฅูุง ุงุญุณุจู ูู ุงูุฃุทูุงู
  const totalVal = Number(f.totalCount) || (base + kids.length);

  if (totalEl) {
    totalEl.value = String(Math.max(base, totalVal));
    // ุฎูู generateChildren ูุดุชุบู (ูุฑุชุจุท ุนูู input)
    totalEl.dispatchEvent(new Event("input", { bubbles: true }));
  }

// ุจุนุฏ ูุง generateChildren ูุฑุณู ุงูุตูุงุฏููุ ุนุจูู ุจูุงูุงุช ุงูุฃุทูุงู
const cont = document.getElementById("childrenContainer");
if (cont && kids.length) {
  const boxes = cont.querySelectorAll(".child");
  boxes.forEach((box, i) => {
    const ch = kids[i] || {};
    const nameInp = box.querySelector(".childName") || box.querySelector('input[type="text"]');
    const idInp   = box.querySelector(".childId") || box.querySelector('input.childId');
    const dobInp  = box.querySelector(".childDob")  || box.querySelector('input[type="date"]');
    const genSel  = box.querySelector(".childGender") || box.querySelector('select');
    const relSel  = box.querySelector(".childRelation") || box.querySelectorAll('select')[1];

    if (nameInp) nameInp.value = ch.name || "";
    if (idInp)   idInp.value   = ch.childId || "";
    if (dobInp)  dobInp.value  = ch.dob  || "";
    if (genSel)  genSel.value  = ch.gender || "";
    if (relSel)  relSel.value  = ch.relation || "";
  });
}

// โ ุชุซุจูุช ุงูููู ุจุนุฏ ุฃู ุฅุนุงุฏุฉ ุฑุณู ูุชุฃุฎุฑุฉ (ุญู ููุงุฆู ููุดููุฉ ุงุฎุชูุงุก ุงููููุฉ)
setTimeout(() => {
  const cont2 = document.getElementById("childrenContainer");
  if (!cont2) return;

  const boxes2 = cont2.querySelectorAll(".child");
  boxes2.forEach((box, i) => {
    const ch = kids[i] || {};

    const nameInp = box.querySelector(".childName");
    const idInp   = box.querySelector(".childId");
    const dobInp  = box.querySelector(".childDob");
    const genSel  = box.querySelector(".childGender");
    const relSel  = box.querySelector(".childRelation");

    if (nameInp) nameInp.value = ch.name || "";
    if (idInp)   idInp.value   = ch.childId || "";   // โ ุงูููู
    if (dobInp)  dobInp.value  = ch.dob || "";
    if (genSel)  genSel.value  = ch.gender || "";
    if (relSel)  relSel.value  = ch.relation || "";
  });
}, 0);
  
  // =========================
  // 2) ุงูุณูู + ุงูุฌูุงู (ุจููุณ ููุทู saveFamily ุนูุฏู)
  // =========================
  try {
    const sections = Array.from(document.querySelectorAll("#addFamilySection .section"));
    const residenceSection = sections.find(sec => {
      const ins = sec.querySelectorAll("input");
      if (ins.length < 4) return false;
      const types = Array.from(ins).map(x => (x.getAttribute("type") || "text").toLowerCase());
      return types.includes("tel");
    });

    if (residenceSection) {
      const ins = residenceSection.querySelectorAll("input");
      // ุญุณุจ ุชุฑุชูุจู: ุฃุตููุ ุญุงููุ ุฌูุงูุ ุจุฏูู
      if (ins[0]) ins[0].value = f.originalResidence || "";
      if (ins[1]) ins[1].value = f.currentResidence || "";
      if (ins[2]) ins[2].value = f.phone || "";
    } else {
      // ุงุญุชูุงุท
      const phoneInput = document.querySelector('#addFamilySection input[type="tel"]');
      if (phoneInput) phoneInput.value = f.phone || "";
    }
  } catch (e) {
    console.warn("fill residence/phone failed", e);
  }

  // =========================
  // 3) totalCount + notes (ุฅุฐุง ููุฌูุฏูู)
  // =========================
  const totalCountEl = document.getElementById("totalCount");
  if (totalCountEl) totalCountEl.value = f.totalCount || "";

  const notesEl = document.getElementById("familyNotesInput");
if (notesEl) notesEl.value = f.notes || "";


// โ ููู: ุนูุฏ ูุชุญ ุงูุชุนุฏููุ ุนุจูู ุงููุงุฌูุฉ ูู ุงูุจูุงูุงุช ุงููุญููุธุฉ ูุจู ุฃู sync/ุฅุนุงุฏุฉ ุฑุณู
try {
  const kids = Array.isArray(f.children) ? f.children : [];
  if (typeof _renderChildrenUI === "function") _renderChildrenUI(kids);
} catch (e) {
  console.warn("prefill children before sync failed", e);
}

// =========================
// 4) ุงูุฃุทูุงู: ุชุนุจุฆุฉ childrenContainer
// FIX: ููุง ุชุฒูุฏ ุงูุนุฏุฏ ูุง ููุญุฐู ุงููุฏูู (ูุญูุธ ุงูููุชูุจ ูู ุงูุดุงุดุฉ ูุจู ุฅุนุงุฏุฉ ุงูุฑุณู)
// + ุชูุญูุฏ ุตูุฉ ุงููุฑุงุจุฉ: ุงุจู / ุฃุฎ / ุฃุฎุช
// + FIX: ูุง ูุชุนุงูู ูุน ุงููููุฉ ุงููุงุฑุบุฉ ูู 0 (ูุชุฌุงูููุง ุจุงููุงูู)
// =========================

/* โ (ุฃุถูู ูุฐุง ูุจู ูุฐุง ุงูุจููู ุฅู ูู ููู ููุฌูุฏ ุนูุฏู ูู ูุจู)
   ูุญูุธ ุงูุฃุทูุงู ูู ุงููุงุฌูุฉ ุฅูู f.children ูุจู ุฃู ุฅุนุงุฏุฉ ุฑุณู/ุชุบููุฑ ุนุฏุฏ */
function syncChildrenFromUI_toFamily(f){
  try{
    const cont = document.getElementById("childrenContainer");
    if (!cont || !f) return;

    const rows = cont.querySelectorAll(".child");
    if (!rows.length) return;

    const kids = [];
    rows.forEach(box => {
      const name    = box.querySelector(".childName")?.value ?? "";
const childId = box.querySelector(".childId")?.value ?? "";
      const dob  = box.querySelector(".childDob")?.value ?? "";
      let gender = box.querySelector(".childGender")?.value ?? "";
      let relation = box.querySelector(".childRelation")?.value ?? "";
      const note = box.querySelector(".childNote")?.value ?? "";

      gender = String(gender).trim();
      if (gender === "ุงูุซู") gender = "ุฃูุซู";

      relation = String(relation).trim();
      if (relation === "ุงุฎ") relation = "ุฃุฎ";
      if (relation === "ุงุฎุช") relation = "ุฃุฎุช";

kids.push({
  name: String(name).trim(),
  childId: String(childId).trim(),
  dob: String(dob).trim(),
  gender,
  relation,
  note: String(note).trim()
});
    });

    f.children = kids;
  }catch(e){
    console.warn("syncChildrenFromUI_toFamily failed", e);
  }
}

try {
  const cont = document.getElementById("childrenContainer");
  if (cont) {

    // โ 0) ูุจู ุฃู ุดูุก: ุซุจูุช ุงูููุชูุจ ุญุงููุงู ูู f.children (ุญุชู ูู ุงูุฏุงูุฉ ุงูุงุฏุช ุจุณุจุจ ุชุบููุฑ ุงูุนุฏุฏ)
    // ููุงุญุธุฉ: ูุฐุง ูุง ูุถุฑ ุฅุฐุง cont ูุงุถู
    if (typeof syncChildrenFromUI_toFamily === "function") {
      syncChildrenFromUI_toFamily(f);
    }

    // โ 1) ุงุญูุธ ุงูููุฌูุฏ ุงูุญุงูู ูู ุงููุงุฌูุฉ (ูุจู ูุง ูุนูู innerHTML = "")
    const uiKids = [];
    cont.querySelectorAll(".child").forEach(box => {
      const name = box.querySelector(".childName")?.value ?? "";
      const dob  = box.querySelector(".childDob")?.value ?? "";
      const gender = box.querySelector(".childGender")?.value ?? "";
      const relation = box.querySelector(".childRelation")?.value ?? "";
      const note = box.querySelector(".childNote")?.value ?? "";
const childId = box.querySelector(".childId")?.value ?? "";

      uiKids.push({
        name: String(name).trim(),
        dob: String(dob).trim(),
        gender: String(gender).trim(),
        relation: String(relation).trim(),
        note: String(note).trim()
      });
    });

    // โ 2) ุงูุฑุฃ ุงูุนุฏุฏ ุงููุทููุจ (ูู ุฎุงูุฉ ุนุฏุฏ ุงูุฃุทูุงู ุฅู ูุฌุฏุช)
    const kidsCountInput =
      document.getElementById("childrenCount") ||
      document.getElementById("familyChildrenCount") ||
      document.getElementById("totalChildren") ||
      document.getElementById("childCount") ||
      document.getElementById("kidsCount") ||
      document.getElementById("childrenNum");

    let desired = null;
    if (kidsCountInput) {
      const v = String(kidsCountInput.value ?? "").trim();

      // โ FIX: ูุง ุชุนุชุจุฑ ุงููุงุฑุบ = 0 (ูุชุฌุงููู ุจุงููุงูู)
      if (v !== "") {
        const n = Number(v);
        // โ ุจูุง ุงูู ููุช ูุณุชุญูู 0ุ ุฎููููุง >= 1
        if (Number.isFinite(n) && n >= 1) desired = Math.floor(n);
      }
    }

    // โ 3) ูุตุฏุฑ ุงูุจูุงูุงุช ุงูุฃุณุงุณู: ูู ููู ุดูุก ููุชูุจ ุจุงููุงุฌูุฉ ุฎุฐูุ ูุฅูุง ุฎุฐ f.children
    const kidsData = Array.isArray(f.children) ? f.children : [];
let baseKids = (uiKids.length ? uiKids : kidsData).map(k => ({
  name: k?.name ?? "",
  childId: k?.childId ?? "",
  dob: k?.dob ?? "",
  gender: k?.gender ?? "",
  relation: k?.relation ?? "",
  note: k?.note ?? ""
}));

    // โ 4) ุทุจูู ุงูุนุฏุฏ ุงููุทููุจ ุจุฏูู ูุง ุชุญุฐู ุงููุฏูู (ุฅูุง ุฅุฐุง ูููุช ุงูุนุฏุฏ)
    let finalKids = baseKids.slice();
    if (desired !== null) {
      if (finalKids.length < desired) {
        while (finalKids.length < desired) {
          finalKids.push({ name:"", dob:"", gender:"", relation:"", note:"" });
        }
      } else if (finalKids.length > desired) {
        finalKids = finalKids.slice(0, desired);
      }
    }

    // โ 5) ุงุฑุณู ุงููุงุฌูุฉ (ุชูุธูู ุงูุนุฑุถ ููุท)
    cont.innerHTML = "";

    const safe = (v) => String(v ?? "").replace(/"/g, "&quot;");

    // โ ุชูุญูุฏ ุตูุฉ ุงููุฑุงุจุฉ ููููู ุงููุฏููุฉ ุจุนุฏ ุงูุงุณุชูุฑุงุฏ
    function normalizeRelation(raw) {
      let r = String(raw ?? "").trim();
      if (!r || /^[0-9]+$/.test(r)) return "";

      // ุชูุญูุฏ ูุณููุงุช ูุฏููุฉ
      if (r === "ููุฏ" || r === "ุงุจู") return "ุงุจู";
      if (r === "ุงุฎ" || r === "ุฃุฎ") return "ุฃุฎ";
      if (r === "ุงุฎุช" || r === "ุฃุฎุช") return "ุฃุฎุช";

      // ุฃู ุดูุก ุซุงูู ูุฎููู ูุงุถู (ุญุณุจ ุทูุจู 3 ุฎูุงุฑุงุช ููุท)
      return "";
    }

finalKids.forEach((ch) => {
  const box = document.createElement("div");
  box.className = "child";
  box.style.cssText =
    "border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-top:10px;background:#fff;";

  // ุงุณู ุงูุทูู
  const l1 = document.createElement("label");
  l1.textContent = "ุงุณู ุงูุทูู";
  const inName = document.createElement("input");
  inName.type = "text";
  inName.className = "childName";
  inName.value = safe(ch?.name);

  // ูููุฉ ุงูุทูู
  const lId = document.createElement("label");
  lId.textContent = "ุฑูู ูููุฉ ุงูุทูู (ุงุฎุชูุงุฑู)";
  const inId = document.createElement("input");
  inId.type = "text";
  inId.className = "childId";
  inId.value = safe(ch?.childId);

  // ุชุงุฑูุฎ ุงููููุงุฏ
  const l2 = document.createElement("label");
  l2.textContent = "ุชุงุฑูุฎ ุงููููุงุฏ";
  const inDob = document.createElement("input");
  inDob.type = "date";
  inDob.className = "childDob";
  inDob.value = safe(ch?.dob);

  // ุงูุฌูุณ
  const l3 = document.createElement("label");
  l3.textContent = "ุงูุฌูุณ";
  const selG = document.createElement("select");
  selG.className = "childGender";
  selG.innerHTML = `
    <option value="">ุงุฎุชุฑ</option>
    <option value="ุฐูุฑ">ุฐูุฑ</option>
    <option value="ุฃูุซู">ุฃูุซู</option>
  `;

  // ุตูุฉ ุงููุฑุงุจุฉ
  const l4 = document.createElement("label");
  l4.textContent = "ุตูุฉ ุงููุฑุงุจุฉ";
  const selR = document.createElement("select");
  selR.className = "childRelation";
  selR.innerHTML = `
    <option value="">ุงุฎุชุฑ</option>
    <option value="ุงุจู">ุงุจู</option>
    <option value="ุฃุฎ">ุฃุฎ</option>
    <option value="ุฃุฎุช">ุฃุฎุช</option>
  `;

  // ููุงุญุธุฉ
  const l5 = document.createElement("label");
  l5.textContent = "ููุงุญุธุฉ (ุงุฎุชูุงุฑู)";
  const ta = document.createElement("textarea");
  ta.className = "childNote";
  ta.rows = 2;
  ta.placeholder = "ูุซุงู: ูุฏูู ุฅุนุงูุฉ / ูุญุชุงุฌ ุนูุงุฌ...";
  ta.value = safe(ch?.note);

  // ุถุจุท ุงูููู
  let g = String(ch?.gender ?? "").trim();
  if (g === "ุงูุซู") g = "ุฃูุซู";
  selG.value = g;

  const fixedRel = normalizeRelation(ch?.relation);
  selR.value = fixedRel;

  // ุชุฑููุจ
  box.append(l1, inName, lId, inId, l2, inDob, l3, selG, l4, selR, l5, ta);
  cont.appendChild(box);
});

    // โ 6) ุซุจูุช f.children ุจุงูููู ุงูุญุงููุฉ (ุนุดุงู ูุง ูุฑุฌุน ูุญุฐููุง ุนูุฏ ุฃู ุชุญุฏูุซ)
    if (Array.isArray(finalKids) && finalKids.length) f.children = finalKids;

  }
} catch (e) {
  console.warn("fill children failed", e);
}


  // =========================
  // 5) ุฅุธูุงุฑ/ุฅุฎูุงุก ุงูุฒูุฌุฉ
  // =========================
  const wifeBox = document.getElementById("wifeBox");
  if (wifeBox) {
    wifeBox.style.display = (document.getElementById("socialStatus").value === "ูุชุฒูุฌ") ? "block" : "none";
  }

// =========================
// (X) ุชุนุจุฆุฉ ุงูุญูุงูู/ุงููุฑุถุนุงุช ุนูุฏ ุงูุชุนุฏูู
// =========================
try {
  const sel = document.getElementById("pregnantSelect");
  const box = document.getElementById("pregnantBox");
  const pChk = document.getElementById("pregnantChk");
  const nChk = document.getElementById("nursingChk");

  const val = String(f.pregnant || "").trim();

  if (!sel) return;

  if (!val || val === "ูุง") {
    sel.value = "ูุง";
    if (box) box.classList.add("hidden");
    if (pChk) pChk.checked = false;
    if (nChk) nChk.checked = false;
  } else {
    sel.value = "ูุนู";
    if (box) box.classList.remove("hidden");

    // ุฏุนู ุงูููู ุงููุฏููุฉ ุญุชู ูู ูุงูุช "ุญุงูู(1)" ุฃู "ูุฑุถุนุฉ(2)"
    if (pChk) pChk.checked = val.includes("ุญุงูู");
    if (nChk) nChk.checked = val.includes("ูุฑุถุนุฉ");
  }
} catch (e) {
  console.warn("fill pregnant failed", e);
}

  // =========================
  // 6) ุบููุฑ ูุต ุฒุฑ ุงูุญูุธ + ุฒุฑ ุฅูุบุงุก
  // =========================
  const saveBtn = document.getElementById("saveFamilyBtn");
  if (saveBtn) saveBtn.textContent = "ุญูุธ ุงูุชุนุฏูู";

  let cancelBtn = document.getElementById("cancelEditBtn");
  if (!cancelBtn) {
    cancelBtn = document.createElement("button");
    cancelBtn.id = "cancelEditBtn";
    cancelBtn.textContent = "ุฅูุบุงุก ุงูุชุนุฏูู";
    cancelBtn.style.background = "#6c757d";

    cancelBtn.onclick = function () {
      editingFamilyIndex = null;

      // ุชูุฑูุบ ุงููููุฐุฌ
      document.querySelectorAll("#addFamilySection input").forEach(i => i.value = "");
      document.querySelectorAll("#addFamilySection select").forEach(s => s.value = "");

      const t = document.querySelector("#addFamilySection textarea");
      if (t) t.value = "";

      const cc = document.getElementById("childrenContainer");
      if (cc) cc.innerHTML = "";

      const b = document.getElementById("saveFamilyBtn");
      if (b) b.textContent = "ุญูุธ ุงูุฃุณุฑุฉ";

      cancelBtn.remove();
    };

// =========================
// โ ุชุนุจุฆุฉ ุงูุฃูุฑุงุถ ุนูุฏ ุงูุชุนุฏูู
// =========================
try {
  const noDisease = document.getElementById("noDisease");
  const otherDisease = document.getElementById("otherDisease");
  const otherDiseaseInput = document.getElementById("otherDiseaseInput");

  const val = String(f.disease || "").trim();

  if (!noDisease || !otherDisease || !otherDiseaseInput) return;

  // ุงูุณุญ ุฃููุงู
  noDisease.checked = false;
  otherDisease.checked = false;
  otherDiseaseInput.value = "";

  if (!val || val === "ูุง ููุฌุฏ") {
    noDisease.checked = true;
  } else {
    otherDisease.checked = true;
    // ูู ูุงูุช "ุฃูุฑุงุถ ุฃุฎุฑู" ุจุฏูู ูุต โ ุฎูููุง ูุงุถูุฉ
    otherDiseaseInput.value = (val === "ุฃูุฑุงุถ ุฃุฎุฑู") ? "" : val;
  }

  // ุดุบูู ููุณ ููุทู ุงูุฅุธูุงุฑ/ุงูุฅุฎูุงุก
  noDisease.dispatchEvent(new Event("change"));
  otherDisease.dispatchEvent(new Event("change"));
} catch (e) {
  console.warn("fill disease failed", e);
}

    // ุถุนู ุชุญุช ุฒุฑ ุงูุญูุธ ูุจุงุดุฑุฉ
    const addSection = document.getElementById("addFamilySection");
    if (addSection) addSection.appendChild(cancelBtn);
  }
}

function exportFilterResults() {
  if (!window.XLSX) { alert("ููุชุจุฉ Excel (XLSX) ุบูุฑ ูุญูููุฉ"); return; }

  // โ ุงููุตุฏุฑ: ูุชุงุฆุฌ ุงูููุชุฑุฉ ูุงููุฉ (ูุด ุจุณ ุงูุตูุญุฉ ุงููุนุฑูุถุฉ)
  const base = Array.isArray(lastFilterResultsFull) ? lastFilterResultsFull : [];

  if (!base.length) { alert("ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููุชุตุฏูุฑ"); return; }

  // โ ูุงุช ุงููุญุฏุฏ ูู ุงูุฌุฏูู (ุงูุธุงูุฑ)
  const selectedIds = Array.from(
    document.querySelectorAll("#filterResultsTable tbody input.filterRowCheck:checked")
  )
    .map(cb => String(cb.dataset.id || cb.dataset.key || "").trim())
    .filter(Boolean);

  // โ ุญุฏุฏ ูุงุฆูุฉ ุงูุชุตุฏูุฑ
  let exportList = base;

  if (selectedIds.length) {
    const set = new Set(selectedIds);
    // id ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ (ุญุณุจ ุจูุงูุงุชู)
    exportList = base.filter(f => set.has(String(f?.id || f?.familyId || "").trim()));
  } else {
    // ูู ูุง ูู ุชุญุฏูุฏ: ูุตุฏุฑ ูู ูุชุงุฆุฌ ุงูููุชุฑุฉ
    exportList = base;
  }

  if (!exportList.length) { alert("ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููุชุตุฏูุฑ"); return; }

  // โ ุญููู ุงูุชุตุฏูุฑ (ูุณูุนูุง ุญุณุจ ุงููู ุชุญุจู)
  const fields = [
    { key: "no", label: "*" },
    { key: "name", label: "ุงุณู ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "id", label: "ุฑูู ุงููููุฉ" },
    { key: "socialStatus", label: "ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ" },
    { key: "age", label: "ุงูุนูุฑ" },
    { key: "gender", label: "ุงูุฌูุณ" },
    { key: "wife", label: "ุงุณู ุงูุฒูุฌุฉ" },
    { key: "wifeId", label: "ุฑูู ูููุฉ ุงูุฒูุฌุฉ" },
    { key: "phone", label: "ุฑูู ุงูุฌูุงู" },
    { key: "originalResidence", label: "ุงูุณูู ุงูุฃุตูู" },
    { key: "currentResidence", label: "ุงูุณูู ุงูุญุงูู" },
    { key: "totalCount", label: "ุงูุนุฏุฏ ุงูุฅุฌูุงูู" },
    { key: "pregnant", label: "ุญุงูู/ูุฑุถุนุฉ" },
    { key: "disease", label: "ุงููุฑุถ/ุงูุฃูุฑุงุถ" },
    { key: "notes", label: "ููุงุญุธุงุช" }
  ];

  // โ ููุณ ูุธุงู ุงูุชูุงุฑูุฑ: ูุงูู ุฃู ุงุฎุชูุงุฑ ุญููู
  const chosenRaw = _reportsPickFields(fields);
  if (!chosenRaw) { alert("ูู ูุชู ุงุฎุชูุงุฑ ุญููู ููุชุตุฏูุฑ"); return; }

  // โ ุฎูู ุนููุฏ * ุฏุงูููุง ุฃูู ุฎูุงุฑ (ุฒู ุงูุชูุงุฑูุฑ)
  const noField = fields.find(f => f.key === "no");
  const chosen = [noField, ...chosenRaw.filter(x => x && x.key !== "no")].filter(Boolean);

  // โ ุฌููุฒ ุงูุจูุงูุงุช ููุชุตุฏูุฑ
  const data = exportList.map((f, idx) => {
    const row = {
      no: idx + 1,
      name: f?.name || "",
      id: f?.id || "",
      socialStatus: f?.socialStatus || "",
      age: f?.age || f?.fatherAge || "",
      gender: f?.gender || "",
      wife: f?.wife || f?.wifeName || "",
      wifeId: f?.wifeId || f?.wifeID || "",
      phone: f?.phone || "",
      originalResidence: f?.originalResidence || "",
      currentResidence: f?.currentResidence || "",
      totalCount: f?.totalCount || "",
      pregnant: f?.pregnant || "ูุง",
      disease: f?.disease || "ูุง",
      notes: f?.notes || ""
    };

    const out = {};
    chosen.forEach(cf => out[cf.label] = row[cf.key] ?? "");
    return out;
  });

  // โ ุชุตุฏูุฑ ูููู RTL Arial 14 (ุจุงุณุชุฎุฏุงู ุฏุงูุชู ุงูููุญุฏุฉ)
  _reportsExportXlsx(
    "ุงูููุชุฑุฉ",
    selectedIds.length ? "ูุชุงุฆุฌ_ุงูููุชุฑุฉ_ุงููุญุฏุฏ.xlsx" : "ูุชุงุฆุฌ_ุงูููุชุฑุฉ.xlsx",
    data
  );
}

/* ===========================
   ุตูุญุฉ ุงูุชูุงุฑูุฑ (ุฃุทูุงู + ุญูุงูู/ูุฑุถุนุงุช + ุฃูุฑุงุถ)
=========================== */

let lastReportsChildrenRows = [];

function ensureReportsPage() {
  let page = document.getElementById("reportsPage");
  if (page) return;

  page = document.createElement("div");
  page.id = "reportsPage";
  page.className = "hidden section";

  page.innerHTML = `
    <h3 style="margin-top:0;">ุงูุชูุงุฑูุฑ</h3>

<!-- โ ุชูุงุฑูุฑ ุงูุฃุทูุงู -->
<div class="section" style="box-shadow:none;border:1px solid #e5e7eb;">
  <h4 style="margin:0 0 10px;color:#0b5ed7;">ุชูุงุฑูุฑ ุงูุฃุทูุงู</h4>

  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <input id="repChildSearch"
           type="text"
           placeholder="ุจุญุซ (ุงุณู ุงูุทูู/ุงุณู ุฑุจ ุงูุฃุณุฑุฉ/ูููุฉ)"
           style="flex:2;min-width:220px;">

    <select id="repChildGender" style="flex:1;min-width:150px;">
      <option value="">ุงูุฌูุณ (ุงููู)</option>
      <option value="ุฐูุฑ">ุฐูุฑ</option>
      <option value="ุฃูุซู">ุฃูุซู</option>
    </select>

    <!-- โ ุงูุนูุฑ (ูู/ุฅูู) ุฌูุจ ุจุนุถ ูุจุญุฌู ุตุบูุฑ -->
    <div style="display:flex;gap:6px;align-items:center;flex:0 0 auto;">
      <input id="repChildMinAge" type="number" min="0" placeholder="ุงูุนูุฑ ูู"
             style="width:90px;min-width:90px;">
      <input id="repChildMaxAge" type="number" min="0" placeholder="ุงูุนูุฑ ุฅูู"
             style="width:90px;min-width:90px;">
    </div>

<!-- โ ุชุงุฑูุฎ ุงููููุงุฏ (ูู/ุฅูู) -->
<div style="display:flex;gap:6px;align-items:center;flex:0 0 auto;">
  <input id="repChildMinDob" type="date"
         placeholder="ุงููููุงุฏ ูู"
         style="width:160px;min-width:160px;">
  <input id="repChildMaxDob" type="date"
         placeholder="ุงููููุงุฏ ุฅูู"
         style="width:160px;min-width:160px;">
</div>

    <!-- โ ุนุฑุถ ุงููุชุงุฆุฌ -->
    <select id="repChildPageSize" style="flex:1;min-width:140px;">
      <option value="20">ุนุฑุถ 20</option>
      <option value="50">ุนุฑุถ 50</option>
      <option value="100">ุนุฑุถ 100</option>
      <option value="200">ุนุฑุถ 200</option>
      <option value="0">ุนุฑุถ ุงููู</option>
    </select>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
    <button onclick="applyReportsChildren()" style="width:auto;flex:1;min-width:140px;">ุชุทุจูู</button>

    <button onclick="resetReportsChildren()" style="width:auto;flex:1;min-width:140px;background:#6c757d;">
      ูุณุญ
    </button>

    <button onclick="exportReportsChildrenSelected()" style="width:auto;flex:1;min-width:180px;background:#0b5ed7;">
      ุชุตุฏูุฑ ุงููุญุฏุฏ
    </button>

    <button onclick="exportReportsChildrenAll()" style="width:auto;flex:1;min-width:180px;background:#198754;">
      ุชุตุฏูุฑ ุงููู
    </button>
  </div>
</div>

  <div id="repChildSummary" style="margin-top:10px;color:#444;font-size:13px;"></div>

  <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
    <label style="margin:0;">
      <input type="checkbox" id="repChildSelectAllTop" onchange="toggleAllReportsChildren(this.checked)"> ุชุญุฏูุฏ ุงููู
    </label>
    <div id="repChildCount" style="font-size:13px;color:#555;"></div>
  </div>

<table id="repChildrenTable" style="margin-top:10px;">
  <thead>
    <tr>
      <th style="width:40px;"></th>
      <th>#</th>
      <th>ุงุณู ุงูุทูู</th>
      <th>ูููุฉ ุงูุทูู</th>
      <th>ุชุงุฑูุฎ ุงููููุงุฏ</th>
      <th>ุงูุนูุฑ</th>
      <th>ุงูุฌูุณ</th>
      <th>ุตูุฉ ุงููุฑุงุจุฉ</th>
      <th>ุงุณู ุฑุจ ุงูุฃุณุฑุฉ</th>
      <th>ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ</th>
      <th>ููุงุญุธุฉ ุงูุทูู</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  <!-- โ ุฌุฏูุฏ: ุงูุตูุญุงุช -->
  <div id="repChildPagination" style="margin-top:10px;text-align:center;"></div>

  <div style="margin-top:10px;text-align:center;">
    <label style="margin:0;">
      <input type="checkbox" id="repChildSelectAllBottom" onchange="toggleAllReportsChildren(this.checked)"> ุชุญุฏูุฏ ุงููู
    </label>
  </div>
</div>


<!-- โ ุชูุงุฑูุฑ ุงูุญูุงูู/ุงููุฑุถุนุงุช (ุจุญุซ + ูุฑุจุนุงุช + ุชุตุฏูุฑ ุงููุญุฏุฏ/ุงููู) -->
<div class="section" style="box-shadow:none;border:1px solid #e5e7eb;">
  <h4 style="margin:0 0 10px;color:#0b5ed7;">ุชูุงุฑูุฑ ุงูุญูุงูู / ุงููุฑุถุนุงุช</h4>

  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <input id="repPregSearch"
           type="text"
           placeholder="ุจุญุซ (ุงุณู/ูููุฉ/ุฌูุงู/ุญุงูุฉ)"
           style="flex:2;min-width:220px;"
           oninput="applyReportsPregnant()">

    <select id="repPregType"
            style="flex:1;min-width:160px;"
            onchange="applyReportsPregnant()">
      <option value="">ุงููู</option>
      <option value="ุญุงูู">ุญุงูู</option>
      <option value="ูุฑุถุนุฉ">ูุฑุถุนุฉ</option>
    </select>

    <!-- โ ุนุฑุถ ุงููุชุงุฆุฌ -->
    <select id="repPregPageSize"
            style="flex:1;min-width:140px;"
            onchange="applyReportsPregnant()">
      <option value="10">ุนุฑุถ 10</option>
      <option value="20" selected>ุนุฑุถ 20</option>
      <option value="50">ุนุฑุถ 50</option>
      <option value="100">ุนุฑุถ 100</option>
      <option value="200">ุนุฑุถ 200</option>
      <option value="0">ุนุฑุถ ุงููู</option>
    </select>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
    <button onclick="renderReportsPregnant()" style="width:auto;flex:1;min-width:140px;">ุชุญุฏูุซ</button>
    <button onclick="exportReportsPregnantSelected()" style="width:auto;flex:1;min-width:200px;background:#198754;">
      ุชุตุฏูุฑ ุงููุญุฏุฏ / ุงููู
    </button>
  </div>

  <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
    <label style="margin:0;">
      <input type="checkbox" id="repPregSelectAllTop" onchange="toggleAllReportsPregnant(this.checked)"> ุชุญุฏูุฏ ุงููู
    </label>
    <div id="repPregnantCount" style="font-size:13px;color:#555;"></div>
  </div>

  <div id="repPregnantSummary" style="margin-top:6px;color:#444;font-size:13px;"></div>

  <table id="repPregnantTable" style="margin-top:10px;">
    <thead>
      <tr>
        <th style="width:40px;"></th>
        <th>#</th>
        <th>ุงุณู ุฑุจ ุงูุฃุณุฑุฉ</th>
        <th>ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ</th>
        <th>ุงูุฌูุงู</th>
        <th>ุงูุญุงูุฉ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- โ ุงูุตูุญุงุช -->
  <div id="repPregPagination" style="margin-top:10px;text-align:center;"></div>

  <div style="margin-top:10px;text-align:center;">
    <label style="margin:0;">
      <input type="checkbox" id="repPregSelectAllBottom" onchange="toggleAllReportsPregnant(this.checked)"> ุชุญุฏูุฏ ุงููู
    </label>
  </div>
</div>

<!-- โ ุชูุงุฑูุฑ ุงูุฃูุฑุงุถ (ุจุญุซ + ูุฑุจุนุงุช + ุชุตุฏูุฑ ุงููุญุฏุฏ/ุงููู) -->
<div class="section" style="box-shadow:none;border:1px solid #e5e7eb;">
  <h4 style="margin:0 0 10px;color:#0b5ed7;">ุชูุงุฑูุฑ ุงูุฃูุฑุงุถ</h4>

  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <input id="repDisSearch" type="text" placeholder="ุจุญุซ (ุงุณู/ูููุฉ/ุฌูุงู/ูุฑุถ)" style="flex:2;min-width:220px;">
    <input id="repDisKeyword" type="text" placeholder="ูููุฉ ุฏุงุฎู ุงูุฃูุฑุงุถ (ุงุฎุชูุงุฑู)" style="flex:1;min-width:160px;">

    <!-- โ ุฌุฏูุฏ: ุนุฑุถ ุงููุชุงุฆุฌ -->
    <select id="repDisPageSize" style="flex:1;min-width:140px;">
      <option value="20">ุนุฑุถ 20</option>
      <option value="50">ุนุฑุถ 50</option>
      <option value="100">ุนุฑุถ 100</option>
      <option value="200">ุนุฑุถ 200</option>
      <option value="0">ุนุฑุถ ุงููู</option>
    </select>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
    <button onclick="applyReportsDisease()" style="width:auto;flex:1;min-width:140px;">ุชุทุจูู</button>

    <button onclick="resetReportsDisease()" style="width:auto;flex:1;min-width:140px;background:#6c757d;">
      ูุณุญ
    </button>

    <button onclick="exportReportsDiseaseSelected()" style="width:auto;flex:1;min-width:200px;background:#198754;">
      ุชุตุฏูุฑ ุงููุญุฏุฏ / ุงููู
    </button>
  </div>

  <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
    <label style="margin:0;">
      <input type="checkbox" id="repDisSelectAllTop" onchange="toggleAllReportsDisease(this.checked)"> ุชุญุฏูุฏ ุงููู
    </label>
    <div id="repDiseaseCount" style="font-size:13px;color:#555;"></div>
  </div>

  <div id="repDiseaseSummary" style="margin-top:6px;color:#444;font-size:13px;"></div>

  <table id="repDiseaseTable" style="margin-top:10px;">
    <thead>
      <tr>
        <th style="width:40px;"></th>
        <th>#</th>
        <th>ุงุณู ุฑุจ ุงูุฃุณุฑุฉ</th>
        <th>ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ</th>
        <th>ุงูุฌูุงู</th>
        <th>ุงูุฃูุฑุงุถ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- โ ุฌุฏูุฏ: ุงูุตูุญุงุช -->
  <div id="repDisPagination" style="margin-top:10px;text-align:center;"></div>

  <div style="margin-top:10px;text-align:center;">
    <label style="margin:0;">
      <input type="checkbox" id="repDisSelectAllBottom" onchange="toggleAllReportsDisease(this.checked)"> ุชุญุฏูุฏ ุงููู
    </label>
  </div>
</div>
  `;

  document.getElementById("mainContainer").appendChild(page);

  // ุจุญุซ ูุจุงุดุฑ ููุฃุทูุงู
  const search = page.querySelector("#repChildSearch");
  if (search) search.addEventListener("input", applyReportsChildren);
}

function showReports() {
  // 1) ุชุฃูุฏ ุฃู ุตูุญุฉ ุงูุชูุงุฑูุฑ ููุฌูุฏุฉ (ูู ุฏุงูุชู ููุฌูุฏุฉ)
  if (typeof ensureReportsPage === "function") {
    try { ensureReportsPage(); } catch (e) { console.error("ensureReportsPage error", e); }
  }

  // 2) ุฃุฎูู ูู ุงูุฃูุณุงู
  if (typeof hideAllSections === "function") hideAllSections();

  // 3) ุฃุธูุฑ ุตูุญุฉ ุงูุชูุงุฑูุฑ (ุจุงูู id ุงูุตุญูุญ ุนูุฏู)
  const page = document.getElementById("reportsPage");
  if (!page) {
    alert("ุตูุญุฉ ุงูุชูุงุฑูุฑ ุบูุฑ ููุฌูุฏุฉ: reportsPage");
    return;
  }
  page.classList.remove("hidden");

  // 4) ุงุฑุณู ุงูุชูุงุฑูุฑ ุจุฏูู ูุง ูุทูุญ ุงูุชุทุจูู ูู ุฏุงูุฉ ูููุง ุฎุทุฃ
  if (typeof renderReportsAll === "function") {
    try { renderReportsAll(); } catch (e) { console.error("renderReportsAll error", e); }
  }
}

function renderReportsAll() {
  // โ ุฃุทูุงู
  try {
    if (typeof renderReportsChildren === "function") renderReportsChildren();
  } catch (e) {
    console.error("children report error", e);
  }

  // โ ุญูุงูู/ูุฑุถุนุงุช (ุญุชู ูู ุงูุฏุงูุฉ ูุด ููุฌูุฏุฉ ุณุงุจูุงู)
  try {
    if (typeof renderReportsPregnant === "function") renderReportsPregnant();
  } catch (e) {
    console.error("pregnant report error", e);
  }

  // โ ุฃูุฑุงุถ (ุญุชู ูู ุงูุฏุงูุฉ ูุด ููุฌูุฏุฉ ุณุงุจูุงู)
  try {
    if (typeof renderReportsDisease === "function") renderReportsDisease();
  } catch (e) {
    console.error("disease report error", e);
  }
}


/* ---------- ุชูุงุฑูุฑ ุงูุฃุทูุงู ---------- */

var repChildCurrentPage = 1;
var lastReportsChildrenRowsView = [];

function buildReportsChildrenRows() {
  const rows = [];

  (families || []).forEach((f) => {
    const famName = String(f?.name || "");
    const famId   = String(f?.id || "");

    const kids = Array.isArray(f.children) ? f.children : [];
    kids.forEach((c, idx) => {
      const childName     = String(c?.name || "");
      const childId      = String(c?.childId || "");
      const childDob      = String(c?.dob || "");   // โ ุชุงุฑูุฎ ุงููููุงุฏ
      const childAge      = c?.age;                 // ูุฎููู ููุง ูู (0 ูุณููุญ)
      const childGender   = String(c?.gender || "");
      const childRelation = String(c?.relation || "");
      const childNote     = String(c?.note ?? "").trim(); // โ ููุงุญุธุฉ ุงูุทูู

      rows.push({
        _key: `${famId || "noid"}_${idx}`,
        childName,
         childId, 
        childDob,
        childAge,
        childGender,
        childRelation,
        childNote,
        familyName: famName,
        familyId: famId,

        // โ ูุต ุงูุจุญุซ (ุฎููู ุจุณูุท ุนุดุงู ูุง ูุนููู)
        _searchText: [
  childName,
  childId,                 // โ ูููุฉ ุงูุทูู
  childDob,
  String(childAge ?? ""),
  childGender,
  childRelation,
  childNote,
  famName,
  famId
].join(" ").toLowerCase()
      });
    });
  });

  rows.sort((a, b) =>
    String(a.childName || "").localeCompare(String(b.childName || ""), "ar")
  );
  return rows;
}

// ===== Page Size =====
function _getRepChildPageSize() {
  const v = String(document.getElementById("repChildPageSize")?.value || "20").trim();
  const n = parseInt(v, 10);
  if (!isNaN(n) && n >= 0) return n; // 0 = ุนุฑุถ ุงููู
  return 20;
}

function _getRepChildTotalPages(totalCount) {
  const pageSize = _getRepChildPageSize();
  if (pageSize === 0) return 1;
  return Math.max(1, Math.ceil(totalCount / pageSize));
}

function _clampRepChildPage(totalCount) {
  const totalPages = _getRepChildTotalPages(totalCount);
  if (repChildCurrentPage < 1) repChildCurrentPage = 1;
  if (repChildCurrentPage > totalPages) repChildCurrentPage = totalPages;
  return totalPages;
}

function _getRepChildView(list) {
  const pageSize = _getRepChildPageSize();
  if (pageSize === 0) return list; // ุนุฑุถ ุงููู
  const start = (repChildCurrentPage - 1) * pageSize;
  const end = start + pageSize;
  return list.slice(start, end);
}

function repChildGoPage(p) {
  repChildCurrentPage = p;
  applyReportsChildren();
}

function renderRepChildPagination(totalCount) {
  const box = document.getElementById("repChildPagination");
  if (!box) return;

  const pageSize = _getRepChildPageSize();
  if (pageSize === 0) { box.innerHTML = ""; return; } // ุนุฑุถ ุงููู => ุจุฏูู ุตูุญุงุช

  const totalPages = _clampRepChildPage(totalCount);
  if (totalPages <= 1) { box.innerHTML = ""; return; }

  const cur = repChildCurrentPage;

  // ูุงูุฐุฉ ุตูุญุงุช ุตุบูุฑุฉ (ุญุชู ูุง ูุทูู)
  const win = 7;
  let start = Math.max(1, cur - Math.floor(win / 2));
  let end = start + win - 1;
  if (end > totalPages) { end = totalPages; start = Math.max(1, end - win + 1); }

  let html = `
    <button onclick="repChildGoPage(${Math.max(1, cur - 1)})" style="margin:2px;padding:4px 10px;">ุงูุณุงุจู</button>
  `;

  if (start > 1) {
    html += `<button onclick="repChildGoPage(1)" style="margin:2px;padding:4px 10px;">1</button>`;
    if (start > 2) html += `<span style="margin:0 6px;color:#666;">โฆ</span>`;
  }

  for (let i = start; i <= end; i++) {
    html += `<button onclick="repChildGoPage(${i})"
                    style="margin:2px;padding:4px 10px;${i === cur ? "background:#0b5ed7;color:#fff;" : ""}">
              ${i}
            </button>`;
  }

  if (end < totalPages) {
    if (end < totalPages - 1) html += `<span style="margin:0 6px;color:#666;">โฆ</span>`;
    html += `<button onclick="repChildGoPage(${totalPages})" style="margin:2px;padding:4px 10px;">${totalPages}</button>`;
  }

  html += `
    <button onclick="repChildGoPage(${Math.min(totalPages, cur + 1)})" style="margin:2px;padding:4px 10px;">ุงูุชุงูู</button>
  `;

  box.innerHTML = html;
}

function applyReportsChildren() {
  const q = (document.getElementById("repChildSearch")?.value || "").trim().toLowerCase();
  const g = (document.getElementById("repChildGender")?.value || "").trim();

  const minA = (document.getElementById("repChildMinAge")?.value ?? "").toString().trim();
  const maxA = (document.getElementById("repChildMaxAge")?.value ?? "").toString().trim();

  // โ ุชุงุฑูุฎ ุงููููุงุฏ (ูู/ุฅูู) โ ูุงุฒู ุชููู ุฃุถูุช inputs: repChildMinDob / repChildMaxDob
  const minDob = (document.getElementById("repChildMinDob")?.value ?? "").toString().trim();
  const maxDob = (document.getElementById("repChildMaxDob")?.value ?? "").toString().trim();

  let list = buildReportsChildrenRows();

  // โ ุจุญุซ ูุตู ุดุงูู
  if (q) {
    list = list.filter(r => String(r?._searchText || "").includes(q));
  }

  // โ ููุชุฑุฉ ุงูุฌูุณ
  if (g) {
    list = list.filter(r =>
      String(r.childGender || "") === g || (g === "ุฃูุซู" && r.childGender === "ุงูุซู")
    );
  }

  // โ ููุชุฑุฉ ุงูุนูุฑ ููุท ุฅุฐุง ุงููุณุชุฎุฏู ูุชุจ min ุฃู max (0 ูุณููุญ)
  const hasAgeFilter = (minA !== "" || maxA !== "");
  const min = (minA === "") ? null : Number(minA);
  const max = (maxA === "") ? null : Number(maxA);

  if (hasAgeFilter) {
    list = list.filter(r => {
      const aStr = String(r.childAge ?? "").trim();

      // โ ููุท ุงููุงุฑุบ ููุฑูุถ
      if (aStr === "") return false;

      const a = Number(aStr);
      if (!Number.isFinite(a)) return false;

      if (min !== null && Number.isFinite(min) && a < min) return false;
      if (max !== null && Number.isFinite(max) && a > max) return false;

      return true;
    });
  }

  // โ ููุชุฑุฉ ุชุงุฑูุฎ ุงููููุงุฏ (YYYY-MM-DD) โ ููุท ุฅุฐุง ุงููุณุชุฎุฏู ูุชุจ ูู ุฃู ุฅูู
  const hasDobFilter = (minDob !== "" || maxDob !== "");

  function dobToNum(s) {
    const m = String(s || "").trim().match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return null;
    const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
    if (!Number.isFinite(y) || !Number.isFinite(mo) || !Number.isFinite(d)) return null;
    return (y * 10000) + (mo * 100) + d; // YYYYMMDD
  }

  if (hasDobFilter) {
    const minN = (minDob === "") ? null : dobToNum(minDob);
    const maxN = (maxDob === "") ? null : dobToNum(maxDob);

    list = list.filter(r => {
      const dobN = dobToNum(r?.childDob);
      if (dobN === null) return false; // ุจุฏูู DOB ูุง ููุฑ ุจููุชุฑ ุงูุชุงุฑูุฎ

      if (minN !== null && dobN < minN) return false;
      if (maxN !== null && dobN > maxN) return false;
      return true;
    });
  }

  // โ ุงููุงุฆูุฉ ุงููุงููุฉ ููุชุตุฏูุฑ
  lastReportsChildrenRows = list;

  // โ ุตูุญุงุช + ุนุฑุถ ุงููุชุงุฆุฌ
  const totalPages = _clampRepChildPage(list.length);
  const view = _getRepChildView(list);
  lastReportsChildrenRowsView = view;

  // offset ููุชุฑููู ุงูุตุญูุญ
  const pageSize = _getRepChildPageSize();
  const offset = (pageSize === 0) ? 0 : (repChildCurrentPage - 1) * pageSize;

  renderReportsChildrenTable(view, offset);
  renderReportsChildrenSummary(list, view, totalPages);
  renderRepChildPagination(list.length);
}

function resetReportsChildren() {
  const s = document.getElementById("repChildSearch");
  const g = document.getElementById("repChildGender");
  const min = document.getElementById("repChildMinAge");
  const max = document.getElementById("repChildMaxAge");
  const d1 = document.getElementById("repChildMinDob");
  const d2 = document.getElementById("repChildMaxDob");
  const ps = document.getElementById("repChildPageSize");

  if (s) s.value = "";
  if (g) g.value = "";
  if (min) min.value = "";
  if (max) max.value = "";
  if (d1) d1.value = "";
  if (d2) d2.value = "";
  if (ps) ps.value = "20";

  repChildCurrentPage = 1;
  renderReportsChildren();
}

function renderReportsChildrenSummary(fullList, viewList, totalPages) {
  const summary = document.getElementById("repChildSummary");
  const countEl = document.getElementById("repChildCount");

  const total = (fullList || []).length;
  const shown = (viewList || []).length;

  const pageSize = _getRepChildPageSize();
  const pagesTxt = (pageSize === 0) ? "" : ` โ ุตูุญุฉ ${repChildCurrentPage} ูู ${totalPages}`;

  if (countEl) countEl.textContent = `ุนุฏุฏ ุงููุชุงุฆุฌ: ${total} (ุงููุนุฑูุถ: ${shown})${pagesTxt}`;

  if (!summary) return;

  const male = fullList.filter(x => x.childGender === "ุฐูุฑ").length;
  const female = fullList.filter(x => x.childGender === "ุฃูุซู" || x.childGender === "ุงูุซู").length;

  const ages = fullList.map(x => Number(x.childAge)).filter(x => !Number.isNaN(x));
  const avg = ages.length ? (ages.reduce((a,b)=>a+b,0) / ages.length).toFixed(1) : "-";

  summary.innerHTML = `
    <b>ููุฎุต:</b>
    ุฅุฌูุงูู ุงูุฃุทูุงู: <b>${total}</b> โ ุฐููุฑ: <b>${male}</b> โ ุฅูุงุซ: <b>${female}</b> โ ูุชูุณุท ุงูุนูุฑ: <b>${avg}</b>
  `;
}

function renderReportsChildrenTable(list, offset = 0) {
  const tbody = document.querySelector("#repChildrenTable tbody");
  if (!tbody) return;

  tbody.innerHTML = "";
  list.forEach((r, i) => {
    const tr = document.createElement("tr");

    const ageCell =
      (r.childAge === 0 || r.childAge === "0") ? "0" :
      (r.childAge ?? "-");

    tr.innerHTML = `
      <td><input class="repChildRowCheck" type="checkbox" data-key="${r._key}"></td>
      <td>${offset + i + 1}</td>

      <td>${r.childName || "-"}</td>
      <td>${r.childId || "-"}</td>
      <td>${(r.childDob && String(r.childDob).trim()) ? r.childDob : "-"}</td>
      <td>${ageCell}</td>
      <td>${r.childGender || "-"}</td>
      <td>${r.childRelation || "-"}</td>

      <td>${r.familyName || "-"}</td>
      <td>${r.familyId || "-"}</td>

      <td>${(r.childNote && String(r.childNote).trim()) ? r.childNote : "-"}</td>
    `;
    tbody.appendChild(tr);
  });

  const top = document.getElementById("repChildSelectAllTop");
  const bot = document.getElementById("repChildSelectAllBottom");
  if (top) top.checked = false;
  if (bot) bot.checked = false;
}

/* ===========================
   ุชูุงุฑูุฑ: ุชุตุฏูุฑ ูุน ุงุฎุชูุงุฑ ุงูุญููู (ููุณุน)
   - ุฅุฐุง ููู ุชุญุฏูุฏ: ูุตุฏูุฑ ุงููุญุฏุฏ
   - ุฅุฐุง ูุง ููู ุชุญุฏูุฏ: ูุตุฏูุฑ ุงููู
   - ูุจู ุงูุชุตุฏูุฑ: ูุณุฃู (ูุงูู / ุญููู ูุนููุฉ)
   =========================== */

function _reportsAskExportMode(fieldsListText) {
  return confirm(
    "ุทุฑููุฉ ุงูุชุตุฏูุฑ:\n\n" +
    "โ ุงุถุบุท (ููุงูู) ูุชุตุฏูุฑ ูู ุงูุญููู.\n" +
    "โ๏ธ ุงุถุบุท (ุฅูุบุงุก) ูุงุฎุชูุงุฑ ุญููู ูุนููุฉ.\n\n" +
    fieldsListText
  );
}

function _reportsPickFields(fields) {
  const listText = fields.map((f, i) => `${i + 1}) ${f.label}`).join("\n");
  const full = _reportsAskExportMode(listText);

  if (full) return fields;

  const choice = prompt(
    "ุงูุชุจ ุฃุฑูุงู ุงูุญููู ุงููุทููุจ ุชุตุฏูุฑูุง ููุตููุฉ ุจููุงุตู (ูุซุงู: 1,2,6)\n\n" + listText
  );

  if (!choice) return null;

  const idxs = choice
    .split(",")
    .map(s => parseInt(s.trim(), 10))
    .filter(n => Number.isFinite(n) && n >= 1 && n <= fields.length);

  if (!idxs.length) return null;

  const uniq = Array.from(new Set(idxs));
  return uniq.map(i => fields[i - 1]);
}

function _reportsExportXlsx(sheetName, fileName, rowsObjects) {
  if (!window.XLSX) { alert("ููุชุจุฉ Excel (XLSX) ุบูุฑ ูุญูููุฉ"); return; }
  if (!rowsObjects || !rowsObjects.length) { alert("ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููุชุตุฏูุฑ"); return; }

  // 1) ุฃูุดุฆ ุดูุช ูู ุงูุจูุงูุงุช
  const ws = XLSX.utils.json_to_sheet(rowsObjects, { skipHeader: false });

  // 2) RTL
  ws["!view"] = [{ rightToLeft: true }];

  // 3) ุฃููุงู ARGB
  const HEADER_BG = "FF2F3E4E"; // ููู ุงูููุฏุฑ (ููุณ ุงูุตูุฑุฉ ุชูุฑูุจูุง)
  const WHITE     = "FFFFFFFF";
  const BLACK     = "FF000000";
  const BORDER    = "FFCBD5E1";

  const borderAll = {
    top:    { style: "thin", color: { rgb: BORDER } },
    bottom: { style: "thin", color: { rgb: BORDER } },
    left:   { style: "thin", color: { rgb: BORDER } },
    right:  { style: "thin", color: { rgb: BORDER } }
  };

  const headerStyle = {
    font: { name: "Arial", sz: 14, bold: true, color: { rgb: WHITE } },
    alignment: { horizontal: "right", vertical: "center" },
    fill: { fgColor: { rgb: HEADER_BG } },
    border: borderAll
  };

  const firstColStyle = {
    font: { name: "Arial", sz: 14, bold: true, color: { rgb: WHITE } },
    alignment: { horizontal: "center", vertical: "center" },
    fill: { fgColor: { rgb: HEADER_BG } },
    border: borderAll
  };

  const normalStyle = {
    font: { name: "Arial", sz: 14, color: { rgb: BLACK } },
    alignment: { horizontal: "right", vertical: "center" },
    border: borderAll
  };

  // 4) ุทุจูู ุงูุณุชุงูู ุนูู ูุงูู ุงูุฌุฏูู
  const ref = ws["!ref"];
  if (ref) {
    const range = XLSX.utils.decode_range(ref);

    for (let r = range.s.r; r <= range.e.r; r++) {
      for (let c = range.s.c; c <= range.e.c; c++) {
        const addr = XLSX.utils.encode_cell({ r, c });
        const cell = ws[addr];
        if (!cell) continue;

        if (r === range.s.r) cell.s = headerStyle;         // ุตู ุงูุนูุงููู
        else if (c === range.s.c) cell.s = firstColStyle;  // ุฃูู ุนููุฏ (*)
        else cell.s = normalStyle;                         // ุจุงูู ุงูุฎูุงูุง
      }
    }
  }

  // 5) ุนุฑุถ ุฃุนูุฏุฉ (ุงุฎุชูุงุฑู)
  const headers = Object.keys(rowsObjects[0] || {});
  ws["!cols"] = headers.map(h => {
    let wch = Math.max(10, String(h).length + 2);
    rowsObjects.forEach(row => {
      const v = row[h] ?? "";
      wch = Math.min(60, Math.max(wch, String(v).length + 2));
    });
    return { wch };
  });

  // 6) ุงุญูุธ ุงูููู
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, sheetName);
  XLSX.writeFile(wb, fileName);
}

/* ===========================
   1) ุชุตุฏูุฑ ุงูุญูุงูู/ุงููุฑุถุนุงุช (ููุณุน)
   =========================== */
function exportReportsPregnantExcel() {
  if (!window.XLSX) {
    alert("ููุชุจุฉ Excel (XLSX) ุบูุฑ ูุญูููุฉ");
    return;
  }

  const rows = (families || []).filter(f => {
    const v = String(f?.pregnant || "").trim();
    return v && v !== "ูุง";
  });

  if (!rows.length) {
    alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ุญูุงูู/ูุฑุถุนุงุช ููุชุตุฏูุฑ");
    return;
  }

  const fields = [
    { key: "no", label: "*" },
    { key: "name", label: "ุงุณู ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "id", label: "ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "phone", label: "ุฑูู ุงูุฌูุงู" },
    { key: "originalResidence", label: "ุงูุณูู ุงูุฃุตูู" },
    { key: "currentResidence", label: "ุงูุณูู ุงูุญุงูู" },
    { key: "totalCount", label: "ุงูุนุฏุฏ ุงูุฅุฌูุงูู" },
    { key: "wife", label: "ุงุณู ุงูุฒูุฌุฉ" },
    { key: "wifeId", label: "ูููุฉ ุงูุฒูุฌุฉ" },
    { key: "socialStatus", label: "ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ" },
    { key: "age", label: "ุนูุฑ ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "gender", label: "ุฌูุณ ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "pregnant", label: "ุงูุญุงูุฉ (ุญุงูู/ูุฑุถุนุฉ)" },
    { key: "notes", label: "ููุงุญุธุงุช" }
  ];

  const chosen = _reportsPickFields(fields);
  if (!chosen) { alert("ูู ูุชู ุงุฎุชูุงุฑ ุญููู ููุชุตุฏูุฑ"); return; }

  const data = rows.map((f, i) => {
    const row = {
      no: i + 1,
      name: f?.name || "",
      id: f?.id || "",
      phone: f?.phone || "",
      originalResidence: f?.originalResidence || "",
      currentResidence: f?.currentResidence || "",
      totalCount: f?.totalCount || "",
      wife: f?.wife || "",
      wifeId: f?.wifeId || "",
      socialStatus: f?.socialStatus || "",
      age: f?.age || "",
      gender: f?.gender || "",
      pregnant: (String(f?.pregnant || "").trim() ? f.pregnant : "ูุง"),
      notes: f?.notes || ""
    };

    const out = {};
    chosen.forEach(cf => out[cf.label] = row[cf.key] ?? "");
    return out;
  });

  _reportsExportXlsx("ุญูุงูู_ูุฑุถุนุงุช", "ุชูุฑูุฑ_ุญูุงูู_ููุฑุถุนุงุช.xlsx", data);
}

/* ===========================
   2) ุชุตุฏูุฑ ุงูุฃูุฑุงุถ (ููุณุน)
   =========================== */
function exportReportsDiseaseExcel() {
  if (!window.XLSX) {
    alert("ููุชุจุฉ Excel (XLSX) ุบูุฑ ูุญูููุฉ");
    return;
  }

  const rows = (families || []).filter(f => String(f?.disease || "").trim());
  if (!rows.length) {
    alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃูุฑุงุถ ููุชุตุฏูุฑ");
    return;
  }

  const fields = [
    { key: "no", label: "*" },
    { key: "name", label: "ุงุณู ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "id", label: "ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "phone", label: "ุฑูู ุงูุฌูุงู" },
    { key: "originalResidence", label: "ุงูุณูู ุงูุฃุตูู" },
    { key: "currentResidence", label: "ุงูุณูู ุงูุญุงูู" },
    { key: "totalCount", label: "ุงูุนุฏุฏ ุงูุฅุฌูุงูู" },
    { key: "wife", label: "ุงุณู ุงูุฒูุฌุฉ" },
    { key: "wifeId", label: "ูููุฉ ุงูุฒูุฌุฉ" },
    { key: "socialStatus", label: "ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ" },
    { key: "age", label: "ุนูุฑ ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "gender", label: "ุฌูุณ ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "disease", label: "ุงูุฃูุฑุงุถ" },
    { key: "notes", label: "ููุงุญุธุงุช" }
  ];

  const chosen = _reportsPickFields(fields);
  if (!chosen) { alert("ูู ูุชู ุงุฎุชูุงุฑ ุญููู ููุชุตุฏูุฑ"); return; }

  const data = rows.map((f, i) => {
    const row = {
      no: i + 1,
      name: f?.name || "",
      id: f?.id || "",
      phone: f?.phone || "",
      originalResidence: f?.originalResidence || "",
      currentResidence: f?.currentResidence || "",
      totalCount: f?.totalCount || "",
      wife: f?.wife || "",
      wifeId: f?.wifeId || "",
      socialStatus: f?.socialStatus || "",
      age: f?.age || "",
      gender: f?.gender || "",
      disease: (String(f?.disease || "").trim() ? f.disease : "ูุง"),
      notes: f?.notes || ""
    };

    const out = {};
    chosen.forEach(cf => out[cf.label] = row[cf.key] ?? "");
    return out;
  });

  _reportsExportXlsx("ุงูุฃูุฑุงุถ", "ุชูุฑูุฑ_ุงูุฃูุฑุงุถ.xlsx", data);
}


/* ===========================
   3) ุชุตุฏูุฑ ุงูุฃุทูุงู (ููุณุน) - ูุณุฎุฉ ููุณููุฉ
   - ูุถูู ุนููุฏ (*) ุฃูู ุนููุฏ ุฏุงุฆููุง
   - ูุถูู ุชุฑุชูุจ ุงูุฃุนูุฏุฉ (Insertion Order)
   - โ ุฅุถุงูุฉ ุชุงุฑูุฎ ุงููููุงุฏ ุถูู ุงูุญููู (childDob)
   =========================== */

function exportReportsChildrenSelected() {
  if (!window.XLSX) { alert("ููุชุจุฉ Excel (XLSX) ุบูุฑ ูุญูููุฉ"); return; }

  const selectedKeys = Array.from(
    document.querySelectorAll("#repChildrenTable tbody input.repChildRowCheck:checked")
  ).map(cb => String(cb.dataset.key));

  const exportList = selectedKeys.length
    ? (lastReportsChildrenRows || []).filter(r => selectedKeys.includes(String(r._key)))
    : (lastReportsChildrenRows || []);

  if (!exportList.length) { alert("ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููุชุตุฏูุฑ"); return; }

  const fields = [
  { key: "no", label: "*" },          //ุชุฑููู
  
{ key: "childName", label: "ุงุณู ุงูุทูู" },

// โ ูููุฉ ุงูุทูู (ุฌุฏูุฏ)
{ key: "childId", label: "ูููุฉ ุงูุทูู" },

// โ ุชุงุฑูุฎ ุงููููุงุฏ
{ key: "childDob", label: "ุชุงุฑูุฎ ุงููููุงุฏ" },

    { key: "childAge", label: "ุงูุนูุฑ" },
    { key: "childGender", label: "ุงูุฌูุณ" },
    { key: "childRelation", label: "ุตูุฉ ุงููุฑุงุจุฉ" },

    // โ ููุงุญุธุฉ ุงูุทูู
    { key: "childNote", label: "ููุงุญุธุฉ ุงูุทูู" },

    { key: "familyName", label: "ุงุณู ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "familyId", label: "ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "wife", label: "ุงุณู ุงูุฒูุฌุฉ" },
    { key: "wifeId", label: "ูููุฉ ุงูุฒูุฌุฉ" },
    { key: "familyPhone", label: "ุฑูู ุงูุฌูุงู" },
    { key: "originalResidence", label: "ุงูุณูู ุงูุฃุตูู" },
    { key: "currentResidence", label: "ุงูุณูู ุงูุญุงูู" },
    { key: "totalCount", label: "ุงูุนุฏุฏ ุงูุฅุฌูุงูู" },

    // โ ููุงุญุธุงุช ุงูุฃุณุฑุฉ ุงูุนุงูุฉ (ููุชุงุญ ููุญูุฏ)
    { key: "familyNotes", label: "ููุงุญุธุงุช ุงูุฃุณุฑุฉ" }
  ];

  const chosenRaw = _reportsPickFields(fields);
  if (!chosenRaw) { alert("ูู ูุชู ุงุฎุชูุงุฑ ุญููู ููุชุตุฏูุฑ"); return; }

  // โ ุถูุงู ุฃู (*) ุฃูู ุนููุฏ ุฏุงุฆููุง ุญุชู ูู ุงููุณุชุฎุฏู ูุง ุงุฎุชุงุฑู
  const noField = fields.find(f => f.key === "no");
  const chosen = [
    noField,
    ...chosenRaw.filter(cf => cf && cf.key !== "no")
  ].filter(Boolean);

  const data = exportList.map((r, i) => {
    const fam = (families || []).find(f => String(f?.id || "") === String(r?.familyId || "")) || null;

    // โ ููุฑุฃ DOB ูู ุตู ุงูุชูุฑูุฑ ููุณู (r.childDob)
    // ููู ูุงุถู ูุฃู ุณุจุจุ ูุฑุฌูุน ูุงุถู ุจุฏูู ุชุฎุฑูุจ
    const row = {
      no: i + 1,
      childName: r?.childName || "",
      childId: r?.childId || "",
      childDob: r?.childDob || "",   // โ ุฌุฏูุฏ
      childAge: r?.childAge || "",
      childGender: r?.childGender || "",
      childRelation: r?.childRelation || "",
      childNote: r?.childNote || "",

      familyName: r?.familyName || "",
      familyId: r?.familyId || "",
      wife: fam?.wife || "",
      wifeId: fam?.wifeId || "",
      familyPhone: fam?.phone || "",
      originalResidence: fam?.originalResidence || "",
      currentResidence: fam?.currentResidence || "",
      totalCount: fam?.totalCount || "",

      // โ ููุงุญุธุงุช ุงูุฃุณุฑุฉ ุงูุนุงูุฉ
      familyNotes: fam?.notes || ""
    };

    // โ ูุญุงูุธ ุนูู ุชุฑุชูุจ ุงูุฃุนูุฏุฉ ุญุณุจ chosen
    const out = {};
    chosen.forEach(cf => {
      out[cf.label] = row[cf.key] ?? "";
    });
    return out;
  });

  _reportsExportXlsx("ุงูุฃุทูุงู", "ุชูุฑูุฑ_ุงูุฃุทูุงู.xlsx", data);
}


function exportReportsChildrenAll() {
  if (!window.XLSX) { alert("ููุชุจุฉ Excel (XLSX) ุบูุฑ ูุญูููุฉ"); return; }

  const exportList = lastReportsChildrenRows || [];
  if (!exportList.length) { alert("ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููุชุตุฏูุฑ"); return; }

  const fields = [
    { key: "no", label: "*" },
    { key: "childName", label: "ุงุณู ุงูุทูู" },
    { key: "childAge", label: "ุงูุนูุฑ" },
    { key: "childGender", label: "ุงูุฌูุณ" },
    { key: "childRelation", label: "ุตูุฉ ุงููุฑุงุจุฉ" },

    // โ ููุงุญุธุฉ ุงูุทูู
    { key: "childNote", label: "ููุงุญุธุฉ ุงูุทูู" },

    { key: "familyName", label: "ุงุณู ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "familyId", label: "ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "wife", label: "ุงุณู ุงูุฒูุฌุฉ" },
    { key: "wifeId", label: "ูููุฉ ุงูุฒูุฌุฉ" },
    { key: "familyPhone", label: "ุฑูู ุงูุฌูุงู" },
    { key: "originalResidence", label: "ุงูุณูู ุงูุฃุตูู" },
    { key: "currentResidence", label: "ุงูุณูู ุงูุญุงูู" },
    { key: "totalCount", label: "ุงูุนุฏุฏ ุงูุฅุฌูุงูู" },

    // โ ููุงุญุธุงุช ุงูุฃุณุฑุฉ ุงูุนุงูุฉ (ูู ูููุฐุฌ ุงูุฃุณุฑุฉ)
    { key: "familyNotes", label: "ููุงุญุธุงุช ุงูุฃุณุฑุฉ" }
  ];

  const chosenRaw = _reportsPickFields(fields);
  if (!chosenRaw) { alert("ูู ูุชู ุงุฎุชูุงุฑ ุญููู ููุชุตุฏูุฑ"); return; }

  const noField = fields.find(f => f.key === "no");
  const chosen = [ noField, ...chosenRaw.filter(cf => cf && cf.key !== "no") ].filter(Boolean);

  const data = exportList.map((r, i) => {
    const fam = (families || []).find(f => String(f?.id || "") === String(r?.familyId || "")) || null;

const row = {
  no: i + 1,
  childName: r?.childName || "",
  childId: r?.childId || "",      // โ ุฃุถู ูุฐุง
  childDob: r?.childDob || "",    // โ ูุฃุถู ูุฐุง
  childAge: r?.childAge || "",
  childGender: r?.childGender || "",
  childRelation: r?.childRelation || "",

  // โ ููุงุญุธุฉ ุงูุทูู ูู ุงูุชูุฑูุฑ ููุณู
  childNote: r?.childNote || "",

  familyName: r?.familyName || "",
  familyId: r?.familyId || "",
  wife: fam?.wife || "",
  wifeId: fam?.wifeId || "",
  familyPhone: fam?.phone || "",
  originalResidence: fam?.originalResidence || "",
  currentResidence: fam?.currentResidence || "",
  totalCount: fam?.totalCount || "",

      // โ ููุงุญุธุงุช ุงูุฃุณุฑุฉ ุงูุนุงูุฉ ูู ุณุฌู ุงูุฃุณุฑุฉ
      familyNotes: fam?.notes || ""
    };

    const out = {};
    chosen.forEach(cf => { out[cf.label] = row[cf.key] ?? ""; });
    return out;
  });

  _reportsExportXlsx("ุงูุฃุทูุงู", "ุชูุฑูุฑ_ุงูุฃุทูุงู_ูุงูู.xlsx", data);
}

/* ===========================
   ุชูุงุฑูุฑ ุงูุญูุงูู/ุงููุฑุถุนุงุช (ุจุญุซ + ุนุฑุถ + ุตูุญุงุช + ุชุตุฏูุฑ)
   =========================== */

var lastReportsPregnantRowsFull = [];
var lastReportsPregnantRowsView = [];
var repPregCurrentPage = 1;

/* ---------- ุจูุงุก ุงูุตููู ---------- */
function buildReportsPregnantRows() {
  const rows = [];

  (families || []).forEach(f => {
    const pv = String(f?.pregnant || "").trim();
    if (!pv || pv === "ูุง") return;

    rows.push({
      _key: String(f?.id || "") || ("noid_" + Math.random()),
      no: 0,
      familyName: f?.name || "",
      familyId: f?.id || "",
      familyPhone: f?.phone || "",
      wife: f?.wife || f?.wifeName || "",
      wifeId: f?.wifeId || "",
      pregnantStatus: pv || "ูุง",
      notes: f?.notes || ""
    });
  });

  rows.sort((a, b) =>
    String(a.familyName).localeCompare(String(b.familyName), "ar", { sensitivity: "base" })
  );

  rows.forEach((r, i) => r.no = i + 1);
  return rows;
}

/* ---------- ุฃุฏูุงุช ---------- */
function _normStatus(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/\s+/g, "")
    .replace(/[()๏ผ๏ผ]/g, "")
    .replace(/[0-9ู-ูฉ]/g, "");
}

function _rowMatchesPregType(r, mode) {
  const s = _normStatus(r?.pregnantStatus);
  const hasPregnant  = s.includes("ุญุงูู");
  const hasLactating = s.includes("ูุฑุถุนุฉ") || s.includes("ูุฑุถุนู") || s.includes("ูุฑุถุน");

  if (mode === "ุญุงูู")   return hasPregnant;
  if (mode === "ูุฑุถุนุฉ") return hasLactating;
  return true;
}

function _getRepPregPageSize() {
  const v = document.getElementById("repPregPageSize")?.value || "20";
  const n = parseInt(v, 10);
  if (!isNaN(n) && n >= 0) return n; // 0 = ุงููู
  return 20;
}

function _getTotalPages(count) {
  const size = _getRepPregPageSize();
  if (size === 0) return 1;
  return Math.max(1, Math.ceil(count / size));
}

function _getView(list) {
  const size = _getRepPregPageSize();
  if (size === 0) return list;

  const start = (repPregCurrentPage - 1) * size;
  return list.slice(start, start + size);
}

/* ---------- Render ---------- */
function renderReportsPregnant() {
  repPregCurrentPage = 1;
  const full = buildReportsPregnantRows();
  lastReportsPregnantRowsFull = full;

  const view = _getView(full);
  lastReportsPregnantRowsView = view;

  renderReportsPregnantTable(view, 0);
  renderReportsPregnantSummary(full, view);
  renderRepPregPagination(full.length);
}

function applyReportsPregnant() {
  const q = (document.getElementById("repPregSearch")?.value || "").trim().toLowerCase();
  const mode = document.getElementById("repPregType")?.value || "";

  let list = buildReportsPregnantRows();

  if (mode) list = list.filter(r => _rowMatchesPregType(r, mode));

  if (q) {
    list = list.filter(r =>
      (`${r.familyName} ${r.familyId} ${r.familyPhone} ${r.pregnantStatus} ${r.wife} ${r.wifeId}`)
        .toLowerCase()
        .includes(q)
    );
  }

  lastReportsPregnantRowsFull = list;

  const totalPages = _getTotalPages(list.length);
  if (repPregCurrentPage > totalPages) repPregCurrentPage = totalPages;

  const view = _getView(list);
  lastReportsPregnantRowsView = view;

  const offset = _getRepPregPageSize() === 0 ? 0 : (repPregCurrentPage - 1) * _getRepPregPageSize();

  renderReportsPregnantTable(view, offset);
  renderReportsPregnantSummary(list, view);
  renderRepPregPagination(list.length);
}

/* ---------- Summary ---------- */
function renderReportsPregnantSummary(full, view) {
  const c = document.getElementById("repPregnantCount");
  if (c) c.textContent = `ุนุฏุฏ ุงููุชุงุฆุฌ: ${full.length} (ุงููุนุฑูุถ: ${view.length})`;
}

/* ---------- Table ---------- */
function renderReportsPregnantTable(list, offset = 0) {
  const tbody = document.querySelector("#repPregnantTable tbody");
  if (!tbody) return;

  tbody.innerHTML = "";

  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:12px;color:#666;">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</td></tr>`;
    return;
  }

  list.forEach((r, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" class="repPregRowCheck" data-key="${r._key}"></td>
      <td>${offset + i + 1}</td>
      <td>${r.familyName}</td>
      <td>${r.familyId}</td>
      <td>${r.familyPhone}</td>
      <td>${r.pregnantStatus}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------- Pagination ---------- */
function repPregGoPage(p) {
  repPregCurrentPage = p;
  applyReportsPregnant();
}

function renderRepPregPagination(total) {
  const box = document.getElementById("repPregPagination");
  if (!box) return;

  const size = _getRepPregPageSize();
  if (size === 0) { box.innerHTML = ""; return; }

  const pages = _getTotalPages(total);
  if (pages <= 1) { box.innerHTML = ""; return; }

  let html = `<button onclick="repPregGoPage(${Math.max(1, repPregCurrentPage - 1)})">ุงูุณุงุจู</button>`;

  for (let i = 1; i <= pages; i++) {
    html += `<button onclick="repPregGoPage(${i})"
      style="${i === repPregCurrentPage ? 'background:#0b5ed7;color:#fff;' : ''}">
      ${i}
    </button>`;
  }

  html += `<button onclick="repPregGoPage(${Math.min(pages, repPregCurrentPage + 1)})">ุงูุชุงูู</button>`;
  box.innerHTML = html;
}

/* ---------- ุชุญุฏูุฏ ุงููู ---------- */
function toggleAllReportsPregnant(ch) {
  document.querySelectorAll(".repPregRowCheck").forEach(cb => cb.checked = ch);
}

/* ===========================
   ุชุตุฏูุฑ ุชูุงุฑูุฑ ุงูุญูุงูู/ุงููุฑุถุนุงุช (ูุญุฏุฏ/ุงููู)
   - ููุงูู: ุชุตุฏูุฑ ูู ุงูุญููู
   - ุฅูุบุงุก: ุงุฎุชูุงุฑ ุญููู ููุชุตุฏูุฑ
   - ูุถูู ุนููุฏ (*) ุฃูู ุนููุฏ ุฏุงุฆููุง
   =========================== */

function exportReportsPregnantSelected() {
  if (!window.XLSX) { alert("ููุชุจุฉ Excel (XLSX) ุบูุฑ ูุญูููุฉ"); return; }

  // โ ุฎุฐ ุงููุญุฏุฏ ูู ุงูุฌุฏูู
  const selectedIds = Array.from(
    document.querySelectorAll("#repPregTable tbody input.repPregRowCheck:checked")
  ).map(cb => String(cb.dataset.id || "").trim()).filter(Boolean);

  // โ ูุงุฆูุฉ ุงูุชุตุฏูุฑ
  const base = (lastReportsPregnantRowsFull || []);
  const exportList = selectedIds.length
    ? base.filter(r => selectedIds.includes(String(r.familyId || "").trim()))
    : base;

  if (!exportList.length) { alert("ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููุชุตุฏูุฑ"); return; }

  // โ ุงูุญููู ุงููุชุงุญุฉ (ูููุง)
  const fields = [
    { key: "no", label: "*" },

    { key: "familyName", label: "ุงุณู ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "familyId", label: "ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "familyPhone", label: "ุฑูู ุงูุฌูุงู" },

    { key: "wife", label: "ุงุณู ุงูุฒูุฌุฉ" },
    { key: "wifeId", label: "ูููุฉ ุงูุฒูุฌุฉ" },
    { key: "wifeAge", label: "ุนูุฑ ุงูุฒูุฌุฉ" },

    { key: "socialStatus", label: "ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ" },
    { key: "gender", label: "ุฌูุณ ุฑุจ ุงูุฃุณุฑุฉ" },

    { key: "pregnantStatus", label: "ุญุงูู/ูุฑุถุนุฉ" },

    { key: "originalResidence", label: "ุงูุณูู ุงูุฃุตูู" },
    { key: "currentResidence", label: "ุงูุณูู ุงูุญุงูู" },
    { key: "totalCount", label: "ุงูุนุฏุฏ ุงูุฅุฌูุงูู" },

    { key: "notes", label: "ููุงุญุธุงุช ุงูุฃุณุฑุฉ" }
  ];

  // โ ููุงูู = ูู ุงูุญููู / ุฅูุบุงุก = ุงุฎุชูุงุฑ ุญููู
  const exportAllFields = confirm(
    "ุชุตุฏูุฑ ุชูุงุฑูุฑ ุงูุญูุงูู/ุงููุฑุถุนุงุช:\n\nููุงูู: ุชุตุฏูุฑ ูู ุงูุญููู\nุฅูุบุงุก: ุงุฎุชูุงุฑ ุญููู ููุชุตุฏูุฑ"
  );

  let chosenRaw = null;
  if (exportAllFields) {
    chosenRaw = fields.slice(); // ูู ุงูุญููู
  } else {
    chosenRaw = _reportsPickFields(fields);
    if (!chosenRaw) return; // ุงููุณุชุฎุฏู ุณูุฑ ุจุฏูู ุงุฎุชูุงุฑ
  }

  // โ ุถูุงู ุฃู (*) ุฃูู ุนููุฏ ุฏุงุฆููุง
  const noField = fields.find(f => f.key === "no");
  const chosen = [
    noField,
    ...chosenRaw.filter(cf => cf && cf.key !== "no")
  ].filter(Boolean);

  const data = exportList.map((r, i) => {
    // ูุฌูุจ ุจูุงูุงุช ุงูุฃุณุฑุฉ ุงููุงููุฉ (ููุญููู ุงููู ูุด ููุฌูุฏุฉ ูู rows)
    const fam = (families || []).find(f => String(f?.id || "").trim() === String(r?.familyId || "").trim()) || null;

    const row = {
      no: i + 1,

      familyName: r?.familyName || fam?.name || "",
      familyId: r?.familyId || fam?.id || "",
      familyPhone: r?.familyPhone || fam?.phone || "",

      wife: fam?.wife || "",
      wifeId: fam?.wifeId || "",
      wifeAge: fam?.wifeAge || "",

      socialStatus: fam?.socialStatus || "",
      gender: fam?.gender || "",

      // โ ุงูููุฌูุฏ ุนูุฏู ูู ุงูุชูุฑูุฑ
      pregnantStatus: r?.pregnantStatus || fam?.pregnant || "",

      originalResidence: fam?.originalResidence || "",
      currentResidence: fam?.currentResidence || "",
      totalCount: fam?.totalCount || "",

      notes: (fam?.notes ?? "")
    };

    // โ ุฅุฎุฑุงุฌ ุญุณุจ ุชุฑุชูุจ ุงูุฃุนูุฏุฉ ุงููุฎุชุงุฑุฉ
    const out = {};
    chosen.forEach(cf => { out[cf.label] = row[cf.key] ?? ""; });
    return out;
  });

  _reportsExportXlsx("ุงูุญูุงูู_ูุงููุฑุถุนุงุช", "ุชูุฑูุฑ_ุงูุญูุงูู_ูุงููุฑุถุนุงุช.xlsx", data);
}

function exportReportsPregnantAll() {
  if (!window.XLSX) { alert("ููุชุจุฉ Excel (XLSX) ุบูุฑ ูุญูููุฉ"); return; }

  // โ ุงุฌุนููุง ุชุตุฏุฑ ุงููู ูุจุงุดุฑุฉ (ุจุฏูู ุงูุญุงุฌุฉ ููุชุญุฏูุฏ)
  const base = (lastReportsPregnantRowsFull || []);
  if (!base.length) { alert("ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููุชุตุฏูุฑ"); return; }

  // ูุคูุชูุง: ููู ุงูุชุญุฏูุฏ (ุญุชู ูุง ูุนุชูุฏ ุนูู ุงููุญุฏุฏ)
  // ุซู ููุงุฏู ููุณ ุงูุฏุงูุฉ ููู ุจุฏูู ูุญุฏุฏ: ูุฃููุง ูู ูุง ูู ูุญุฏุฏ โ ุจุชุตุฏุฑ ุงููู
  document.querySelectorAll("#repPregTable tbody input.repPregRowCheck").forEach(cb => cb.checked = false);

  exportReportsPregnantSelected();
}

/* ===========================
   ุชูุงุฑูุฑ ุงูุฃูุฑุงุถ (ูุน ุชุญุฏูุฏ + ุชุตุฏูุฑ) + ุนุฑุถ + ุตูุญุงุช + ุฒูุฌุฉ
   =========================== */

// โ ุงููุงุฆูุฉ ุงููุงููุฉ ุจุนุฏ ุงูููุงุชุฑ (ููุชุตุฏูุฑ)
var lastReportsDiseaseRows = lastReportsDiseaseRows || [];

// โ ุงููุนุฑูุถ ูู ุงูุฌุฏูู (ุตูุญุฉ)
var lastReportsDiseaseRowsView = [];

// โ ุงูุตูุญุฉ ุงูุญุงููุฉ
var repDisCurrentPage = 1;

function buildReportsDiseaseRows() {
  const rows = [];

  // ูููุงุช/ููู ุชุนุชุจุฑ "ูุง ููุฌุฏ ูุฑุถ" ููุง ูุฌุจ ุนุฑุถูุง
  const isNoDisease = (v) => {
    const s = String(v || "").trim().toLowerCase().replace(/\s+/g, " ");
    return (
      s === "" ||
      s === "ูุง" ||
      s === "ูุง ููุฌุฏ" ||
      s === "ูุง ููุฌุฏ ูุฑุถ" ||
      s === "ูุง ููุฌุฏ ุฃูุฑุงุถ" ||
      s === "ูุง ุชูุฌุฏ ุฃูุฑุงุถ" ||
      s === "ูุงููุฌุฏ" ||
      s === "ูุงููุฌุฏ ุงูุฑุงุถ" ||
      s === "ูุง ููุฌุฏ ุงูุฑุงุถ"
    );
  };

  (families || []).forEach((f) => {
    const dv = String(f?.disease || "").trim();
    if (isNoDisease(dv)) return;

    rows.push({
      _key: String(f?.id || "") || ("noid_" + Math.random()),
      no: 0,

      familyName: f?.name || "",
      familyId: f?.id || "",
      familyPhone: f?.phone || "",

      // โ ุฅุถุงูุงุช ููุชุตุฏูุฑ (ูุซู ุงูุฃุทูุงู)
      wife: f?.wife || f?.wifeName || "",
      wifeId: f?.wifeId || "",

      originalResidence: f?.originalResidence || "",
      currentResidence: f?.currentResidence || "",
      totalCount: f?.totalCount || "",
      notes: f?.notes || "",

      diseaseText: dv
    });
  });

  rows.sort((a, b) => String(a.familyName).localeCompare(String(b.familyName), "ar", { sensitivity: "base" }));
  rows.forEach((r, i) => (r.no = i + 1));
  return rows;
}

// ===== Page Size + Pagination =====
function _getRepDisPageSize() {
  const v = String(document.getElementById("repDisPageSize")?.value || "10").trim();
  const n = parseInt(v, 10);
  if (!isNaN(n) && n >= 0) return n; // 0 = ุนุฑุถ ุงููู
  return 10;
}

function _getRepDisTotalPages(totalCount) {
  const pageSize = _getRepDisPageSize();
  if (pageSize === 0) return 1;
  return Math.max(1, Math.ceil(totalCount / pageSize));
}

function _clampRepDisPage(totalCount) {
  const totalPages = _getRepDisTotalPages(totalCount);
  if (repDisCurrentPage < 1) repDisCurrentPage = 1;
  if (repDisCurrentPage > totalPages) repDisCurrentPage = totalPages;
  return totalPages;
}

function _getRepDisView(list) {
  const pageSize = _getRepDisPageSize();
  if (pageSize === 0) return list;
  const start = (repDisCurrentPage - 1) * pageSize;
  const end = start + pageSize;
  return list.slice(start, end);
}

function repDisGoPage(p) {
  repDisCurrentPage = p;
  applyReportsDisease();
}

function renderRepDisPagination(totalCount) {
  const box = document.getElementById("repDisPagination");
  if (!box) return;

  const pageSize = _getRepDisPageSize();
  if (pageSize === 0) { box.innerHTML = ""; return; }

  const totalPages = _clampRepDisPage(totalCount);
  if (totalPages <= 1) { box.innerHTML = ""; return; }

  const cur = repDisCurrentPage;

  const win = 7;
  let start = Math.max(1, cur - Math.floor(win / 2));
  let end = start + win - 1;
  if (end > totalPages) { end = totalPages; start = Math.max(1, end - win + 1); }

  let html = `
    <button onclick="repDisGoPage(${Math.max(1, cur - 1)})" style="margin:2px;padding:4px 10px;">ุงูุณุงุจู</button>
  `;

  if (start > 1) {
    html += `<button onclick="repDisGoPage(1)" style="margin:2px;padding:4px 10px;">1</button>`;
    if (start > 2) html += `<span style="margin:0 6px;color:#666;">โฆ</span>`;
  }

  for (let i = start; i <= end; i++) {
    html += `<button onclick="repDisGoPage(${i})"
                    style="margin:2px;padding:4px 10px;${i === cur ? "background:#0b5ed7;color:#fff;" : ""}">
              ${i}
            </button>`;
  }

  if (end < totalPages) {
    if (end < totalPages - 1) html += `<span style="margin:0 6px;color:#666;">โฆ</span>`;
    html += `<button onclick="repDisGoPage(${totalPages})" style="margin:2px;padding:4px 10px;">${totalPages}</button>`;
  }

  html += `
    <button onclick="repDisGoPage(${Math.min(totalPages, cur + 1)})" style="margin:2px;padding:4px 10px;">ุงูุชุงูู</button>
  `;

  box.innerHTML = html;
}

// ===== Render / Apply / Reset =====
function renderReportsDisease() {
  repDisCurrentPage = 1;
  lastReportsDiseaseRows = buildReportsDiseaseRows();

  const totalPages = _clampRepDisPage(lastReportsDiseaseRows.length);
  lastReportsDiseaseRowsView = _getRepDisView(lastReportsDiseaseRows);

  renderReportsDiseaseTable(lastReportsDiseaseRowsView, 0);
  renderReportsDiseaseSummary(lastReportsDiseaseRows, lastReportsDiseaseRowsView, totalPages);
  renderRepDisPagination(lastReportsDiseaseRows.length);
}

function applyReportsDisease() {
  const q = (document.getElementById("repDisSearch")?.value || "").trim().toLowerCase();
  const kw = (document.getElementById("repDisKeyword")?.value || "").trim().toLowerCase();

  let list = buildReportsDiseaseRows();

  // โ ุงูุจุญุซ ุงูุนุงู (ุงุณู/ูููุฉ/ุฌูุงู/ูุฑุถ/ุฒูุฌุฉ)
  if (q) {
    list = list.filter(r => {
      const hay = `${r.familyName} ${r.familyId} ${r.familyPhone} ${r.diseaseText} ${r.wife} ${r.wifeId}`.toLowerCase();
      return hay.includes(q);
    });
  }

  // โ ูููุฉ ุฏุงุฎู ุงูุฃูุฑุงุถ (ูุฐุง ุงููู ูุงู ูุณุจุจ โูุธูุฑ ุงูููโ)
  if (kw) {
    list = list.filter(r => String(r.diseaseText || "").toLowerCase().includes(kw));
  }

  // โ ุงููุงุฆูุฉ ุงููุงููุฉ ููุชุตุฏูุฑ
  lastReportsDiseaseRows = list;

  // โ ุตูุญุงุช + ุนุฑุถ ุงููุชุงุฆุฌ
  const totalPages = _clampRepDisPage(list.length);
  const view = _getRepDisView(list);
  lastReportsDiseaseRowsView = view;

  const pageSize = _getRepDisPageSize();
  const offset = (pageSize === 0) ? 0 : (repDisCurrentPage - 1) * pageSize;

  renderReportsDiseaseTable(view, offset);
  renderReportsDiseaseSummary(list, view, totalPages);
  renderRepDisPagination(list.length);
}

function resetReportsDisease() {
  const s = document.getElementById("repDisSearch");
  const k = document.getElementById("repDisKeyword");
  const ps = document.getElementById("repDisPageSize");

  if (s) s.value = "";
  if (k) k.value = "";
  if (ps) ps.value = "10";

  repDisCurrentPage = 1;
  renderReportsDisease();
}

function renderReportsDiseaseSummary(fullList, viewList, totalPages) {
  const summary = document.getElementById("repDiseaseSummary");
  const countEl = document.getElementById("repDiseaseCount");

  const total = (fullList || []).length;
  const shown = (viewList || []).length;

  const pageSize = _getRepDisPageSize();
  const pagesTxt = (pageSize === 0) ? "" : ` โ ุตูุญุฉ ${repDisCurrentPage} ูู ${totalPages}`;

  if (countEl) countEl.textContent = `ุนุฏุฏ ุงููุชุงุฆุฌ: ${total} (ุงููุนุฑูุถ: ${shown})${pagesTxt}`;
  if (!summary) return;

  summary.innerHTML = `<b>ุนุฏุฏ ุงูุฃุณุฑ (ุฃูุฑุงุถ):</b> ${total}`;
}

function renderReportsDiseaseTable(list, offset = 0) {
  const tbody = document.querySelector("#repDiseaseTable tbody");
  if (!tbody) return;

  tbody.innerHTML = "";

  if (!list.length) {
    // โ ุนุฏูููุง colspan ููุทุงุจู ุงูุฌุฏูู (6 ุฃุนูุฏุฉ)
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#666;padding:12px;">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</td></tr>`;
    return;
  }

  // โ ููุชุฒู ุจุฃุนูุฏุฉ ุงูุฌุฏูู ุงูููุฌูุฏุฉ ูู HTML
  list.forEach((r, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="repDisRowCheck" type="checkbox" data-key="${r._key}"></td>
      <td>${offset + i + 1}</td>
      <td>${r.familyName || "-"}</td>
      <td>${r.familyId || "-"}</td>
      <td>${r.familyPhone || "-"}</td>
      <td>${r.diseaseText || "-"}</td>
    `;
    tbody.appendChild(tr);
  });

  const top = document.getElementById("repDisSelectAllTop");
  const bot = document.getElementById("repDisSelectAllBottom");
  if (top) top.checked = false;
  if (bot) bot.checked = false;
}

function toggleAllReportsDisease(checked) {
  document.querySelectorAll("#repDiseaseTable tbody input.repDisRowCheck").forEach(cb => cb.checked = checked);
  const top = document.getElementById("repDisSelectAllTop");
  const bot = document.getElementById("repDisSelectAllBottom");
  if (top) top.checked = checked;
  if (bot) bot.checked = checked;
}

// โ ุชุบููุฑ ุนุฑุถ ุงููุชุงุฆุฌ: ูุฑุฌุน ููุตูุญุฉ 1 ููุทุจู
document.addEventListener("change", function (e) {
  if (e?.target?.id === "repDisPageSize") {
    repDisCurrentPage = 1;
    applyReportsDisease();
  }
});

/* ===== ุงูุชุตุฏูุฑ ===== */
function exportReportsDiseaseSelected() {
  const selectedKeys = Array.from(
    document.querySelectorAll("#repDiseaseTable tbody input.repDisRowCheck:checked")
  ).map(cb => String(cb.dataset.key));

  const base = lastReportsDiseaseRows || [];
  const exportList = selectedKeys.length
    ? base.filter(r => selectedKeys.includes(String(r._key)))
    : base;

  if (!exportList.length) { alert("ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููุชุตุฏูุฑ"); return; }

  const fields = [
    { key: "no", label: "*" },
    { key: "familyName", label: "ุงุณู ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "familyId", label: "ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ" },

    // โ ุฌุฏูุฏ
    { key: "wife", label: "ุงุณู ุงูุฒูุฌุฉ" },
    { key: "wifeId", label: "ูููุฉ ุงูุฒูุฌุฉ" },

    { key: "familyPhone", label: "ุฑูู ุงูุฌูุงู" },
    { key: "originalResidence", label: "ุงูุณูู ุงูุฃุตูู" },
    { key: "currentResidence", label: "ุงูุณูู ุงูุญุงูู" },
    { key: "totalCount", label: "ุงูุนุฏุฏ ุงูุฅุฌูุงูู" },
    { key: "diseaseText", label: "ุงููุฑุถ/ุงูุฃูุฑุงุถ" },
    { key: "notes", label: "ููุงุญุธุงุช" }
  ];

  const chosenRaw = _reportsPickFields(fields);
  if (!chosenRaw) { alert("ูู ูุชู ุงุฎุชูุงุฑ ุญููู ููุชุตุฏูุฑ"); return; }

  // โ ุซุจุช ุนููุฏ ุงูุฑูู ุฏุงุฆููุง ุฃูู ุดูุก
  const noField = fields.find(f => f.key === "no");
  const chosen = [noField, ...chosenRaw.filter(cf => cf && cf.key !== "no")].filter(Boolean);

  const data = exportList.map((r, idx) => {
    const row = {
      no: idx + 1,
      familyName: r.familyName,
      familyId: r.familyId,
      wife: r.wife || "",
      wifeId: r.wifeId || "",
      familyPhone: r.familyPhone,
      originalResidence: r.originalResidence,
      currentResidence: r.currentResidence,
      totalCount: r.totalCount,
      diseaseText: r.diseaseText || "ูุง",
      notes: r.notes
    };

    const out = {};
    chosen.forEach(cf => out[cf.label] = row[cf.key] ?? "");
    return out;
  });

  _reportsExportXlsx("ุงูุฃูุฑุงุถ", selectedKeys.length ? "ุชูุฑูุฑ_ุงูุฃูุฑุงุถ_ุงููุญุฏุฏ.xlsx" : "ุชูุฑูุฑ_ุงูุฃูุฑุงุถ.xlsx", data);
}

function exportReportsDiseaseAll() {
  exportReportsDiseaseSelected();
}

/* ===========================
   ุงุณุชูุฑุงุฏ Excel ุญุณุจ ูููู
   ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ ููุท:
   ุงูุงุณู, ุฑูู ุงููููุฉ (ุฑุจ ุงูุฃุณุฑุฉ), ุงุณู ุงูุฒูุฌุฉ, ุฑูู ูููุฉ ุงูุฒูุฌุฉ, ุฌูุงู,
   ุงูุนุฏุฏ ุงูุฅุฌูุงูู, ุงูุณูู ุงูุฃุตูู, ูุชูุงุฌุฏ ุญุงููุงู, ููุงุญุธุงุช
   =========================== */

function importExcel() {
  if (!window.XLSX) {
    alert("ููุชุจุฉ Excel (XLSX) ุบูุฑ ูุญูููุฉ");
    return;
  }

  // โ ุญูุงูุฉ: ูู families ูุด ูุนุฑูุฉ ูุณุจุจ ูุง
  if (!Array.isArray(window.families) && typeof families === "undefined") {
    window.families = [];
  }
  const fams = (typeof families !== "undefined") ? families : window.families;

  let input = document.getElementById("excelImportInput");
  if (!input) {
    input = document.createElement("input");
    input.type = "file";
    input.id = "excelImportInput";
    input.accept = ".xlsx,.xls";
    input.style.display = "none";
    document.body.appendChild(input);
  }

  input.onchange = function () {
    const file = input.files && input.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = function (ev) {
      try {
        const buf = ev.target.result; // ArrayBuffer
        const wb = XLSX.read(buf, { type: "array" });

        const sheetName = wb.SheetNames && wb.SheetNames[0];
        if (!sheetName) {
          alert("ุงูููู ูุง ูุญุชูู ุนูู Sheets");
          return;
        }

        const ws = wb.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

        if (!rows || rows.length === 0) {
          alert("ุงูููู ูุงุฑุบ ุฃู ูุง ูุญุชูู ุจูุงูุงุช");
          return;
        }

        let added = 0, updated = 0, skipped = 0;

        rows.forEach((row) => {
          const fam = mapExcelRowToFamily_YourSheet(row);

          const id = String(fam.id || "").trim();
          const name = String(fam.name || "").trim();
          if (!id || !name) {
            skipped++;
            return;
          }

          fam._searchMatch = true;

          const idx = fams.findIndex(f => String(f?.id || "").trim() === id);
          if (idx === -1) {
            fams.push(fam);
            added++;
          } else {
            fams[idx] = { ...fams[idx], ...pickNonEmpty(fam), _searchMatch: true };
            updated++;
          }
        });

        if (typeof saveToStorage === "function") saveToStorage();
        if (typeof renderFamilies === "function") renderFamilies();

        alert(
          `ุชู ุงูุงุณุชูุฑุงุฏ โ\n` +
          `ุฅุถุงูุฉ ุฌุฏูุฏ: ${added}\n` +
          `ุชุญุฏูุซ ููุฌูุฏ: ${updated}\n` +
          `ุชุฎุทู (ุจูุงูุงุช ูุงูุตุฉ): ${skipped}`
        );

// โ ุฏุงูุฉ ุชุญููู ุตู Excel ุฅูู ูุงุฆู ุฃุณุฑุฉ (ููููุฏุฉ โ ุณุจุจ ุงูุฎุทุฃ)
function mapExcelRowToFamily_YourSheet(row) {
  const get = (...keys) => {
    for (const k of keys) {
      if (row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== "") {
        return row[k];
      }
    }
    return "";
  };

  return {
    // ุงุณู ุฑุจ ุงูุฃุณุฑุฉ
    name: String(
      get("ุงูุงุณู", "ุงุณู ุฑุจ ุงูุฃุณุฑุฉ", "ุงุณู ุฑุจ ุงูุฃุณุฑุฉ (ุฑุจุงุนู)")
    ).trim(),

    // ุฑูู ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ
    id: String(
      get("ุฑูู ุงููููุฉ", "ุฑูู ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ", "ุฑูู ูููุฉ ุฑุจ ุงูุงุณุฑุฉ")
    ).trim(),

    // ุงุณู ุงูุฒูุฌุฉ
    wife: String(get("ุงุณู ุงูุฒูุฌุฉ")).trim(),

    // ุฑูู ูููุฉ ุงูุฒูุฌุฉ (ุจุฏูู ุฎูุท ูุน ูููุฉ ุงูุฒูุฌ)
    wifeId: String(get("ุฑูู ูููุฉ ุงูุฒูุฌุฉ", "ุฑูู ูููุฉ ุงูุฒูุฌู")).trim(),

    // ุงูุฌูุงู
    phone: String(get("ุฌูุงู", "ุฑูู ุงูุฌูุงู")).trim(),

    // ุงูุนุฏุฏ ุงูููู
    totalCount: String(get("ุงูุนุฏุฏ ุงูุฅุฌูุงูู")).trim(),

    // ุงูุณูู ุงูุฃุตูู
    originalResidence: String(get("ุงูุณูู ุงูุฃุตูู")).trim(),

    // ุงูุณูู ุงูุญุงูู
    currentResidence: String(get("ูุชูุงุฌุฏ ุญุงููุงู", "ูุชูุงุฌุฏ ุญุงููุง")).trim(),

    // ููุงุญุธุงุช
    notes: String(get("ููุงุญุธุงุช")).trim(),

    // ููู ุงูุชุฑุงุถูุฉ ูุทููุจุฉ
    pregnant: "ูุง",
    disease: "ูุง",

    _searchMatch: true
  };
}

      } catch (e) {
        alert(
          "ุฎุทุฃ ุฃุซูุงุก ุงูุงุณุชูุฑุงุฏ โ\n" +
          "ููุน ุงูุฎุทุฃ: " + (e?.name || "Unknown") + "\n" +
          "ุงูุฑุณุงูุฉ: " + (e?.message || String(e))
        );
      } finally {
        input.value = "";
      }
    };

    reader.onerror = function () {
      alert("ุฎุทุฃ: ุชุนุฐุฑ ูุฑุงุกุฉ ุงูููู ูู ุงูุฌูุงุฒ (FileReader error)");
      input.value = "";
    };

    reader.readAsArrayBuffer(file);
  };

  input.click();
}


/* ===========================
   ุชุตุฏูุฑ: ูู ุงูุจูุงูุงุช + ุญููู ูุญุฏุฏุฉ
   =========================== */

// โ ุฐุงูุฑุฉ ุชุญุฏูุฏ ุงูุฃุณุฑ (ุชุธู ุญุชู ูุน ุงูุจุญุซ)
window.selectedFamilyIds = window.selectedFamilyIds || new Set();

// ูุณุงุนุฏ: ุฑุฌูุน ูุงุฆูุฉ ุงูุฃุณุฑ ุงููุญุฏุฏุฉ ุญุณุจ ุงูุฐุงูุฑุฉ
function getSelectedFamiliesFromMemory() {
  const ids = window.selectedFamilyIds;
  if (!ids || ids.size === 0) return [];
  const allList = Array.isArray(families) ? families : [];
  return allList.filter(f => f && ids.has(String(f.id || "").trim()));
}

// โ ุชุญุฏูุซ ุนุฏุงุฏ ุงููุญุฏุฏ + (ุฅู ูุฌุฏ ุนูุตุฑ UI)
function updateSelectedCountUI() {
  const el = document.getElementById("selectedCount");
  if (el) el.textContent = `ุงููุญุฏุฏ: ${window.selectedFamilyIds.size}`;
}

// โ ุนูุฏ ุชุบููุฑ ุฃู checkbox
function onFamilyCheckboxChange(cb) {
  const id = String(cb.dataset.id || "").trim();
  if (!id) return;

  if (cb.checked) window.selectedFamilyIds.add(id);
  else window.selectedFamilyIds.delete(id);

  if (typeof updateSelectedCountUI === "function") updateSelectedCountUI();
}

// โ ุฅูุบุงุก ูู ุงูุชุญุฏูุฏ
function clearSelectedFamilies() {
  if (window.selectedFamilyIds) window.selectedFamilyIds.clear();
  document.querySelectorAll('#familiesTable tbody input[type="checkbox"]').forEach(cb => cb.checked = false);

  const selectAll = document.getElementById("selectAll");
  if (selectAll) selectAll.checked = false;

  if (typeof updateSelectedCountUI === "function") updateSelectedCountUI();
}

function exportFamiliesWithMode(mode /* "selected" | "all" */, opts = {}) {
  if (!window.XLSX) { alert("ููุชุจุฉ Excel (XLSX) ุบูุฑ ูุญูููุฉ"); return; }

  const allList = Array.isArray(families) ? families : [];
  if (!allList.length) { alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ"); return; }

  // ๐ข ุงุฌูุน ุงููุตุฏุฑ: ูู ุงูุฃุณุฑ ุฃู ุงููุญุฏุฏ ูู ุงูุฐุงูุฑุฉ/ุงูุฌุฏูู
  let source = allList;

  if (mode === "selected") {

    // 1) ุงูุฃููููุฉ ููุฐุงูุฑุฉ (ุญุชู ูู ุงููุญุฏุฏ ูุด ุธุงูุฑ ุจุณุจุจ ุงูุจุญุซ)
    let selectedIds = (window.selectedFamilyIds && window.selectedFamilyIds.size)
      ? Array.from(window.selectedFamilyIds).map(s => String(s).trim())
      : [];

    // 2) fallback: ูู ุงูุฐุงูุฑุฉ ูุงุถูุฉ ุฎุฐ ุงููุญุฏุฏ ุงูุธุงูุฑ ูู ุงูุฌุฏูู
    if (!selectedIds.length) {
      selectedIds = Array.from(
        document.querySelectorAll('#familiesTable tbody input[type="checkbox"]:checked')
      )
      .map(cb => String(cb.dataset.id || "").trim())
      .filter(Boolean);
    }

    if (!selectedIds.length) {
      alert("ูุฑุฌู ุชุญุฏูุฏ ุฃุณุฑุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู");
      return;
    }

    const idSet = new Set(selectedIds);
    source = allList.filter(f => f && idSet.has(String(f.id || "").trim()));
  }

  if (!source.length) { alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ"); return; }

  // ุชุทุจูุน ุญููู ุงูุญูุงูู/ุงูุฃูุฑุงุถ
  const normPregnant = (v) => {
    const s = String(v || "").trim();
    if (!s || s === "-" || s === "ูุง" || s === "ูุง ููุฌุฏ") return "ูุง";
    return s;
  };
  const normDisease = (v) => {
    const s = String(v || "").trim();
    if (!s || s === "-" || s === "ูุง" || s === "ูุง ููุฌุฏ") return "ูุง";
    return s;
  };

  // โ ููุณ ูุธุงู ุงูุชูุงุฑูุฑ: ููุงูู = ูุงูู / ุฅูุบุงุก = ุญููู
  let exportType = "full"; // full | custom
  if (opts && opts.forceCustom) {
    exportType = "custom";
  } else {
    const ok = confirm(
      "ุทุฑููุฉ ุงูุชุตุฏูุฑ:\n\n" +
      "โ ุงุถุบุท (ููุงูู) ูุชุตุฏูุฑ ูู ุงูุญููู.\n" +
      "โ๏ธ ุงุถุบุท (ุฅูุบุงุก) ูุงุฎุชูุงุฑ ุญููู ูุนููุฉ."
    );
    exportType = ok ? "full" : "custom";
  }

  const columns = [
    { key: "_no", label: "*" },
    { key: "socialStatus", label: "ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ" },
    { key: "name", label: "ุงุณู ุฑุจ ุงูุฃุณุฑุฉ (ุฑุจุงุนู)" },
    { key: "id", label: "ุฑูู ูููุฉ ุฑุจ ุงูุฃุณุฑุฉ" },
    { key: "wife", label: "ุงุณู ุงูุฒูุฌุฉ" },
    { key: "wifeId", label: "ุฑูู ูููุฉ ุงูุฒูุฌุฉ" },
    { key: "totalCount", label: "ุงูุนุฏุฏ ุงูููู ููุฃูุฑุงุฏ" },
    { key: "originalResidence", label: "ุงูุณูู ุงูุฃุตูู" },
    { key: "currentResidence", label: "ุงูุณูู ุงูุญุงูู" },
    { key: "pregnant", label: "ุญูุงูู/ูุฑุถุนุงุช" },
    { key: "disease", label: "ุงูุฃูุฑุงุถ" },
    { key: "notes", label: "ููุงุญุธุงุช" },
    { key: "phone", label: "ุฌูุงู" }
  ];

  let chosen = columns;

  if (exportType === "custom") {
    const listText = columns.map((f, i) => `${i + 1}) ${f.label}`).join("\n");
    const choice = prompt(
      "ุงูุชุจ ุฃุฑูุงู ุงูุญููู ุงููุทููุจ ุชุตุฏูุฑูุง ููุตููุฉ ุจููุงุตู (ูุซุงู: 1,2,6)\n\n" + listText
    );
    if (!choice) return;

    const idxs = choice
      .split(",")
      .map(s => parseInt(s.trim(), 10))
      .filter(n => Number.isFinite(n) && n >= 1 && n <= columns.length);

    if (!idxs.length) { alert("ูู ูุชู ุงุฎุชูุงุฑ ุญููู ุตุญูุญุฉ"); return; }

    // โ ููุน ุชูุฑุงุฑ + ุชุฑุชูุจ
    const uniq = Array.from(new Set(idxs));
    chosen = uniq.map(i => columns[i - 1]);
  }

  const data = source.map((f, i) => {
    const row = {};
    chosen.forEach(col => {
      let v = "";
      if (col.key === "_no") v = i + 1;
      else if (col.key === "pregnant") v = normPregnant(f?.pregnant);
      else if (col.key === "disease") v = normDisease(f?.disease);
      else v = (f && f[col.key] !== undefined && f[col.key] !== null) ? f[col.key] : "";
      row[col.label] = v;
    });
    return row;
  });

  const ws = XLSX.utils.json_to_sheet(data, { skipHeader: false });

  // โ RTL
  ws["!view"] = [{ rightToLeft: true }];

  // ===== Styles: ููุฏุฑ + ุนููุฏ ุฃูู + Borders ูุงููุฉ =====
  const ref = ws["!ref"];
  if (ref) {
    const range = XLSX.utils.decode_range(ref);

    // ุฃููุงู ARGB
    const HEADER_BG = "FF2F3E4E"; // ููู ููุฏุฑ ุชูุงุฑูุฑู
    const WHITE     = "FFFFFFFF";
    const BLACK     = "FF000000";
    const BORDER    = "FFCBD5E1";

    const borderAll = {
      top:    { style: "thin", color: { rgb: BORDER } },
      bottom: { style: "thin", color: { rgb: BORDER } },
      left:   { style: "thin", color: { rgb: BORDER } },
      right:  { style: "thin", color: { rgb: BORDER } }
    };

    const headerStyle = {
      font: { name: "Arial", sz: 14, bold: true, color: { rgb: WHITE } },
      alignment: { horizontal: "right", vertical: "center" },
      fill: { fgColor: { rgb: HEADER_BG } },
      border: borderAll
    };

    const firstColStyle = {
      font: { name: "Arial", sz: 14, bold: true, color: { rgb: WHITE } },
      alignment: { horizontal: "center", vertical: "center" },
      fill: { fgColor: { rgb: HEADER_BG } },
      border: borderAll
    };

    const normalStyle = {
      font: { name: "Arial", sz: 14, color: { rgb: BLACK } },
      alignment: { horizontal: "right", vertical: "center" },
      border: borderAll
    };

    // ุทุจูู ุงูุณุชุงูู ุนูู ูู ุงูุฎูุงูุง
    for (let r = range.s.r; r <= range.e.r; r++) {
      for (let c = range.s.c; c <= range.e.c; c++) {
        const addr = XLSX.utils.encode_cell({ r, c });
        const cell = ws[addr];
        if (!cell) continue;

        if (r === range.s.r) cell.s = headerStyle;         // ุตู ุงูุนูุงููู
        else if (c === range.s.c) cell.s = firstColStyle;  // ุฃูู ุนููุฏ (*)
        else cell.s = normalStyle;                         // ุจุงูู ุงูุฎูุงูุง
      }
    }
  }

  // โ ุนุฑุถ ุงูุฃุนูุฏุฉ ุชููุงุฆููุง (ูุซู ุงูุชูุงุฑูุฑ)
  const headers = Object.keys(data[0] || {});
  ws["!cols"] = headers.map(h => {
    let wch = Math.max(10, String(h).length + 2);
    data.forEach(row => {
      const v = row[h] ?? "";
      wch = Math.min(60, Math.max(wch, String(v).length + 2));
    });
    return { wch };
  });

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ุงูุฃุณุฑ");

  const fileBase =
    (mode === "selected" ? "ุชุตุฏูุฑ_ุงููุญุฏุฏ" : "ุชุตุฏูุฑ_ูู_ุงูุฃุณุฑ") +
    (exportType === "custom" ? "_ุญููู_ูุญุฏุฏุฉ" : "_ูุงูู");

  XLSX.writeFile(wb, `${fileBase}.xlsx`);
}
// ====== ุฃุนูุฏุฉ ุฌุฏูู ุงูุฃุณุฑ: ุฅุฎูุงุก/ุฅุธูุงุฑ + ุญูุธ ======

function toggleColumn(field, visible) {
  const selector = `th.col-${field}, td.col-${field}`;
  document.querySelectorAll(selector).forEach(el => {
    el.style.display = visible ? "" : "none";
  });
}

function initFieldToggles() {
  const toggles = document.querySelectorAll(".field-toggle");
  if (!toggles || toggles.length === 0) return;

  toggles.forEach(cb => {
    const field = cb.dataset.field;
    const key = "col_" + field;

    // ุงุณุชุฑุฌุงุน ุงูุญุงูุฉ
    const saved = localStorage.getItem(key);
    if (saved !== null) cb.checked = (saved === "true");

    // ุชุทุจูู ุงูุญุงูุฉ ุนูู ุงูุฌุฏูู
    toggleColumn(field, cb.checked);

    // ุฑุจุท ุงูุชุบููุฑ ูุฑุฉ ูุงุญุฏุฉ
    if (cb.dataset.bound === "1") return;
    cb.dataset.bound = "1";

    cb.addEventListener("change", function () {
      localStorage.setItem(key, this.checked ? "true" : "false");
      toggleColumn(field, this.checked);
    });
  });
}

// โ ุฏุงูุฉ ููููุฏุฉ โ ุณุจุจ ุงูุฎุทุฃ ุงูุญุงูู
function pickNonEmpty(obj) {
  const out = {};
  Object.keys(obj || {}).forEach((k) => {
    const v = obj[k];
    if (v !== undefined && v !== null && String(v).trim() !== "") {
      out[k] = v;
    }
  });
  return out;
}

// โ ุชุทุจูู ุฅุฎูุงุก/ุฅุธูุงุฑ ุงูุฃุนูุฏุฉ ูุฑุฉ ูุงุญุฏุฉ ูุจุฃูุงู
document.addEventListener("DOMContentLoaded", function () {
  try {
    if (typeof initFieldToggles === "function") initFieldToggles();
  } catch (e) {
    console.error("initFieldToggles error:", e);
  }
});

// โ ููู ุฌุฏูุง: ุฅุบูุงู try ุงูุฑุฆูุณูุฉ ุญุชู ูุง ูุชุนุทู ุงูุณูุฑุจุช ููู
} catch (e) {
  console.error("JS FATAL ๐ด", e);
  // ูุง ูุณุชุฎุฏู alert ููุง ุญุชู ูุง ุชุชุนูู ุงูุตูุญุฉ ูุงููุงุฆูุฉ
}

function toggleAllReportsChildren(checked) {
  // ุญุฏูุฏ ูู ุตููู ุงูุฃุทูุงู ุงูุธุงูุฑุฉ ุญุงููุงู
  document
    .querySelectorAll("#repChildrenTable tbody input.repChildRowCheck")
    .forEach(cb => {
      cb.checked = checked;
    });

  // ูุฒุงููุฉ ูุฑุจุน ุชุญุฏูุฏ ุงููู (ุฃุนูู / ุฃุณูู)
  const top = document.getElementById("repChildSelectAllTop");
  const bottom = document.getElementById("repChildSelectAllBottom");

  if (top) top.checked = checked;
  if (bottom) bottom.checked = checked;
}

function showDeparted() {
  currentView = "departed";

  // ุฃุฎูู ูู ุงูุฃูุณุงู
  if (typeof hideAllSections === "function") hideAllSections();

  // โ ููู: ุงูุชุญ ุงูุบูุงู ุงููู ุบุงูุจุงู ูุญุชูู ุงูุฃูุณุงู (ุนุฑุถ ุงูุฃุณุฑ)
  const viewWrap = document.getElementById("viewFamiliesSection");
  if (viewWrap) viewWrap.classList.remove("hidden");

  // โ ุงูุชุญ ูุณู ุงูุฃุณุฑ ุงููุบุงุฏุฑุฉ ููุณู
  const section = document.getElementById("departedFamiliesSection");
  if (section) section.classList.remove("hidden");

  // โ ุงุฑุณู ุจูุงูุงุช ุงููุบุงุฏุฑูู ูู ุงูุฏุงูุฉ ููุฌูุฏุฉ
  if (typeof renderDeparted === "function") renderDeparted();

  // ุงุบูุงู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ
  const sideMenu = document.getElementById("sideMenu");
  if (sideMenu) sideMenu.style.right = "-100%";

  window.scrollTo({ top: 0, behavior: "smooth" });
}

// ูู ุงููุงุฆูุฉ ุจุชูุงุฏู ุงูุงุณู ุงููุฏูู:
function showDepartedFamilies() { showDeparted(); }

</script>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", function () {
      navigator.serviceWorker.register("./service-worker.js")
        .then(() => console.log("โ SW registered"))
        .catch((e) => console.warn("SW failed", e));
    });
  }
</script>

<!-- ====== ุฅุญุตุงุฆูุงุช ุงููุฎูู ====== -->
<div id="statsSection" class="container hidden">

  <h3 style="margin-top:0;color:#0b5ed7;">ุฅุญุตุงุฆูุงุช ุงููุฎูู</h3>

  <div class="section" style="background:#f8f9fa;">

    <p style="margin:0 0 12px;color:#444;line-height:1.7;">
      ูุนุฑุถ ูุฐุง ุงููุณู ุฅุญุตุงุฆูุงุช ุดุงููุฉ ุนู ุงููุฎูู ูุซู:
      <br>โข ุนุฏุฏ ุงูุฃุณุฑ
      <br>โข ุนุฏุฏ ุงูุฃูุฑุงุฏ
      <br>โข ุนุฏุฏ ุงูุฃุทูุงู
      <br>โข ุงูุฐููุฑ / ุงูุฅูุงุซ
      <br>โข ุงูุญูุงูู / ุงููุฑุถุนุงุช
      <br>โข ุงูุญุงูุงุช ุงูุฎุงุตุฉ
    </p>

<button type="button"
        onclick="safeUpdateStats()"
        style="width:auto;background:#0b5ed7;">
  ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
</button>

  <button type="button"
          onclick="clearCampStats()"
          style="width:auto;background:#6c757d;">
    ูุณุญ
  </button>
</div>

    <div id="campStatsSummary"
         style="font-weight:bold;margin-bottom:10px;color:#0b5ed7;">
    </div>

<div id="campStatsBody">

  <!-- ====== ุจุทุงูุงุช ุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ ====== -->
  <div id="statsCards"
       style="display:grid;
              grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
              gap:12px;
              margin-bottom:20px;">

    <div class="statCard">๐จโ๐ฉโ๐งโ๐ฆ<br><b>ุนุฏุฏ ุงูุฃุณุฑ</b><div id="statFamilies">โ</div></div>
    <div class="statCard">๐ฅ<br><b>ุนุฏุฏ ุงูุฃูุฑุงุฏ</b><div id="statPeople">โ</div></div>
    <div class="statCard">๐ง<br><b>ุนุฏุฏ ุงูุฃุทูุงู</b><div id="statChildren">โ</div></div>
    <div class="statCard">๐จ<br><b>ุงูุฐููุฑ</b><div id="statMales">โ</div></div>
    <div class="statCard">๐ฉ<br><b>ุงูุฅูุงุซ</b><div id="statFemales">โ</div></div>
    <div class="statCard">๐คฐ<br><b>ุญูุงูู</b><div id="statPregnant">โ</div></div>
    <div class="statCard">๐ผ<br><b>ูุฑุถุนุงุช</b><div id="statNursing">โ</div></div>
    <div class="statBox">
  <div class="statIcon">๐ฉบ</div>
  <div class="statLabel">ุฃุณุฑ ูุฏููุง ูุฑุถ</div>
  <div class="statValue" id="statDiseaseFamilies">0</div>
</div>

  </div>

  <!-- ====== ุชูุงุตูู ุฅุญุตุงุฆูุฉ (ุชููุฃ ูุงุญููุง) ====== -->
  <div id="statsDetails"
       style="border-top:1px dashed #ddd;
              padding-top:15px;
              color:#666;
              font-size:14px;">
    ูู ูุชู ุงุญุชุณุงุจ ุงูุชูุงุตูู ุจุนุฏ
  </div>

</div>

  </div>
</div>

<!-- ====== ุงูุฃุณุฑ ุงููุบุงุฏุฑุฉ ====== -->
<div id="departedFamiliesSection" class="container hidden">

  <h3 style="margin-top:0;">ุงูุฃุณุฑ ุงููุบุงุฏุฑุฉ</h3>

  <!-- โ ุดุฑูุท ุงูุชุญูู: ุนุฏุฏ ุงููุชุงุฆุฌ + ุนุฑุถ + ุตูุญุงุช -->
  <div style="margin:10px 0;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;">
    <div style="font-weight:bold;">
      ุนุฏุฏ ุงููุชุงุฆุฌ: <span id="departedCount">0</span>
      <span id="departedShown" style="color:#666;font-weight:normal;"></span>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <select id="departedPageSize" onchange="renderDeparted()" style="width:auto;min-width:140px;">
        <option value="20">ุนุฑุถ 20</option>
        <option value="50">ุนุฑุถ 50</option>
        <option value="100">ุนุฑุถ 100</option>
        <option value="200">ุนุฑุถ 200</option>
        <option value="0">ุนุฑุถ ุงููู</option>
      </select>
    </div>
  </div>

  <!-- โ ุงูุตูุญุงุช -->
  <div id="departedPager"
       style="margin:10px 0;display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;">
    <button type="button" onclick="departedPrevPage()" style="width:auto;padding:8px 12px;">ุงูุณุงุจู</button>
    <div id="departedPageInfo" style="font-size:13px;color:#555;"></div>
    <button type="button" onclick="departedNextPage()" style="width:auto;padding:8px 12px;">ุงูุชุงูู</button>
  </div>

  <table id="departedTable" style="width:100%;border-collapse:collapse;">
    <thead>
      <tr>
        <th style="width:50px;text-align:center;">
          <input type="checkbox" id="departedSelectAllTop" onchange="toggleAllDeparted(this.checked)">
        </th>
        <th>ุงุณู ุฑุจ ุงูุฃุณุฑุฉ</th>
        <th>ุฑูู ุงููููุฉ</th>
        <th>ุฑูู ุงูุฌูุงู</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div style="margin-top:10px;text-align:center;">
    <label style="margin:0;">
      <input type="checkbox" id="departedSelectAllBottom" onchange="toggleAllDeparted(this.checked)">
      ุชุญุฏูุฏ ุงููู
    </label>
  </div>

  <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
    <button onclick="restoreSelected()" style="background:#198754;">ุงุณุชุนุงุฏุฉ ุงููุญุฏุฏ</button>
    <button onclick="exportDepartedSelected()" style="background:#0b5ed7;">ุชุตุฏูุฑ ุงููุญุฏุฏ</button>
    <button onclick="deleteDepartedSelected()" style="background:#dc3545;">ุญุฐู ููุงุฆู</button>
  </div>

</div>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", function () {
      navigator.serviceWorker.register("./service-worker.js")
        .then(() => console.log("โ SW registered"))
        .catch((e) => console.warn("SW failed", e));
    });
  }
</script>

<script>
function showAbout() {
  hideAllSections();
  document.getElementById("aboutSection").classList.remove("hidden");
  closeMenu();
}

function showStats() {
  hideAllSections();
  document.getElementById("statsSection").classList.remove("hidden");
  closeMenu();
  window.scrollTo({ top: 0, behavior: "smooth" });

  // โ ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
  if (typeof buildCampStats === "function") {
    buildCampStats();
  }
}
</script>

<!-- ====== ุญููู ุงูุชุทุจูู ====== -->
<div id="appFooter" class="app-footer" style="
  text-align:center;
  padding:10px 12px;
  background:#0b5ed7;
  color:#fff;
  font-size:12px;
  letter-spacing:0.3px;
">
  ุฌููุน ุงูุญููู ูุญููุธุฉ ยฉ 2026 โ JeHaD AlHooR
  <span style="margin:0 6px;">|</span>

  <span style="margin:0 4px;">๐</span>
  <a href="tel:0567898990" style="color:#fff;text-decoration:none;">
    0567898990
  </a>

  <span style="margin:0 6px;">|</span>

  <a
    href="https://wa.me/972567898990"
    target="_blank"
    style="color:#fff;text-decoration:none;"
    title="ุงูุชูุงุตู ุนุจุฑ ูุงุชุณุงุจ"
  >
    ๐ฌ ูุงุชุณุงุจ
  </a>
</div>

<script>
// =========================
// Camp Stats (Stable + Linked) โ FIX: ุฃุนูุฏุฉ (ุนููุงู/ุฑูู/ุฒุฑ) + +18 ุฃุทูุงู + ุญุงูุงุช ุตุญูุฉ ูุฑุชุจุทุฉ
// + FIX: ุนูุฑ 0 + ุฃุทูุงู ุจุฏูู ุนูุฑ + ุนุฏู ุจูุงุก ุงูุฅุญุตุงุฆูุงุช ุชุญุช ุงูุฃูุณุงู
// =========================


// ====== (0) Style ุตุบูุฑ ุฏุงุฎู ุงูุณูุฑุจุช (ุนุดุงู ุชูููู "ุฃุทูุงู ุจุฏูู ุนูุฑ" ุจุฏูู ูุง ุชุชุนุจ ุจุงูู CSS) ======
(function ensureStatsInlineStyles(){
  if (document.getElementById("statsInlineFixStyle")) return;
  const st = document.createElement("style");
  st.id = "statsInlineFixStyle";
  st.textContent = `
    /* ุชูููู ุณุทุฑ "ุฃุทูุงู ุจุฏูู ุนูุฑ" */
    #statsDetails .statsRow.noAgeRow{
      background: #fff7e6 !important;
      border-color: #ffd8a8 !important;
    }
    #statsDetails .statsRow.noAgeRow .label,
    #statsDetails .statsRow.noAgeRow .value{
      color:#b15a00 !important;
      font-weight:900 !important;
    }

    /* ูู ุนูุฏู placeholder ููุฒุฑ */
    #statsDetails .statsBtnPlaceholder{
      display:inline-block;
      width: 72px; /* ูุญุงูุธ ุนูู ููุณ ูุญุงุฐุงุฉ ุงูุฒุฑ */
    }
  `;
  document.head.appendChild(st);
})();


// ====== (A) Patch: ููุง ุชุทูุน ูู ุงูุฅุญุตุงุฆูุงุช ูุง ุชุถู ุธุงูุฑุฉ ุชุญุช ุงูุฃูุณุงู ======
(function patchHideAllSections(){
  if (typeof window.hideAllSections !== "function") return;
  if (window.__statsHidePatched) return;
  window.__statsHidePatched = true;

  const original = window.hideAllSections;

  function hideStatsUI(){
    try{
      // ุฌุฑูุจ ุฃุดูุฑ IDs ูุญุชููุฉ
      let statsSec =
        document.getElementById("statsSection") ||
        document.getElementById("statsPage") ||
        document.getElementById("campStatsSection") ||
        document.getElementById("statsBox");

      const details = document.getElementById("statsDetails");

      // ูู ูุง ููููุง ุงููุณูุ ูุฎูู ุฃูุฑุจ ุญุงููุฉ ููู details
      if (!statsSec && details){
        statsSec = details.closest(".section") || details.parentElement;
      }

      if (statsSec) statsSec.classList.add("hidden");
      if (details) details.innerHTML = "";
    }catch(e){}
  }

  window.hideAllSections = function(){
    try { original.apply(this, arguments); } catch(e){}
    hideStatsUI();
  };
})();


// ุฒุฑูู ููุงุฏู safeUpdateStats()
window.safeUpdateStats = function(silent){
  try{
    if (!Array.isArray(window.families)) window.families = [];
    if (typeof window.buildCampStats === "function") window.buildCampStats();
    if (typeof refreshFamiliesInfoBar === "function") refreshFamiliesInfoBar();
  }catch(e){
    console.warn("safeUpdateStats failed", e);
  }
};


// =========================
// ุชูููู โูุดุงูุฏุฉโ
// =========================
window.statsGo = function(action, payload) {
  try {
    payload = payload || {};

    function prepFilterPage() {
      if (typeof showFilter === "function") showFilter();
      if (typeof ensureFilterPage === "function") ensureFilterPage();
      return document.getElementById("filterPage") || document.getElementById("filterBox");
    }

    function setIfExists(selectors, value) {
      for (const sel of selectors) {
        const el = document.querySelector(sel);
        if (el) { el.value = value; return true; }
      }
      return false;
    }

    function clickIfExists(selectors) {
      for (const sel of selectors) {
        const el = document.querySelector(sel);
        if (el) { el.click(); return true; }
      }
      return false;
    }

    // 1) ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ
    if (action === "filterSocial") {
      const page = prepFilterPage();
      if (page) {
        setIfExists(["#filterMinTotal"], "");
        setIfExists(["#filterMaxTotal"], "");
        setIfExists(["#filterGeneral"], "");
        setIfExists(["#filterName"], "");
        setIfExists(["#filterGender"], "");

        const checks = page.querySelectorAll(".filterSocialChk");
        checks.forEach(cb => {
          cb.checked = (String(cb.value || "").trim() === String(payload.value || "").trim());
        });
      }
      if (typeof applyFilter === "function") applyFilter();
      return;
    }

    // 2) ุงูุนุฏุฏ ุงูููู ููุฃูุฑุงุฏ (min/max)
    if (action === "filterTotalRange") {
      const page = prepFilterPage();
      if (page) {
        setIfExists(["#filterGeneral"], "");
        setIfExists(["#filterName"], "");
        setIfExists(["#filterGender"], "");
        const checks = page.querySelectorAll(".filterSocialChk");
        checks.forEach(cb => cb.checked = false);

        setIfExists(["#filterMinTotal"], (payload.min ?? ""));
        setIfExists(["#filterMaxTotal"], (payload.max ?? ""));

        page.scrollIntoView({ behavior: "smooth", block: "start" });
      }
      if (typeof applyFilter === "function") applyFilter();
      return;
    }

    // 3) ุชูุงุฑูุฑ ุงูุฃุทูุงู: ุนูุฑ ูู/ุฅูู
    if (action === "childrenAgeRange") {
      if (typeof showReports === "function") showReports();

      const minEl = document.getElementById("repChildMinAge");
      const maxEl = document.getElementById("repChildMaxAge");
      const qEl   = document.getElementById("repChildSearch");
      const gEl   = document.getElementById("repChildGender");

      if (qEl) qEl.value = "";
      if (gEl) gEl.value = "";
      if (minEl) minEl.value = (payload.min ?? "");
      if (maxEl) maxEl.value = (payload.max ?? "");

      if (typeof applyReportsChildren === "function") applyReportsChildren();
      return;
    }

    // 3.1) ุชูุงุฑูุฑ ุงูุฃุทูุงู: ุนูุฑ ูู ููุท (>=)
    if (action === "childrenAgeMin") {
      if (typeof showReports === "function") showReports();

      const minEl = document.getElementById("repChildMinAge");
      const maxEl = document.getElementById("repChildMaxAge");
      const qEl   = document.getElementById("repChildSearch");
      const gEl   = document.getElementById("repChildGender");

      if (qEl) qEl.value = "";
      if (gEl) gEl.value = "";
      if (minEl) minEl.value = (payload.min ?? "");
      if (maxEl) maxEl.value = "";

      if (typeof applyReportsChildren === "function") applyReportsChildren();
      return;
    }

    // 4) ุงูุญูุงูู/ุงููุฑุถุนุงุช
    if (action === "goPregNursing") {
      if (typeof showReports === "function") showReports();

      clickIfExists([
        "#openPregNursingTab",
        "#repPregNursingTab",
        "[data-tab='pregnursing']",
        "[onclick*='showPregNursing']"
      ]);

      const q = String(payload.q || "").trim();
      setIfExists(
        ["#repPregSearch","#repPregNursingSearch","#repPNsearch","#repPregQuery","#repPregnantSearch"],
        q
      );

      setIfExists(["#repPregType","#repPNType","#repPregNursingType"], q);

      if (typeof applyReportsPregNursing === "function") applyReportsPregNursing();
      else if (typeof applyReportsPregnantNursing === "function") applyReportsPregnantNursing();

      return;
    }

    // 5) ุงูุฃูุฑุงุถ
    if (action === "goDiseases") {
      if (typeof showReports === "function") showReports();

      clickIfExists([
        "#openDiseaseTab",
        "#repDiseaseTab",
        "[data-tab='disease']",
        "[onclick*='showDisease']"
      ]);

      const q = String(payload.q || "").trim();
      setIfExists(
        ["#repDiseaseSearch","#repDiseasesSearch","#repDisSearch","#repDiseaseQuery"],
        q
      );

      if (typeof applyReportsDisease === "function") applyReportsDisease();
      else if (typeof applyReportsDiseases === "function") applyReportsDiseases();

      return;
    }

  } catch (e) {
    console.warn("statsGo failed", e);
  }
};


// =========================
// buildCampStats
// =========================
window.buildCampStats = function () {

  const fams = Array.isArray(window.families) ? window.families : [];

  let totalFamilies = fams.length;
  let totalPeople = 0;
  let totalChildren = 0;
  let males = 0;
  let females = 0;

  let pregnantTotal = 0;
  let nursingTotal = 0;
  let diseaseFamilies = 0;

  const socialStats = {};
  const totalCountStats = {};

  let child18Plus = 0;
  let childrenNoAge = 0;

  const childAges = {
    "0-1":0,"1-2":0,"2-3":0,"3-5":0,"5-7":0,
    "7-10":0,"10-13":0,"13-15":0,"15-18":0
  };

  const adultAges = {
    "18-25":0,"25-35":0,"35-45":0,
    "45-55":0,"55-65":0,"65-75":0,"75+":0
  };

  fams.forEach(f => {
    const count = Number(f.totalCount || 0);
    if (Number.isFinite(count) && count > 0) {
      totalPeople += count;
      const key = String(Math.round(count));
      totalCountStats[key] = (totalCountStats[key] || 0) + 1;
    }

    if (f.gender === "ุฐูุฑ") males++;
    if (f.gender === "ุฃูุซู" || f.gender === "ุงูุซู") females++;

    const fa = Number(f.age);
    if (Number.isFinite(fa)) countAdultAge(fa);

    if (String(f.wife || "").trim()) {
      females++;
      const wa = Number(f.wifeAge);
      if (Number.isFinite(wa)) countAdultAge(wa);
    }

    if (Array.isArray(f.children)) {
      totalChildren += f.children.length;

      f.children.forEach(c => {
        const ageVal = getChildAgeYears(c);

        if (ageVal === null) {
          childrenNoAge++;
        } else {
          if (ageVal >= 18) child18Plus++;
          else countChildAge(ageVal);
        }

        if (c?.gender === "ุฐูุฑ") males++;
        if (c?.gender === "ุฃูุซู" || c?.gender === "ุงูุซู") females++;
      });
    }

    const pregStr = String(f.pregnant || "");
    pregnantTotal += extractCount(pregStr, "ุญุงูู");
    nursingTotal  += extractCount(pregStr, "ูุฑุถุนุฉ");

    const dis = String(f.disease || "").trim();
    if (dis && dis !== "ูุง ููุฌุฏ") diseaseFamilies++;

    const st = String(f.socialStatus || "ุบูุฑ ูุญุฏุฏ").trim() || "ุบูุฑ ูุญุฏุฏ";
    socialStats[st] = (socialStats[st] || 0) + 1;
  });

  const totalAdultsApprox = Math.max(0, totalPeople - totalChildren);

setText("statDiseaseFamilies", diseaseFamilies);
  setText("statFamilies", totalFamilies);
  setText("statPeople", totalPeople);
  setText("statChildren", totalChildren);
  setText("statMales", males);
  setText("statFemales", females);
  setText("statPregnant", pregnantTotal);
  setText("statNursing", nursingTotal);

  const details = document.getElementById("statsDetails");
  if (details) {
    details.innerHTML = [
      blockSocial(),
      blockChildren(),
      blockAdults(),
      blockHealth(),
      blockTotalCount()
    ].join("");
  }

  function row(labelHtml, value, actionHtml, extra){
    const cls = extra ? `statsRow ${extra}` : "statsRow";
    return `
      <div class="${cls}">
        <div class="label">${labelHtml}</div>
        <div class="value">${value}</div>
        ${actionHtml ? actionHtml : `<span class="statsBtnPlaceholder"></span>`}
      </div>
    `;
  }

  function btn(onclick){
    return `<button type="button" class="statsBtn" onclick="${onclick}">ูุดุงูุฏุฉ</button>`;
  }

  function block(title, inner){
    return `<div class="statsBlock"><div class="statsBlockTitle">${title}</div>${inner}</div>`;
  }

  function rangeLtr(t){ return `<span dir="ltr">${t}</span>`; }

  function blockSocial(){
    const keys = Object.keys(socialStats);
    const inner = keys.map(k =>
      row(`โข ${k}`, socialStats[k], btn(`statsGo('filterSocial',{value:'${k}'})`))
    ).join("");
    return block("๐ ุงูุญุงูุงุช ุงูุงุฌุชูุงุนูุฉ", inner || row("โ","0",""));
  }

  function blockChildren(){
    let inner = Object.keys(childAges).map(k=>{
      const [a,b] = k.split("-").map(Number);
      return row(`โข ุงูุนูุฑ ${rangeLtr(k)}`, childAges[k],
        btn(`statsGo('childrenAgeRange',{min:${a},max:${b}})`));
    }).join("");

    inner += row(`โข ุงูุนูุฑ ${rangeLtr("+18")}`, child18Plus,
      btn(`statsGo('childrenAgeMin',{min:18})`));

    inner += row(`โข ุฃุทูุงู ุจุฏูู ุนูุฑ`, childrenNoAge, "", "noAgeRow");

    return block("๐ง ุฃุนูุงุฑ ุงูุฃุทูุงู", inner);
  }

  function blockAdults(){
    let inner = row("โข ุนุฏุฏ ุงูุจุงูุบูู (ุชูุฑูุจูุง)", totalAdultsApprox, "");
    inner += Object.keys(adultAges).map(k =>
      row(`โข ุงูุนูุฑ ${rangeLtr(k)}`, adultAges[k], "")
    ).join("");
    return block("๐ง ุฃุนูุงุฑ ุงูุจุงูุบูู", inner);
  }

  function blockHealth(){
    return block("๐ฉบ ุงูุญุงูุงุช ุงูุตุญูุฉ",
      row("๐คฐ ุญูุงูู", pregnantTotal, btn(`statsGo('goPregNursing',{q:'ุญุงูู'})`)) +
      row("๐ผ ูุฑุถุนุงุช", nursingTotal, btn(`statsGo('goPregNursing',{q:'ูุฑุถุนุฉ'})`)) +
      row("๐ฉบ ุฃุณุฑ ูุฏููุง ุฃูุฑุงุถ", diseaseFamilies, btn(`statsGo('goDiseases',{q:''})`))
    );
  }

  function blockTotalCount(){
    const keys = Object.keys(totalCountStats);
    const inner = keys.map(n =>
      row(`โข ${n} ุฃูุฑุงุฏ`, totalCountStats[n],
        btn(`statsGo('filterTotalRange',{min:${n},max:${n}})`))
    ).join("");
    return block("๐ฅ ุงูุฃุณุฑ ุญุณุจ ุงูุนุฏุฏ ุงูููู ููุฃูุฑุงุฏ", inner || row("โ","0",""));
  }

  function setText(id, v){
    const el = document.getElementById(id);
    if (el) el.textContent = String(v ?? "0");
  }

  function extractCount(text, word){
    if (!text.includes(word)) return 0;
    const m = text.match(new RegExp(word + "\\s*\\((\\d+)\\)"));
    return m ? Number(m[1]) : 1;
  }

  function getChildAgeYears(c){
    if (!c) return null;

    const bd = c.dob;
    if (bd) {
      const m = String(bd).match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) {
        const birth = new Date(+m[1], m[2]-1, +m[3]);
        const today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        if (
          today.getMonth() < birth.getMonth() ||
          (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())
        ) age--;
        return age < 0 ? 0 : age;
      }
    }

    if (c.age !== "" && c.age !== null && c.age !== undefined) {
      const n = Number(c.age);
      if (!Number.isNaN(n)) return n;
    }

    return null;
  }

  // ๐ง ุงูุชุนุฏูู ุงููุญูุฏ
  function countChildAge(a){
    if (a <= 1) childAges["0-1"]++;
    else if (a <= 2) childAges["1-2"]++;
    else if (a <= 3) childAges["2-3"]++;
    else if (a <= 5) childAges["3-5"]++;
    else if (a <= 7) childAges["5-7"]++;
    else if (a <= 10) childAges["7-10"]++;
    else if (a <= 13) childAges["10-13"]++;
    else if (a <= 15) childAges["13-15"]++;
    else if (a < 18) childAges["15-18"]++;
  }

  function countAdultAge(a){
    if (a < 18) return;
    if (a < 25) adultAges["18-25"]++;
    else if (a < 35) adultAges["25-35"]++;
    else if (a < 45) adultAges["35-45"]++;
    else if (a < 55) adultAges["45-55"]++;
    else if (a < 65) adultAges["55-65"]++;
    else if (a < 75) adultAges["65-75"]++;
    else adultAges["75+"]++;
  }
};

</script>

</body>
</html>